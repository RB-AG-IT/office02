<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRK Fördermitgliedschaft</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            overflow: hidden;
        }

        .header {
    background: #E30613;
    color: white;
    padding: 20px 30px;
    position: relative;
}

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .drk-logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #e01e26;
            font-size: 20px;
        }

        .werber-info {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .werber-bild {
            width: 60px;
            height: 80px;
            background: white;
            border-radius: 10px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e01e26;
            font-size: 12px;
        }

        .werber-name {
            font-size: 14px;
            opacity: 0.9;
        }

        .verband-name {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .verband-adresse {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-section {
            padding: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-row.spaced {
    margin-bottom: 35px;
}

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
            font-weight: 500;
        }

      input, select, textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.3s;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: white;
}

input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
    min-height: 38px;
}

select {
    background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3e%3cpolyline points="6 9 12 15 18 9"%3e%3c/polyline%3e%3c/svg%3e');
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 16px;
    padding-right: 32px;
}

        /* Custom Checkbox Styling */
input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border: 2px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    background-color: white;
}

input[type="checkbox"]:checked {
    background-color: white;
    border-color: #667eea;
}

input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    color: #667eea;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

        /* Custom Radio Button Styling */
input[type="radio"] {
    width: 18px;
    height: 18px;
    border: 2px solid #ddd;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
}

input[type="radio"]:checked {
    border-color: #667eea;
}

input[type="radio"]:checked::after {
    content: '';
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #667eea;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Custom Radio Styling für NMG/ERH */
input[type="radio"][name="type"] {
    width: 16px;
    height: 16px;
    border: 2px solid #ddd;
    border-radius: 50%;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    background-color: white;
    margin: 0 !important;
    margin-right: 5px !important;
}

input[type="radio"][name="type"]:checked {
    border-color: #667eea;
    background-color: white;
}

input[type="radio"][name="type"]:checked::after {
    content: '';
    position: absolute;
    width: 8px;
    height: 8px;
    background-color: #667eea;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

        
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

        .radio-option label {
            display: inline-block;
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option input[type="radio"]:checked + label {
    background: #667eea;
    color: white;
    border-color: #667eea;
    font-weight: 600;
}

        .amount-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .amount-btn {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
            font-weight: bold;
        }

        .amount-btn:hover {
            border-color: #667eea;
        }

        .amount-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .interval-btn {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .interval-btn:hover {
            border-color: #999;
        }

        .interval-btn.active {
            background: #f0f0f0;
            border-color: #999;
        }

        .preset-option:hover {
            background: #f5f5f5;
        }

        .checkbox-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-top: 3px;
        }

        .checkbox-group label {
            flex: 1;
            margin-bottom: 0;
            font-size: 14px;
        }

        .signature-pad {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            height: 150px;
            position: relative;
            background: white;
        }

        .signature-clear {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .collapsible {
            margin-top: 20px;
        }

        .collapsible-header {
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-content {
            display: none;
            padding: 20px;
            background: #fafafa;
            border-radius: 0 0 8px 8px;
            margin-top: -8px;
        }

        .collapsible-content.show {
            display: block;
        }

        .submit-section {
            padding: 30px;
            background: #f8f8f8;
            text-align: center;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .error {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
        }

        .success {
            color: #00c853;
            font-size: 12px;
            margin-top: 5px;
        }

        .iban-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .iban-valid {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .iban-invalid {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        .hidden {
            display: none !important;
        }

        .search-results {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

       .search-result-item {
    padding: 8px 10px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    min-height: 38px;
    display: flex;
    align-items: center;
}

        .search-result-item:hover {
            background: #f8f8f8;
        }

        .search-result-item strong {
    font-size: 13px;
}

.search-result-item small {
    font-size: 11px;
}

        .footer-text {
            font-size: 12px;
            color: #777;
            text-align: center;
            padding: 20px;
            line-height: 1.5;
        }

        .interval-display {
            text-align: center;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 8px;
            margin: 20px 0;
        }

        .interval-amount {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .interval-period {
            font-size: 16px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 640px) {
            .container {
                border-radius: 0;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .amount-buttons {
                grid-template-columns: 1fr;
            }
            
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Canvas for signature */
        #signatureCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div style="background: white; padding: 15px; border-radius: 12px; display: inline-block;">
    <img src="logo.png" width="200" height="auto" alt="Logo" style="display: block; max-height: 100px; object-fit: contain;">
</div>
                <div class="werber-info">
                    <div class="werber-bild" style="background: white;">Foto</div>
                    <div class="werber-name">Max</div>
                </div>
            </div>
            <div class="verband-name">DRK Kreisverband Musterstadt</div>
            <div class="verband-adresse">Musterstraße 123, 12345 Musterstadt</div>
        </div>
        
        <!-- Gruppenbild -->
        <div style="width: 100%; height: 200px; background: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'900\' height=\'200\' viewBox=\'0 0 900 200\'%3E%3Crect width=\'900\' height=\'200\' fill=\'%23f5f5f5\'/%3E%3Cg fill=\'%23999\'%3E%3Ccircle cx=\'150\' cy=\'80\' r=\'20\'/%3E%3Cpath d=\'M 120 110 Q 150 100 180 110 L 180 160 L 120 160 Z\'/%3E%3Ccircle cx=\'300\' cy=\'80\' r=\'20\'/%3E%3Cpath d=\'M 270 110 Q 300 100 330 110 L 330 160 L 270 160 Z\'/%3E%3Ccircle cx=\'450\' cy=\'80\' r=\'20\'/%3E%3Cpath d=\'M 420 110 Q 450 100 480 110 L 480 160 L 420 160 Z\'/%3E%3Ccircle cx=\'600\' cy=\'80\' r=\'20\'/%3E%3Cpath d=\'M 570 110 Q 600 100 630 110 L 630 160 L 570 160 Z\'/%3E%3Ccircle cx=\'750\' cy=\'80\' r=\'20\'/%3E%3Cpath d=\'M 720 110 Q 750 100 780 110 L 780 160 L 720 160 Z\'/%3E%3C/g%3E%3Ctext x=\'450\' y=\'190\' text-anchor=\'middle\' font-family=\'Arial\' font-size=\'14\' fill=\'%23666\'%3ETeam DRK Musterstadt%3C/text%3E%3C/svg%3E') center center no-repeat; background-size: cover;">
        </div>
        
        <div style="text-align: right; padding: 10px 30px;">
            <span style="font-size: 13px; color: #666; display: inline-flex; align-items: center;">
                <label style="cursor: pointer; display: inline-flex; align-items: center;">
    <input type="radio" name="type" value="NMG" checked style="margin: 0; margin-right: 5px;">
    <span>NMG</span>
</label>
<span style="color: #ccc; margin: 0 8px;">/</span>
<label style="cursor: pointer; display: inline-flex; align-items: center;">
    <input type="radio" name="type" value="ERH" style="margin: 0; margin-right: 5px;">
    <span>ERH</span>
</label>
            </span>
        </div>

        <!-- Form -->
        <form id="membershipForm">
            <!-- Member search bar - appears when ERH is selected -->
            <div id="memberSearchBar" class="hidden" style="text-align: center; padding: 20px 30px; background: #f9f9f9;">
                <input type="text" id="memberSearch" placeholder="Bestandsmitglied suchen..." style="width: 50%; max-width: 400px; padding: 8px 12px; font-size: 14px;">
                <div id="searchResults" class="search-results hidden" style="margin: 10px auto; max-width: 500px;"></div>
            </div>
            
            <!-- ERH specific fields - appear when ERH is selected -->
            <div id="erhFields" class="hidden" style="padding: 20px 30px; background: #f9f9f9; border-bottom: 1px solid #e0e0e0;">
                <div class="form-row">
                    <div>
                        <label>Mitglied seit:</label>
                        <input type="date" id="memberSince" value="2020-01-15" readonly style="background: #f0f0f0;">
                    </div>
                    <div>
                        <label>Buchungsintervall:</label>
                        <input type="text" id="oldInterval" value="Monatlich" readonly style="background: #f0f0f0;">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Alter Monatsbeitrag:</label>
                        <input type="number" id="oldAmount" step="0.01" value="10.00" readonly style="background: #f0f0f0;">
                    </div>
                    <div>
                        <label>Mitgliedsnummer:</label>
                        <input type="text" id="memberNumber" value="M-2020-001" readonly style="background: #f0f0f0;">
                    </div>
                </div>
            </div>

            <!-- Persönliche Daten -->
            <div class="form-section">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <div class="section-title" style="margin-bottom: 0; border-bottom: none; font-size: 16px;">Persönliche Daten</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>Anrede:</label>
                        <select id="salutation" required>
                            <option value="">Wählen</option>
                            <option value="Herr">Herr</option>
                            <option value="Frau">Frau</option>
                            <option value="Divers">Divers</option>
                        </select>
                    </div>
                    <div>
                        <label>Titel:</label>
                        <select id="title">
                            <option value="">Kein</option>
                            <option value="Dr.">Dr.</option>
                            <option value="Prof.">Prof.</option>
                            <option value="Prof. Dr.">Prof. Dr.</option>
                        </select>
                    </div>
                    <div>
                        <label>Firma (optional):</label>
                        <input type="text" id="company">
                    </div>
                </div>

                <div class="form-row spaced">
    <div>
        <label>Vorname:</label>
        <input type="text" id="firstName" required>
    </div>
    <div>
        <label>Nachname:</label>
        <input type="text" id="lastName" required>
    </div>
</div>

                <div class="form-row">
                    <div>
                        <label>Geburtsdatum:</label>
                        <input type="date" id="birthDate" required>
                        <div id="birthDateError" class="error hidden" style="text-align: right;">Mindestalter: 18 Jahre</div>
                    </div>
                    <div>
                        <label>E-Mail:</label>
                        <input type="email" id="email">
                        <div id="emailError" class="error hidden">Bitte geben Sie eine gültige E-Mail-Adresse ein</div>
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Telefon (Mobil):</label>
                        <input type="tel" id="phoneMobile">
                    </div>
                    <div>
                        <label>Telefon (Festnetz):</label>
                        <input type="tel" id="phoneFixed">
                    </div>
                </div>
            </div>

            <!-- Anschrift -->
            <div class="form-section">
                <div class="section-title" style="font-size: 16px;">Anschrift</div>
                
                <div style="display: grid; grid-template-columns: 5fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>Straße:</label>
                        <input type="text" id="street" required placeholder="Beginnen Sie zu tippen für Vorschläge...">
                        <div id="streetSuggestions" class="search-results hidden"></div>
                    </div>
                    <div>
                        <label>Nr.:</label>
                        <input type="text" id="houseNumber" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px;">
                    <div>
                        <label>PLZ:</label>
                        <input type="text" id="zipCode" required maxlength="5">
                    </div>
                    <div>
                        <label>Ort:</label>
                        <input type="text" id="city" required>
                    </div>
                    <div>
                        <label>Land:</label>
                        <select id="country">
                            <option value="Deutschland" selected>Deutschland</option>
                            <option value="Österreich">Österreich</option>
                            <option value="Schweiz">Schweiz</option>
                            <option value="Luxemburg">Luxemburg</option>
                            <option value="Frankreich">Frankreich</option>
                            <option value="Niederlande">Niederlande</option>
                            <option value="Belgien">Belgien</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Zahlungsinformation -->
<div class="form-section" style="margin-top: 60px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div class="section-title" style="margin-bottom: 0; border-bottom: none; font-size: 16px;">Zahlungsinformation</div>
                    <div style="position: relative;">
                        <button type="button" id="paymentMenu" style="background: none; border: none; cursor: pointer; padding: 5px;">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="#999">
                                <circle cx="10" cy="4" r="2"/>
                                <circle cx="10" cy="10" r="2"/>
                                <circle cx="10" cy="16" r="2"/>
                            </svg>
                        </button>
                        <div id="paymentDropdown" class="hidden" style="position: absolute; right: 0; top: 30px; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; min-width: 180px;">
                            <div class="payment-option" style="padding: 8px 15px; cursor: pointer; font-size: 13px;" data-action="iban-later">
                                <span id="ibanLaterCheck" style="display: none;">✓ </span>IBAN selbst ausfüllen
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div>
                        <label>Kontoinhaber:</label>
                        <input type="text" id="accountHolder">
                    </div>
                    <div>
                        <label>Bank:</label>
<input type="text" id="bankName" placeholder="Wird automatisch ausgefüllt">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label id="ibanLabel">IBAN:</label>
                        <input type="text" id="iban" placeholder="DE00 0000 0000 0000 0000 00">
                        <div id="ibanStatus" style="text-align: right; font-size: 11px; margin-top: 3px;"></div>
                    </div>
                    <div>
                       <label>BIC:</label>
<input type="text" id="bic" placeholder="Wird automatisch ausgefüllt">

                    </div>
                </div>
            </div>

            <!-- Unterstützungsbeitrag -->
            <div class="form-section" style="margin-top: 150px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: baseline;">
                        <div class="section-title" style="margin-bottom: 0; border-bottom: none; font-size: 16px; margin-right: 15px;">Unterstützungsbeitrag</div>
                        <span id="yearlyDisplay" style="font-size: 12px; color: #666; border: 1px solid #e0e0e0; padding: 2px 8px; border-radius: 3px;">0 EUR / Jahr</span>
                    </div>
                    <div style="position: relative;">
                        <button type="button" id="presetMenu" style="background: none; border: none; cursor: pointer; padding: 5px;">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="#999">
                                <circle cx="10" cy="4" r="2"/>
                                <circle cx="10" cy="10" r="2"/>
                                <circle cx="10" cy="16" r="2"/>
                            </svg>
                        </button>
<div id="presetDropdown" class="hidden" style="position: absolute; right: 0; bottom: 30px; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 5px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; min-width: 150px;">
                            <div class="preset-option" style="padding: 8px 15px; cursor: pointer; font-size: 13px;" data-preset="standard">Standard (5/10/15)</div>
                            <div class="preset-option" style="padding: 8px 15px; cursor: pointer; font-size: 13px;" data-preset="individual">Individuell</div>
                        </div>
                    </div>
                </div>
                
                <div id="standardAmounts" style="margin-top: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px;">
                        <button type="button" class="amount-btn" data-amount="5" style="height: 85px; font-size: 24px; font-weight: bold;">5 €</button>
                        <button type="button" class="amount-btn" data-amount="10" style="height: 85px; font-size: 24px; font-weight: bold;">10 €</button>
                        <button type="button" class="amount-btn" data-amount="15" style="height: 85px; font-size: 24px; font-weight: bold;">15 €</button>
                    </div>
                </div>

                <div id="individualAmount" class="hidden" style="margin-top: 30px;">
                    <input type="number" id="customAmount" placeholder="Betrag in Euro eingeben" step="0.01" min="5" style="width: 100%;">
                </div>

                <div style="display: flex; justify-content: center; margin-top: 50px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 140px); gap: 15px;">
                        <button type="button" class="interval-btn active" data-interval="monthly">Monatlich</button>
                        <button type="button" class="interval-btn" data-interval="quarterly">Vierteljährlich</button>
                        <button type="button" class="interval-btn" data-interval="halfyearly">Halbjährlich</button>
                        <button type="button" class="interval-btn" data-interval="yearly">Jährlich</button>
                    </div>
                </div>
            </div>

            <!-- Spendenquittung -->
            <div class="form-section">
                <div class="checkbox-group">
                    <input type="checkbox" id="spendenquittung">
                    <label for="spendenquittung">Ich benötige eine Spendenquittung</label>
                </div>
            </div>

            <!-- Rechtliche Hinweise -->
            <div class="form-section">
                <div class="section-title">Rechtliche Hinweise</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="consent1" required>
                    <label for="consent1">Dies ist keine einmalige Spende.</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="consent2" required>
                    <label for="consent2">Ich werde Fördermitglied beim DRK.</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="consent3" required>
                    <label for="consent3">Die Mitgliedschaft ist jederzeit formlos anpassbar und beendbar.</label>
                </div>

                <div style="margin-top: 30px;">
                    <label style="font-size: 12px; color: #777;">Kontakt erlauben (optional):</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="contactEmail" checked>
                            <label for="contactEmail">E-Mail</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="contactPhone" checked>
                            <label for="contactPhone">Telefon</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unterschrift -->
            <div class="form-section">
                <div class="section-title" style="font-size: 16px;">Unterschrift</div>
                <div class="signature-pad" style="height: 200px;">
                    <canvas id="signatureCanvas"></canvas>
                    <button type="button" class="signature-clear" id="clearSignature">Löschen</button>
                </div>
            </div>

            <!-- Submit und Weitere Optionen -->
            <div class="form-section" style="text-align: center;">
                <button type="button" class="submit-btn" id="validateBtn" style="background: #4caf50; border-radius: 8px; margin-bottom: 15px; padding: 20px 50px; font-size: 20px;">Jetzt überprüfen</button>
                
                <div class="collapsible" style="margin-top: 40px;">
                    <div class="collapsible-header" style="padding: 10px; font-size: 13px; background: #fafafa;">
                        <span>Weitere Optionen</span>
                        <span>▼</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label>Späteres Beitrittsdatum (optional):</label>
                            <input type="date" id="laterStartDate">
                            <div class="error" style="margin-top: 5px;">Max. 3 Monate in der Zukunft</div>
                        </div>
                        <div class="form-group">
                            <label>Anmerkungen (für den DRK Verband):</label>
                            <textarea id="notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer-text">
                Mit dem Absenden wird bestätigt, dass die DSGVO-konforme 
                <a href="#" style="color: #667eea;">Datenschutzerklärung</a> 
                des DRK Kreisverband Musterstadt zur Kenntnis genommen und akzeptiert wurde.
            </div>
        </form>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ================================================================
        // SUPABASE CONFIGURATION
        // ================================================================
        const SUPABASE_URL = 'https://lgztglycqtiwcmiydxnm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzgwNzYxNSwiZXhwIjoyMDc5MzgzNjE1fQ.54kSk9ZSUdQt6LKYWkblqgR6Sjev80W80qkNHYEbPgk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ================================================================
        // URL PARAMETER HANDLING
        // ================================================================
        const urlParams = new URLSearchParams(window.location.search);
        const formContext = {
            campaign_id: urlParams.get('kampagne') || urlParams.get('campaign'),
            campaign_area_id: urlParams.get('werbegebiet') || urlParams.get('wg') || urlParams.get('area'),
            botschafter_id: urlParams.get('botschafter') || urlParams.get('werber'),
            teamchef_id: null,
            quality_id: null,
            customer_id: null,
            kw: null,
            year: null
        };

        // Aktuelle KW und Jahr berechnen
        function getCurrentKW() {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + startOfYear.getDay() + 1) / 7);
        }

        formContext.kw = parseInt(urlParams.get('kw')) || getCurrentKW();
        formContext.year = parseInt(urlParams.get('year')) || new Date().getFullYear();

        // Kontext laden (Teamchef, Quality, Customer aus Kampagne/Area)
        async function loadFormContext() {
            if (!formContext.campaign_id || !formContext.campaign_area_id) {
                console.warn('Keine Kampagne oder Werbegebiet in URL');
                return;
            }

            try {
                // Assignment für aktuelle KW laden (Teamchef, Quality)
                const { data: assignment } = await supabaseClient
                    .from('campaign_assignments')
                    .select('teamchef_id, quality_manager_id')
                    .eq('campaign_id', formContext.campaign_id)
                    .eq('kw', formContext.kw)
                    .single();

                if (assignment) {
                    formContext.teamchef_id = assignment.teamchef_id;
                    formContext.quality_id = assignment.quality_manager_id;
                }

                // Campaign Area laden (für Customer)
                const { data: area } = await supabaseClient
                    .from('campaign_areas')
                    .select('*, campaigns(customer_id)')
                    .eq('id', formContext.campaign_area_id)
                    .single();

                if (area) {
                    formContext.customer_id = area.campaigns?.customer_id;
                }

                console.log('Form context loaded:', formContext);

            } catch (error) {
                console.error('Fehler beim Laden des Kontexts:', error);
            }
        }

        // Kontext beim Laden initialisieren
        loadFormContext();

        // ================================================================
        // EXISTING CODE
        // ================================================================

        // Simulated member data for search
        const existingMembers = [
            { id: 1, name: 'Schmidt, Hans', street: 'Hauptstraße 12', zipCode: '12345', city: 'Musterstadt', memberNumber: 'M001', memberSince: '2020-01-15', amount: 10, iban: 'DE89370400440532013000', accountHolder: 'Hans Schmidt', bank: 'Sparkasse Musterstadt', bic: 'SPKADE2HXXX' },
            { id: 2, name: 'Müller, Anna', street: 'Bahnhofstraße 5', zipCode: '12345', city: 'Musterstadt', memberNumber: 'M002', memberSince: '2019-06-20', amount: 15, iban: 'DE12500105170648489890', accountHolder: 'Anna Müller', bank: 'Sparkasse Musterstadt', bic: 'SPKADE2HXXX' },
            { id: 3, name: 'Weber, Thomas', street: 'Gartenweg 8', zipCode: '12346', city: 'Musterstadt', memberNumber: 'M003', memberSince: '2021-03-10', amount: 20, iban: 'DE87123456780987654321', accountHolder: 'Thomas Weber', bank: 'Volksbank Musterstadt', bic: 'VBKADE2HXXX' }
        ];

        // Global variable to track selected member for ERH
        let selectedMember = null;
        let isERHMode = false;

        function searchMembers(query) {
            const results = document.getElementById('searchResults');
            
            if (query.length < 2) {
                results.classList.add('hidden');
                return;
            }

            const filtered = existingMembers.filter(member => 
                member.name.toLowerCase().includes(query.toLowerCase()) ||
                member.street.toLowerCase().includes(query.toLowerCase())
            );

            if (filtered.length === 0) {
                results.classList.add('hidden');
                return;
            }

            results.innerHTML = '';
            filtered.slice(0, 5).forEach(member => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <strong>${member.name}</strong><br>
                    <small>${member.street}, ${member.zipCode} ${member.city}</small><br>
                    <small>Mitgliedsnr: ${member.memberNumber} | Beitrag: ${member.amount} €</small>
                `;
                item.onclick = () => selectMember(member);
                results.appendChild(item);
            });

            results.classList.remove('hidden');
        }

        function selectMember(member) {
            // Store selected member globally
            selectedMember = member;
            
            // Auto-fill form fields
            const [lastName, firstName] = member.name.split(', ');
            document.getElementById('firstName').value = firstName;
            document.getElementById('lastName').value = lastName;
            document.getElementById('street').value = member.street.replace(/\d+$/, '').trim();
            document.getElementById('houseNumber').value = member.street.match(/\d+$/)[0];
            document.getElementById('zipCode').value = member.zipCode;
            document.getElementById('city').value = member.city;
            document.getElementById('memberNumber').value = member.memberNumber;
            document.getElementById('memberSince').value = member.memberSince;
            document.getElementById('oldAmount').value = member.amount;
            document.getElementById('oldInterval').value = 'Monatlich';
            
            // Fill payment information
            document.getElementById('accountHolder').value = member.accountHolder;
            document.getElementById('bankName').value = member.bank;
            document.getElementById('bic').value = member.bic;
            
            // Configure IBAN field for ERH verification mode
            const ibanField = document.getElementById('iban');
            const ibanLabel = document.getElementById('ibanLabel');
            if (ibanField) {
                ibanField.value = '';
                ibanField.placeholder = 'Letzte 4 Ziffern zur Verifizierung';
                ibanField.maxLength = 4;
            }
            if (ibanLabel) {
                ibanLabel.textContent = 'IBAN - Letzte 4 Ziffern zur Verifizierung:';
            }
            
            // Hide search results
            const searchResults = document.getElementById('searchResults');
            const memberSearch = document.getElementById('memberSearch');
            
            if (searchResults) {
                searchResults.classList.add('hidden');
            }
            if (memberSearch) {
                memberSearch.value = '';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
            initializeSignaturePad();
        });

        function initializeForm() {
            // Set max date for later start date (3 months from now)
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 3);
            document.getElementById('laterStartDate').max = maxDate.toISOString().split('T')[0];
            
            // Set min date for birth date
            const minBirthDate = new Date();
            minBirthDate.setFullYear(minBirthDate.getFullYear() - 120);
            document.getElementById('birthDate').min = minBirthDate.toISOString().split('T')[0];
            document.getElementById('birthDate').max = new Date().toISOString().split('T')[0];
        }

        function setupEventListeners() {
            // Member type toggle mit Feldlöschung
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const erhFields = document.getElementById('erhFields');
                    const searchBar = document.getElementById('memberSearchBar');
                    const ibanField = document.getElementById('iban');
                    const ibanLabel = document.getElementById('ibanLabel');
                    
                    if (this.value === 'ERH') {
                        isERHMode = true;
                        erhFields.classList.remove('hidden');
                        searchBar.classList.remove('hidden');
                    } else {
                        isERHMode = false;
                        selectedMember = null;
                        erhFields.classList.add('hidden');
                        searchBar.classList.add('hidden');
                        
                        // Reset IBAN field to NMG mode
                        ibanField.value = '';
                        ibanField.placeholder = 'DE00 0000 0000 0000 0000 00';
                        ibanField.removeAttribute('maxLength');
                        ibanLabel.textContent = 'IBAN:';
                        
                        // Clear all fields when switching to NMG
                        document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="date"], input[type="number"]').forEach(input => {
                            if (input.id !== 'country') input.value = '';
                        });
                        document.querySelectorAll('select').forEach(select => {
                            if (select.id !== 'country') select.selectedIndex = 0;
                        });
                    }
                });
            });

            // Member search
            document.getElementById('memberSearch').addEventListener('input', function() {
                searchMembers(this.value);
            });

            // Auto-fill Kontoinhaber from name
            document.getElementById('firstName').addEventListener('input', updateAccountHolder);
            document.getElementById('lastName').addEventListener('input', updateAccountHolder);

            function updateAccountHolder() {
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                document.getElementById('accountHolder').value = `${firstName} ${lastName}`.trim();
            }

            // Payment menu
            document.getElementById('paymentMenu').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('paymentDropdown').classList.toggle('hidden');
            });

            // IBAN selbst ausfüllen option
            document.querySelector('[data-action="iban-later"]').addEventListener('click', function() {
                const ibanField = document.getElementById('iban');
                const checkMark = document.getElementById('ibanLaterCheck');
                
                if (checkMark.style.display === 'none') {
                    checkMark.style.display = 'inline';
                    ibanField.value = '';
                    ibanField.placeholder = 'IBAN per Mail nachtragen';
                    ibanField.disabled = true;
                    ibanField.style.background = '#f9f9f9';
                    ibanField.removeAttribute('required');
                } else {
                    checkMark.style.display = 'none';
                    ibanField.placeholder = 'DE00 0000 0000 0000 0000 00';
                    ibanField.disabled = false;
                    ibanField.style.background = 'white';
                    ibanField.setAttribute('required', 'required');
                }
                
                document.getElementById('paymentDropdown').classList.add('hidden');
            });

            // Preset menu
            document.getElementById('presetMenu').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('presetDropdown').classList.toggle('hidden');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.getElementById('presetDropdown').classList.add('hidden');
                document.getElementById('paymentDropdown').classList.add('hidden');
            });

            // Preset options - ANGEPASST
            document.querySelectorAll('.preset-option').forEach(option => {
                option.addEventListener('click', function() {
                    const preset = this.dataset.preset;
                    
                    if (preset === 'individual') {
                        // Wechsel zu individuell: Standard-Buttons ausblenden und deaktivieren
                        document.getElementById('standardAmounts').classList.add('hidden');
                        document.getElementById('individualAmount').classList.remove('hidden');
                        
                        // Alle Standard-Buttons deaktivieren
                        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
                        
                        // Individuelles Feld leeren
                        document.getElementById('customAmount').value = '';
                        
                        // Anzeige aktualisieren (zeigt 0 EUR/Jahr)
                        updateAmountDisplay();
                    } else if (preset === 'standard') {
                        // Wechsel zu Standard: Individuell ausblenden
                        document.getElementById('standardAmounts').classList.remove('hidden');
                        document.getElementById('individualAmount').classList.add('hidden');
                        
                        // Individuelles Feld leeren
                        document.getElementById('customAmount').value = '';
                        
                        // Alle Standard-Buttons deaktivieren
                        document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
                        
                        // Anzeige aktualisieren (zeigt 0 EUR/Jahr bis ein Button gewählt wird)
                        updateAmountDisplay();
                    }
                    
                    document.getElementById('presetDropdown').classList.add('hidden');
                });
            });

            // Email validation
            document.getElementById('email').addEventListener('blur', validateEmail);

            // Birth date validation
            document.getElementById('birthDate').addEventListener('blur', validateBirthDate);
            document.getElementById('birthDate').addEventListener('change', validateBirthDate);

            // Later start date validation
            document.getElementById('laterStartDate').addEventListener('blur', validateLaterStartDate);
            document.getElementById('laterStartDate').addEventListener('change', validateLaterStartDate);

            // IBAN validation with auto bank/BIC
            document.getElementById('iban').addEventListener('input', function() {
                validateIBAN(this.value);
            });

            // Amount buttons
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateAmountDisplay();
                });
            });

            // Custom amount
            document.getElementById('customAmount').addEventListener('input', updateAmountDisplay);

            // Interval buttons
            document.querySelectorAll('.interval-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateAmountDisplay();
                });
            });

            // Initial amount display update
            updateAmountDisplay();

            // Collapsible sections
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    content.classList.toggle('show');
                    const arrow = this.querySelector('span:last-child');
                    arrow.textContent = content.classList.contains('show') ? '▲' : '▼';
                });
            });

             // Street address autocomplete
   document.getElementById('street').addEventListener('input', function() {
       searchStreetAddress(this.value);
   });

            // Validate button
            document.getElementById('validateBtn').addEventListener('click', validateForm);
        }

        function validateEmail() {
            const email = document.getElementById('email');
            const error = document.getElementById('emailError');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email.value && !emailRegex.test(email.value)) {
                error.classList.remove('hidden');
                email.style.borderColor = '#ff4444';
                return false;
            } else {
                error.classList.add('hidden');
                email.style.borderColor = '#e0e0e0';
                return true;
            }
        }

        function validateBirthDate() {
            const birthDate = document.getElementById('birthDate');
            const error = document.getElementById('birthDateError');
            
            if (!birthDate.value) {
                error.classList.add('hidden');
                birthDate.style.borderColor = '#ddd';
                return false;
            }
            
            const today = new Date();
            const birth = new Date(birthDate.value);
            
            // Calculate age
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            // Adjust age if birthday hasn't occurred this year yet
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            if (age < 18) {
                error.classList.remove('hidden');
                birthDate.style.borderColor = '#ff4444';
                return false;
            } else {
                error.classList.add('hidden');
                birthDate.style.borderColor = '#e0e0e0';
                return true;
            }
        }

        function validateLaterStartDate() {
            const laterStartDate = document.getElementById('laterStartDate');
            
            // If no date is entered, it's valid (optional field)
            if (!laterStartDate.value) {
                laterStartDate.style.borderColor = '#ddd';
                return true;
            }
            
            const selectedDate = new Date(laterStartDate.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            // Calculate max date (3 months from now)
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 3);
            maxDate.setHours(0, 0, 0, 0);
            
            // Check if date is in the past
            if (selectedDate < today) {
                laterStartDate.style.borderColor = '#ff4444';
                return false;
            }
            
            // Check if date is more than 3 months in the future
            if (selectedDate > maxDate) {
                laterStartDate.style.borderColor = '#ff4444';
                return false;
            }
            
            laterStartDate.style.borderColor = '#e0e0e0';
            return true;
        }

        function validateIBAN(iban) {
    const status = document.getElementById('ibanStatus');
    const bankField = document.getElementById('bankName');
    const bicField = document.getElementById('bic');
    const ibanField = document.getElementById('iban');
    
    // ERH Mode: Verify last 4 digits
    if (isERHMode && selectedMember) {
        const cleanInput = iban.replace(/\s/g, '');
        
        if (cleanInput.length === 0) {
            status.innerHTML = '';
            ibanField.style.borderColor = '#ddd';
            return;
        }
        
        if (cleanInput.length !== 4 || !/^\d{4}$/.test(cleanInput)) {
            status.innerHTML = '<span style="color: #ff4444;">✗ 4 Ziffern erforderlich</span>';
            ibanField.style.borderColor = '#ff4444';
            return;
        }
        
        // Check if last 4 digits match
        const storedIbanLast4 = selectedMember.iban.slice(-4);
        if (cleanInput === storedIbanLast4) {
            status.innerHTML = '<span style="color: #4caf50;">✓ korrekt</span>';
            ibanField.style.borderColor = '#4caf50';
        } else {
            status.innerHTML = '<span style="color: #ff4444;">✗ falsch</span>';
            ibanField.style.borderColor = '#ff4444';
        }
        return;
    }
    
    // NMG Mode: Full IBAN validation
    // Convert to uppercase and format with spaces
    let upperIBAN = iban.toUpperCase();
    const cleanIBAN = upperIBAN.replace(/\s/g, '');
    
    // Format with spaces every 4 characters
    if (cleanIBAN.length > 0) {
        const formatted = cleanIBAN.match(/.{1,4}/g)?.join(' ') || cleanIBAN;
        if (iban !== formatted) {
            ibanField.value = formatted;
            setTimeout(() => {
                ibanField.setSelectionRange(formatted.length, formatted.length);
            }, 0);
        }
    }
    
    if (cleanIBAN.length === 0) {
        status.innerHTML = '';
        ibanField.style.borderColor = '#ddd';
        bankField.value = '';
        bicField.value = '';
        return;
    }

    // Only validate when minimum length reached (at least 15 characters)
    if (cleanIBAN.length < 15) {
        status.innerHTML = '';
        ibanField.style.borderColor = '#ddd';
        return;
    }

    // ECHTE IBAN Validierung mit MOD-97
    if (isValidIBAN(cleanIBAN)) {
        status.innerHTML = '<span style="color: #4caf50;">✓ gültige IBAN</span>';
        ibanField.style.borderColor = '#4caf50';
        
        // API Call für Bank-Lookup
        lookupBankFromIBAN(cleanIBAN, bankField, bicField, status);
    } else {
        status.innerHTML = '<span style="color: #ff4444;">✗ ungültige IBAN</span>';
        ibanField.style.borderColor = '#ff4444';
        bankField.value = '';
        bicField.value = '';
    }
}

// IBAN Validierungs-Algorithmus (MOD-97)
function isValidIBAN(iban) {
    iban = iban.replace(/\s/g, '').toUpperCase();
    
    if (!/^[A-Z]{2}[0-9]{2}[A-Z0-9]+$/.test(iban)) {
        return false;
    }
    
    const lengths = {
        'AD': 24, 'AE': 23, 'AL': 28, 'AT': 20, 'AZ': 28, 'BA': 20, 'BE': 16,
        'BG': 22, 'BH': 22, 'BR': 29, 'BY': 28, 'CH': 21, 'CR': 22, 'CY': 28,
        'CZ': 24, 'DE': 22, 'DK': 18, 'DO': 28, 'EE': 20, 'EG': 29, 'ES': 24,
        'FI': 18, 'FO': 18, 'FR': 27, 'GB': 22, 'GE': 22, 'GI': 23, 'GL': 18,
        'GR': 27, 'GT': 28, 'HR': 21, 'HU': 28, 'IE': 22, 'IL': 23, 'IS': 26,
        'IT': 27, 'JO': 30, 'KW': 30, 'KZ': 20, 'LB': 28, 'LC': 32, 'LI': 21,
        'LT': 20, 'LU': 20, 'LV': 21, 'MC': 27, 'MD': 24, 'ME': 22, 'MK': 19,
        'MR': 27, 'MT': 31, 'MU': 30, 'NL': 18, 'NO': 15, 'PK': 24, 'PL': 28,
        'PS': 29, 'PT': 25, 'QA': 29, 'RO': 24, 'RS': 22, 'SA': 24, 'SE': 24,
        'SI': 19, 'SK': 24, 'SM': 27, 'TN': 24, 'TR': 26, 'UA': 29, 'VA': 22,
        'VG': 24, 'XK': 20
    };
    
    const countryCode = iban.substring(0, 2);
    const expectedLength = lengths[countryCode];
    
    if (!expectedLength || iban.length !== expectedLength) {
        return false;
    }
    
    const rearranged = iban.substring(4) + iban.substring(0, 4);
    
    let numericString = '';
    for (let char of rearranged) {
        if (/[A-Z]/.test(char)) {
            numericString += (char.charCodeAt(0) - 55).toString();
        } else {
            numericString += char;
        }
    }
    
    let remainder = numericString;
    while (remainder.length > 2) {
        const block = remainder.substring(0, 9);
        remainder = (parseInt(block, 10) % 97).toString() + remainder.substring(block.length);
    }
    
    return parseInt(remainder, 10) % 97 === 1;
}

// Bank Lookup via Supabase Edge Function
async function lookupBankFromIBAN(iban, bankField, bicField, statusField) {
    try {
        const response = await fetch(`https://lgztglycqtiwcmiydxnm.supabase.co/functions/v1/iban-validate?iban=${encodeURIComponent(iban)}`, {
            headers: {
                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDc2MTUsImV4cCI6MjA3OTM4MzYxNX0.a_ZeubRokmhdevV3JinTiD1Ji92C4bDHSiiDcYGZnt0',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDc2MTUsImV4cCI6MjA3OTM4MzYxNX0.a_ZeubRokmhdevV3JinTiD1Ji92C4bDHSiiDcYGZnt0'
            }
        });
        const data = await response.json();
        
        if (data.valid && data.bankData) {
            bankField.value = data.bankData.name || '';
            bicField.value = data.bankData.bic || '';
            
            // Erfolgs-Styling
            bankField.style.borderColor = '#4caf50';
            bicField.style.borderColor = '#4caf50';
        } else {
            // API hat keine Bank-Daten gefunden
            showManualFillMessage(statusField);
            bankField.style.borderColor = '#ddd';
            bicField.style.borderColor = '#ddd';
        }
    } catch (error) {
        // Kein Internet oder API-Fehler
        console.log('Bank-Lookup Fehler:', error);
        showManualFillMessage(statusField);
        bankField.style.borderColor = '#ddd';
        bicField.style.borderColor = '#ddd';
    }
}

// Zeige "Bitte manuell ausfüllen" Nachricht unter Bank und BIC Feldern
function showManualFillMessage(statusField) {
    // Entferne alte Meldungen falls vorhanden
    const oldMessages = document.querySelectorAll('.manual-fill-message');
    oldMessages.forEach(msg => msg.remove());
    
    // Bank-Feld: Placeholder entfernen + Nachricht
    const bankField = document.getElementById('bankName');
    bankField.placeholder = '';
    const bankMessage = document.createElement('div');
    bankMessage.className = 'manual-fill-message';
    bankMessage.style.cssText = 'color: #ff9800; font-size: 10px; text-align: right; margin-top: 3px;';
    bankMessage.textContent = 'Bitte manuell ausfüllen';
    bankField.parentElement.appendChild(bankMessage);
    
    // BIC-Feld: Placeholder entfernen + Nachricht
    const bicField = document.getElementById('bic');
    bicField.placeholder = '';
    const bicMessage = document.createElement('div');
    bicMessage.className = 'manual-fill-message';
    bicMessage.style.cssText = 'color: #ff9800; font-size: 10px; text-align: right; margin-top: 3px;';
    bicMessage.textContent = 'Bitte manuell ausfüllen';
    bicField.parentElement.appendChild(bicMessage);
}

        function updateAmountDisplay() {
            const activeAmount = document.querySelector('.amount-btn.active');
            const customAmount = document.getElementById('customAmount');
            const individualAmount = document.getElementById('individualAmount');
            const yearlyDisplay = document.getElementById('yearlyDisplay');
            
            const activeInterval = document.querySelector('.interval-btn.active');
            const interval = activeInterval ? activeInterval.dataset.interval : 'monthly';
            
            // Intervall-Multiplikatoren für Jahresberechnung
            const intervalToYearMultipliers = {
                'monthly': 12,      // 12 Zahlungen pro Jahr
                'quarterly': 4,     // 4 Zahlungen pro Jahr
                'halfyearly': 2,    // 2 Zahlungen pro Jahr
                'yearly': 1         // 1 Zahlung pro Jahr
            };
            
            let yearlyAmount = 0;
            
            if (!individualAmount.classList.contains('hidden')) {
                // Individuell-Modus: Der eingegebene Betrag ist der Betrag PRO INTERVALL
                const amountPerInterval = parseFloat(customAmount.value) || 0;
                yearlyAmount = amountPerInterval * intervalToYearMultipliers[interval];
            } else if (activeAmount) {
                // Standard-Modus: Buttons zeigen Monatsbetrag, berechne Jahresbetrag
                const monthlyAmount = parseFloat(activeAmount.dataset.amount);
                yearlyAmount = monthlyAmount * 12;
            }
            
            yearlyDisplay.textContent = `${yearlyAmount.toFixed(0)} EUR / Jahr`;
            
            // Update button text with calculated amounts for the selected interval
            const intervalMultipliers = {
                'monthly': 1,
                'quarterly': 3,
                'halfyearly': 6,
                'yearly': 12
            };
            
            const multiplier = intervalMultipliers[interval];
            
            document.querySelectorAll('.amount-btn').forEach(btn => {
                const baseMonthlyAmount = parseFloat(btn.dataset.amount);
                const displayAmount = baseMonthlyAmount * multiplier;
                btn.innerHTML = `<span style="font-size: 24px; font-weight: bold;">${displayAmount} €</span>`;
            });
        }

    // Debounce timer und AbortController für API calls
let autocompleteTimer = null;
let autocompleteController = null;

async function searchStreetAddress(query) {
    const suggestions = document.getElementById('streetSuggestions');
    
    if (query.length < 3) {
        suggestions.classList.add('hidden');
        return;
    }

    // Clear previous timer
    if (autocompleteTimer) {
        clearTimeout(autocompleteTimer);
    }

    // Cancel previous API request
    if (autocompleteController) {
        autocompleteController.abort();
    }

    // Debounce API call (warte 300ms nach letzter Eingabe)
    autocompleteTimer = setTimeout(async () => {
        try {
            // Create new AbortController for this request
            autocompleteController = new AbortController();
            
            const url = `https://lgztglycqtiwcmiydxnm.supabase.co/functions/v1/address-search?query=${encodeURIComponent(query)}`;
            
            const response = await fetch(url, {
                signal: autocompleteController.signal,
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDc2MTUsImV4cCI6MjA3OTM4MzYxNX0.a_ZeubRokmhdevV3JinTiD1Ji92C4bDHSiiDcYGZnt0',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDc2MTUsImV4cCI6MjA3OTM4MzYxNX0.a_ZeubRokmhdevV3JinTiD1Ji92C4bDHSiiDcYGZnt0'
                }
            });
            const data = await response.json();
            
            if (!data.results || data.results.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }

           // Filter: Nur Ergebnisse MIT Straße
const streetResults = data.results.filter(result => {
    return result.street && result.street.trim() !== '';
});
            
            if (streetResults.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }

            suggestions.innerHTML = '';
            
            streetResults.slice(0, 5).forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                // Format: Straße Hausnummer, PLZ Ort
                const street = result.street || '';
                const houseNumber = result.housenumber || '';
                const postcode = result.postcode || '';
                const city = result.city || '';
                
                item.innerHTML = `
                    <strong style="font-size: 13px;">${street} ${houseNumber}</strong>
                    <span style="font-size: 11px; color: #666; margin-left: 8px;">${postcode} ${city}</span>
                `;
                
                item.onclick = () => {
                    // Auto-fill form fields
                    document.getElementById('street').value = street;
                    document.getElementById('houseNumber').value = houseNumber;
                    document.getElementById('zipCode').value = postcode;
                    document.getElementById('city').value = city;
                    suggestions.classList.add('hidden');
                };
                
                suggestions.appendChild(item);
            });

            suggestions.classList.remove('hidden');
            
        } catch (error) {
            // Ignore AbortError (das ist normal wenn wir die Anfrage abbrechen)
            if (error.name === 'AbortError') {
                return;
            }
            console.error('Adresssuche Fehler:', error);
            suggestions.classList.add('hidden');
        }
    }, 300); // 300ms debounce
}


        
        function initializeSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            let isDrawing = false;

            // Set canvas size
            function resizeCanvas() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Drawing functions
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            function stopDrawing() {
                isDrawing = false;
            }

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', stopDrawing);

            // Clear button
            document.getElementById('clearSignature').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }

        function validateForm() {
            const required = ['salutation', 'firstName', 'lastName', 'birthDate', 
                             'street', 'houseNumber', 'zipCode', 'city'];
            
            let isValid = true;
            let firstError = null;

            // Check required fields
            required.forEach(id => {
                const field = document.getElementById(id);
                if (!field.value) {
                    field.style.borderColor = '#ff4444';
                    isValid = false;
                    if (!firstError) firstError = field;
                } else {
                    field.style.borderColor = '#e0e0e0';
                }
            });

            // Validate birth date (18+ check)
            if (!validateBirthDate()) {
                isValid = false;
                if (!firstError) firstError = document.getElementById('birthDate');
            }

            // Validate later start date (max 3 months in future)
            if (!validateLaterStartDate()) {
                isValid = false;
                if (!firstError) firstError = document.getElementById('laterStartDate');
            }

            // Check if "IBAN selbst ausfüllen" is active
            const ibanLaterActive = document.getElementById('ibanLaterCheck').style.display !== 'none';
            
            // Payment field validation depends on mode (NMG vs ERH)
            if (!ibanLaterActive) {
                // Always check Kontoinhaber (both NMG and ERH)
                const accountHolder = document.getElementById('accountHolder');
                if (!accountHolder.value) {
                    accountHolder.style.borderColor = '#ff4444';
                    isValid = false;
                    if (!firstError) firstError = accountHolder;
                } else {
                    accountHolder.style.borderColor = '#e0e0e0';
                }
                
                if (isERHMode && selectedMember) {
                    // ERH Mode: Only validate last 4 digits of IBAN
                    const ibanInput = document.getElementById('iban').value.replace(/\s/g, '');
                    const storedIbanLast4 = selectedMember.iban.slice(-4);
                    
                    if (!ibanInput || ibanInput.length !== 4) {
                        document.getElementById('iban').style.borderColor = '#ff4444';
                        isValid = false;
                        if (!firstError) firstError = document.getElementById('iban');
                    } else if (ibanInput !== storedIbanLast4) {
                        document.getElementById('iban').style.borderColor = '#ff4444';
                        alert('❌ Die eingegebenen IBAN-Ziffern stimmen nicht überein.');
                        isValid = false;
                        if (!firstError) firstError = document.getElementById('iban');
                    } else {
                        document.getElementById('iban').style.borderColor = '#e0e0e0';
                    }
                    
                    // Bank and BIC are pre-filled in ERH, not validated as required
                } else {
                    // NMG Mode: Validate full payment fields
                    const paymentFields = ['iban', 'bankName', 'bic'];
                    paymentFields.forEach(id => {
                        const field = document.getElementById(id);
                        if (!field.value) {
                            field.style.borderColor = '#ff4444';
                            isValid = false;
                            if (!firstError) firstError = field;
                        } else {
                            field.style.borderColor = '#e0e0e0';
                        }
                    });

                    // Extra IBAN validation (length check) for NMG
                    const iban = document.getElementById('iban').value.replace(/\s/g, '');
                    if (iban && iban.length !== 22) {
                        document.getElementById('iban').style.borderColor = '#ff4444';
                        isValid = false;
                    }
                }
            }

            // Check amount/interval selection
            const individualAmount = document.getElementById('individualAmount');
            const activeAmount = document.querySelector('.amount-btn.active');
            const customAmount = document.getElementById('customAmount').value;
            
            if (individualAmount.classList.contains('hidden')) {
                // Standard mode: check if any button is selected
                if (!activeAmount) {
                    alert('❌ Bitte wählen Sie einen Unterstützungsbeitrag aus.');
                    isValid = false;
                }
            } else {
                // Individual mode: check if amount is entered
                if (!customAmount || parseFloat(customAmount) <= 0) {
                    document.getElementById('customAmount').style.borderColor = '#ff4444';
                    alert('❌ Bitte geben Sie einen Unterstützungsbeitrag ein.');
                    isValid = false;
                    if (!firstError) firstError = document.getElementById('customAmount');
                } else {
                    document.getElementById('customAmount').style.borderColor = '#e0e0e0';
                }
            }

            // Check consents
            const consents = ['consent1', 'consent2', 'consent3'];
            consents.forEach(id => {
                if (!document.getElementById(id).checked) {
                    isValid = false;
                }
            });

            // Check signature
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasSignature = imageData.data.some(channel => channel !== 0 && channel !== 255);

            if (!hasSignature) {
                document.querySelector('.signature-pad').style.borderColor = '#ff4444';
                isValid = false;
            }

            if (isValid) {
                // Show success and submit
                alert('✅ Alle Daten korrekt! Formular wird übermittelt...');
                submitForm();
            } else {
                alert('❌ Bitte füllen Sie alle Pflichtfelder aus und überprüfen Sie Ihre Eingaben.');
                if (firstError) firstError.focus();
            }
        }

        async function submitForm() {
            const btn = document.getElementById('validateBtn');
            btn.disabled = true;
            btn.innerHTML = 'Wird übermittelt... <span class="loading"></span>';

            // Collect form data
            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = parseFloat(document.getElementById('customAmount').value) || 10;
            const interval = document.getElementById('interval').value;

            // Calculate yearly amount
            const multipliers = {
                'monthly': 12,
                'quarterly': 4,
                'halfyearly': 2,
                'yearly': 1
            };
            const yearlyAmount = amount * multipliers[interval];

            // ERH specific
            const oldAmount = type === 'ERH' ? parseFloat(document.getElementById('oldAmount').value) || 0 : null;
            const increaseAmount = type === 'ERH' && oldAmount ? (yearlyAmount - (oldAmount * multipliers[interval])) : null;

            // Build record for Supabase
            const record = {
                // Verknüpfungen (aus URL/Kontext)
                campaign_id: formContext.campaign_id,
                campaign_area_id: formContext.campaign_area_id,
                werber_id: formContext.botschafter_id,
                teamchef_id: formContext.teamchef_id,
                quality_id: formContext.quality_id,
                customer_id: formContext.customer_id,
                kw: formContext.kw,
                year: formContext.year,

                // Datensatz-Typ und Status
                record_type: type === 'ERH' ? 'erhoehung' : 'neumitglied',
                record_status: 'aktiv',
                status: 'pending',

                // Persönliche Daten
                salutation: document.getElementById('salutation').value,
                title: document.getElementById('title').value,
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                company: document.getElementById('company').value,
                birth_date: document.getElementById('birthDate').value || null,
                email: document.getElementById('email').value,
                phone_fixed: document.getElementById('phoneFixed').value,
                phone_mobile: document.getElementById('phoneMobile').value,

                // Adresse
                street: document.getElementById('street').value,
                house_number: document.getElementById('houseNumber').value,
                zip_code: document.getElementById('zipCode').value,
                city: document.getElementById('city').value,

                // Zahlungsdaten
                iban: document.getElementById('iban').value,
                payment_method: document.querySelector('input[name="paymentMethod"]:checked').value,

                // Beträge
                amount: amount,
                yearly_amount: yearlyAmount,
                interval: interval,
                old_amount: oldAmount,
                increase_amount: increaseAmount,

                // ERH spezifisch
                member_number: type === 'ERH' ? document.getElementById('memberNumber').value : null,
                member_since: type === 'ERH' && document.getElementById('memberSince').value ? document.getElementById('memberSince').value : null,
                start_date: document.getElementById('laterStartDate').value || null,

                // Einwilligungen
                consent_privacy: document.getElementById('consent1').checked,
                consent_sepa: document.getElementById('consent2').checked,
                consent_statutes: document.getElementById('consent3').checked,
                contact_email: document.getElementById('contactEmail').checked,
                contact_phone: document.getElementById('contactPhone').checked,

                // Sonstiges
                notes: document.getElementById('notes').value,
                signature: document.getElementById('signatureCanvas').toDataURL()
            };

            console.log('Saving record to Supabase:', record);

            try {
                // In Supabase speichern
                const { data, error } = await supabaseClient
                    .from('records')
                    .insert(record)
                    .select()
                    .single();

                if (error) throw error;

                console.log('Record saved successfully:', data);

                // Show success page
                document.querySelector('.container').innerHTML = `
                    <div class="header">
                        <div class="drk-logo" style="margin: 0 auto; width: 100px; height: 100px; font-size: 40px;">DRK</div>
                    </div>
                    <div style="padding: 40px; text-align: center;">
                        <h1 style="color: #4caf50; margin-bottom: 20px;">✓ Erfolgreich gespeichert!</h1>
                        <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                            ${type === 'ERH' ? 'Beitragserhöhung' : 'Neumitgliedschaft'} wurde erfolgreich erfasst.
                        </p>
                        <p style="color: #888; margin-bottom: 10px;">
                            <strong>${record.first_name} ${record.last_name}</strong><br>
                            Jahresbeitrag: ${yearlyAmount.toFixed(2)} €
                        </p>
                        <button onclick="location.reload()" class="submit-btn" style="margin-top: 30px;">
                            Neues Formular
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                btn.disabled = false;
                btn.innerHTML = 'Jetzt überprüfen';
                alert('Fehler beim Speichern: ' + error.message);
            }
        }
    </script>
</body>
</html>
