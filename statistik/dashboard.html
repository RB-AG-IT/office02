<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Dashboard - RB Inside Office</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body >
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <!-- Zeile 1: Zurück | Links | Mitte | Rechts -->
            <div class="page-header-row">
                <button class="btn btn-icon" onclick="history.back()">
                    <span class="icon icon--pfeil-links"></span>
                </button>
                <div class="page-header-links">
                    <span class="text-ueberschrift" id="profileName">Max Mustermann</span>
                    <span class="text-klein">Mitarbeiternummer: <span id="employeeId">MA-001</span> • Erstellt am: <span id="createdDate">01.01.2024</span></span>
                </div>
                <div class="page-header-mitte">
                    <span class="text-ueberschrift">Statistik Dashboard</span>
                </div>
                <div class="page-header-rechts">
                </div>
            </div>
            <!-- Lokale Tabs (per Klick navigierbar) -->
            <div class="page-header-tabs" id="dashboardSubTabs">
                <div class="kw-tab active" data-tab="uebersicht">Übersicht</div>
                <div class="kw-tab" data-tab="werben">Werben</div>
                <div class="kw-tab" data-tab="teamleitung">Teamleitung</div>
                <div class="kw-tab" data-tab="quality">Quality</div>
                <div class="kw-tab" data-tab="recruiting">Recruiting</div>
                <div class="kw-tab" data-tab="empfehlung">Empfehlung</div>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            <!-- TAB: Übersicht -->
            <div class="kw-tab-content active" id="tab-uebersicht">
                <!-- Werber: Übersicht mit zusammengefasster Tabelle -->
                <div class="abschnitt--card--umrandet" id="uebersichtPlaceholder">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Übersicht</div>
                    </div>
                    <div class="zeile">
                        <div id="uebersichtStatsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Kunde/Kampagne/Gebiet: voller Inhalt -->
                <div id="kundeKampagneContent" style="display: none;">
                    <div class="abschnitt--card--umrandet">
                        <div class="zeile zeile--header">
                            <div class="text-ueberschrift-abschnitt">Stats</div>
                        </div>
                        <div class="zeile">
                            <div id="kkStatsTableContainer" style="width: 100%;"></div>
                        </div>
                    </div>

                    <div class="abschnitt--card--umrandet">
                        <div class="zeile zeile--header">
                            <div class="text-ueberschrift-abschnitt">Wochenverlauf</div>
                        </div>
                        <div class="zeile">
                            <div style="height: 280px; width: 100%;">
                                <canvas id="kkChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="abschnitt--card--umrandet">
                        <div class="zeile zeile--header">
                            <div class="text-ueberschrift-abschnitt">Einsätze</div>
                        </div>
                        <div class="zeile">
                            <div id="kkEinsatzTimeline" style="width: 100%;"></div>
                        </div>
                    </div>

                    <div class="abschnitt--card--umrandet">
                        <div class="zeile zeile--header">
                            <div class="text-ueberschrift-abschnitt">Achievements</div>
                        </div>
                        <div class="zeile">
                            <div class="achievement-grid" id="kkAchievementGrid"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Werben -->
            <div class="kw-tab-content" id="tab-werben">
                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Stats</div>
                    </div>
                    <div class="zeile">
                        <div id="statsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Wochenverlauf</div>
                    </div>
                    <div class="zeile">
                        <div style="height: 280px; width: 100%;">
                            <canvas id="werbenChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Einsätze</div>
                    </div>
                    <div class="zeile">
                        <div id="einsatzTimeline" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Achievements</div>
                    </div>
                    <div class="zeile">
                        <div class="achievement-grid" id="achievementGrid"></div>
                    </div>
                </div>
            </div>

            <!-- TAB: Teamleitung -->
            <div class="kw-tab-content" id="tab-teamleitung">
                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Stats</div>
                    </div>
                    <div class="zeile">
                        <div id="tlStatsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Wochenverlauf</div>
                    </div>
                    <div class="zeile">
                        <div style="height: 280px; width: 100%;">
                            <canvas id="teamleitungChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Einsätze</div>
                    </div>
                    <div class="zeile">
                        <div id="tlEinsatzTimeline" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Achievements</div>
                    </div>
                    <div class="zeile">
                        <div class="achievement-grid" id="tlAchievementGrid"></div>
                    </div>
                </div>
            </div>

            <!-- TAB: Quality -->
            <div class="kw-tab-content" id="tab-quality">
                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Stats</div>
                    </div>
                    <div class="zeile">
                        <div id="qStatsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Wochenverlauf</div>
                    </div>
                    <div class="zeile">
                        <div style="height: 280px; width: 100%;">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Einsätze</div>
                    </div>
                    <div class="zeile">
                        <div id="qEinsatzTimeline" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Achievements</div>
                    </div>
                    <div class="zeile">
                        <div class="achievement-grid" id="qAchievementGrid"></div>
                    </div>
                </div>
            </div>

            <!-- TAB: Recruiting -->
            <div class="kw-tab-content" id="tab-recruiting">
                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Stats</div>
                    </div>
                    <div class="zeile">
                        <div id="rStatsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Recruiting-Baum</div>
                    </div>
                    <div class="zeile">
                        <div id="rContentContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Achievements</div>
                    </div>
                    <div class="zeile">
                        <div class="achievement-grid" id="rAchievementGrid"></div>
                    </div>
                </div>
            </div>

            <!-- TAB: Empfehlung -->
            <div class="kw-tab-content" id="tab-empfehlung">
                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Stats</div>
                    </div>
                    <div class="zeile">
                        <div id="eStatsTableContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Empfehlungs-Baum</div>
                    </div>
                    <div class="zeile">
                        <div id="eContentContainer" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="abschnitt--card--umrandet">
                    <div class="zeile zeile--header">
                        <div class="text-ueberschrift-abschnitt">Achievements</div>
                    </div>
                    <div class="zeile">
                        <div class="achievement-grid" id="eAchievementGrid"></div>
                    </div>
                </div>
            </div>
        </div><!-- /page-content -->
    </div>

    <script>
        // =============================================
        // SUPABASE CLIENT
        // =============================================
        const supabase = window.parent.supabaseClient;

        // =============================================
        // URL-PARAMETER & INITIALISIERUNG
        // =============================================
        const urlParams = new URLSearchParams(window.location.search);
        const personId = urlParams.get('id');
        const personType = urlParams.get('type');
        const personName = urlParams.get('name');

        if (personName) {
            document.getElementById('profileName').textContent = decodeURIComponent(personName);
        }

        // =============================================
        // SHELL-TOOLBAR AKTIVIEREN
        // =============================================
        if (window.parent !== window) {
            window.parent.postMessage({
                type: 'updateToolbar',
                config: {
                    showToolbar: true,
                    searchPlaceholder: 'Benutzer, Kampagne, Kunde suchen...'
                }
            }, '*');
        }

        // =============================================
        // SUCHDATEN AUS SUPABASE
        // =============================================
        let allSearchItems = [];

        async function loadSearchData() {
            try {
                // Werber laden
                const { data: werber } = await supabase
                    .from('users')
                    .select('id, name')
                    .eq('role', 'werber');

                // Kunden laden
                const { data: kunden } = await supabase
                    .from('customers')
                    .select('id, name, full_name');

                // Kampagnen laden
                const { data: kampagnen } = await supabase
                    .from('campaigns')
                    .select('id, name');

                // Gebiete laden
                const { data: gebiete } = await supabase
                    .from('customer_areas')
                    .select('id, name');

                // Alle zusammenfügen
                allSearchItems = [
                    ...(werber || []).map(w => ({ id: w.id, name: w.name, type: 'werber' })),
                    ...(kunden || []).map(k => ({ id: k.id, name: k.full_name || k.name, type: 'kunde' })),
                    ...(kampagnen || []).map(k => ({ id: k.id, name: k.name, type: 'kampagne' })),
                    ...(gebiete || []).map(g => ({ id: g.id, name: g.name, type: 'gebiet' }))
                ];
            } catch (error) {
                console.error('Fehler beim Laden der Suchdaten:', error);
            }
        }

        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'searchQuery') {
                const query = e.data.query.toLowerCase().trim();
                if (!query) return;

                const results = allSearchItems
                    .filter(item => item.name.toLowerCase().includes(query))
                    .slice(0, 10)
                    .map(item => ({ id: item.id, name: item.name, type: item.type }));

                window.parent.postMessage({
                    type: 'searchResults',
                    query: query,
                    headerText: 'Ergebnisse',
                    results: results
                }, '*');
            }

            if (e.data && e.data.type === 'searchSelect') {
                const selectedItem = allSearchItems.find(item => item.id === e.data.id);
                if (selectedItem) {
                    window.location.href = `dashboard.html?id=${selectedItem.id}&type=${selectedItem.type}&name=${encodeURIComponent(selectedItem.name)}`;
                }
            }
        });

        // =============================================
        // EINSÄTZE AUS SUPABASE LADEN
        // =============================================
        let einsaetzeData = [];
        let tlEinsaetzeData = [];
        let qEinsaetzeData = [];

        async function loadEinsaetze() {
            if (!personId) return;

            try {
                // Kampagnen und Gebiete für Namen laden
                const { data: campaigns } = await supabase.from('campaigns').select('id, name');
                const { data: areas } = await supabase.from('campaign_areas').select('id, name');
                const campaignMap = Object.fromEntries((campaigns || []).map(c => [c.id, c.name]));
                const areaMap = Object.fromEntries((areas || []).map(a => [a.id, a.name]));

                // Einsätze basierend auf personType laden
                let query = supabase
                    .from('campaign_attendance')
                    .select('campaign_id, kw, day_0, day_1, day_2, day_3, day_4, day_5, day_6');

                if (personType === 'werber') {
                    query = query.eq('user_id', personId);
                } else if (personType === 'kampagne') {
                    query = query.eq('campaign_id', personId);
                }

                const { data: attendance } = await query;

                // Records für Statistiken laden
                let recordsQuery = supabase
                    .from('records')
                    .select('campaign_id, campaign_area_id, yearly_amount, record_status, created_at');

                if (personType === 'werber') {
                    recordsQuery = recordsQuery.eq('werber_id', personId);
                } else if (personType === 'kunde') {
                    recordsQuery = recordsQuery.eq('customer_id', personId);
                } else if (personType === 'kampagne') {
                    recordsQuery = recordsQuery.eq('campaign_id', personId);
                }

                const { data: records } = await recordsQuery;

                // Einsätze nach Kampagne gruppieren und Stats berechnen
                const einsatzMap = {};
                (attendance || []).forEach(a => {
                    if (!einsatzMap[a.campaign_id]) {
                        einsatzMap[a.campaign_id] = { kws: new Set(), tage: 0 };
                    }
                    einsatzMap[a.campaign_id].kws.add(a.kw);
                    const days = [a.day_0, a.day_1, a.day_2, a.day_3, a.day_4, a.day_5, a.day_6].filter(d => d).length;
                    einsatzMap[a.campaign_id].tage += days;
                });

                // Records nach Kampagne aggregieren
                const recordStats = {};
                (records || []).forEach(r => {
                    if (!recordStats[r.campaign_id]) {
                        recordStats[r.campaign_id] = { mg: 0, je: 0, storno: 0, total: 0 };
                    }
                    recordStats[r.campaign_id].total++;
                    if (r.record_status === 'aktiv') {
                        recordStats[r.campaign_id].mg++;
                        recordStats[r.campaign_id].je += (r.yearly_amount || 0);
                    } else if (r.record_status === 'storno') {
                        recordStats[r.campaign_id].storno++;
                    }
                });

                // Einsätze zusammenbauen
                einsaetzeData = Object.entries(einsatzMap).map(([campaignId, data]) => {
                    const stats = recordStats[campaignId] || { mg: 0, je: 0, storno: 0, total: 0 };
                    const stornoquote = stats.total > 0 ? (stats.storno / stats.total * 100) : 0;
                    return {
                        kampagne: campaignMap[campaignId] || 'Unbekannt',
                        gebiet: '-',
                        mg: stats.mg,
                        je: stats.je,
                        eh: Math.round(stats.je / 60 * 10) / 10,
                        effizienz: data.tage > 0 ? Math.round(stats.mg / data.tage * 100) : 0,
                        stornoquote: Math.round(stornoquote * 10) / 10
                    };
                });

                tlEinsaetzeData = einsaetzeData.map(e => ({ ...e }));
                qEinsaetzeData = einsaetzeData.map(e => ({ ...e }));

            } catch (error) {
                console.error('Fehler beim Laden der Einsätze:', error);
            }
        }

        // Achievement-Typen
        const werbenAchievementTypes = [
            { id: 'mg_tag', name: 'Meiste Mitglieder an einem Tag' },
            { id: 'eh_tag', name: 'Meiste EH an einem Tag' },
            { id: 'mg_woche', name: 'Meiste Mitglieder in einer Woche' },
            { id: 'eh_woche', name: 'Meiste EH in einer Woche' },
            { id: 'schrieb_nmg', name: 'Höchster Schrieb Neumitglied' },
            { id: 'beitragsanpassung', name: 'Höchste positive Beitragsanpassung' },
            { id: 'mg_stunde', name: 'Meiste Mitglieder in 1 Stunde' },
            { id: 'eh_durchschnitt_tag', name: 'Höchster Ø EH pro MG an einem Tag' },
            { id: 'serie_stunde', name: 'Längste Stundenserie' },
            { id: 'serie_15min', name: 'Längste 15-Minuten-Serie' },
            { id: 'tage_am_stueck', name: 'Meiste Tage am Stück im Einsatz' },
            { id: 'stornoquote_woche', name: 'Beste Stornoquote in einer Woche' },
            { id: 'eh_stunde', name: 'Meiste EH in 1 Stunde' }
        ];

        const tlAchievementTypes = [
            { id: 'mg_tag', name: 'Meiste Mitglieder an einem Tag' },
            { id: 'eh_tag', name: 'Meiste EH an einem Tag' },
            { id: 'mg_woche', name: 'Meiste Mitglieder in einer Woche' },
            { id: 'eh_woche', name: 'Meiste EH in einer Woche' },
            { id: 'schrieb_nmg', name: 'Höchster Schrieb Neumitglied' },
            { id: 'beitragsanpassung', name: 'Höchste positive Beitragsanpassung' },
            { id: 'mg_stunde', name: 'Meiste Mitglieder in 1 Stunde' },
            { id: 'eh_durchschnitt_tag', name: 'Höchster Ø EH pro MG an einem Tag' },
            { id: 'serie_stunde', name: 'Längste Stundenserie' },
            { id: 'serie_15min', name: 'Längste 15-Minuten-Serie' },
            { id: 'effizienz', name: 'Höchste Effizienz' },
            { id: 'stornoquote_woche', name: 'Beste Stornoquote in einer Woche' },
            { id: 'eh_stunde', name: 'Meiste EH in 1 Stunde' }
        ];

        const qAchievementTypes = [
            { id: 'stornoquote_woche', name: 'Niedrigste Stornoquote pro Woche' },
            { id: 'eh_durchschnitt_woche', name: 'Höchster Tagesdurchschnitt an EH p.P. für eine Woche' },
            { id: 'einschulungen_woche', name: 'Meiste erfolgreiche Einschulungen in einer Woche' },
            { id: 'einschulungen_monat', name: 'Meiste erfolgreiche Einschulungen in einem Monat' },
            { id: 'zahlungsintervall_woche', name: 'Höchster %Satz an jährlichem Zahlungsintervall pro Woche' },
            { id: 'mail_optin_woche', name: 'Höchster %Satz an Mail + Opt In pro Woche' },
            { id: 'tel_optin_woche', name: 'Höchster %Satz an Tel + Opt In pro Woche' }
        ];

        const rAchievementTypes = [
            ...werbenAchievementTypes,
            { id: 'recruitings_monat', name: 'Meiste Recruitings pro Monat' },
            { id: 'recruitings_quartal', name: 'Meiste Recruitings pro Quartal' },
            { id: 'recruitings_serie', name: 'Meiste erfolgreiche Recruitings am Stück' },
            { id: 'recruiting_stufe', name: 'Tiefste Recruiting Stufe' }
        ];

        const eAchievementTypes = [
            ...werbenAchievementTypes,
            { id: 'empfehlungen_monat', name: 'Meiste Empfehlungen pro Monat' },
            { id: 'empfehlungen_quartal', name: 'Meiste Empfehlungen pro Quartal' },
            { id: 'empfehlungen_serie', name: 'Meiste erfolgreiche Empfehlungen am Stück' },
            { id: 'empfehlung_stufe', name: 'Tiefste Empfehlung Stufe' }
        ];

        // =============================================
        // ACHIEVEMENTS AUS SUPABASE BERECHNEN
        // =============================================
        let achievementsData = {};
        let tlAchievementsData = {};
        let qAchievementsData = {};
        let rAchievementsData = {};
        let eAchievementsData = {};

        async function calculateAchievements() {
            if (!personId) return;

            try {
                // Records für diese Person laden
                let recordsQuery = supabase
                    .from('records')
                    .select('id, campaign_id, yearly_amount, record_status, created_at, kw, year');

                if (personType === 'werber') {
                    recordsQuery = recordsQuery.eq('werber_id', personId);
                } else if (personType === 'kunde') {
                    recordsQuery = recordsQuery.eq('customer_id', personId);
                } else if (personType === 'kampagne') {
                    recordsQuery = recordsQuery.eq('campaign_id', personId);
                }

                const { data: records } = await recordsQuery;
                const { data: campaigns } = await supabase.from('campaigns').select('id, name');
                const campaignMap = Object.fromEntries((campaigns || []).map(c => [c.id, c.name]));

                // Aktive Records
                const activeRecords = (records || []).filter(r => r.record_status === 'aktiv');

                // Pro Tag gruppieren
                const recordsByDay = {};
                activeRecords.forEach(r => {
                    const day = r.created_at?.split('T')[0] || 'unknown';
                    if (!recordsByDay[day]) recordsByDay[day] = [];
                    recordsByDay[day].push(r);
                });

                // Pro Woche gruppieren
                const recordsByWeek = {};
                activeRecords.forEach(r => {
                    const weekKey = `${r.year}-KW${r.kw}`;
                    if (!recordsByWeek[weekKey]) recordsByWeek[weekKey] = [];
                    recordsByWeek[weekKey].push(r);
                });

                // Beste Werte berechnen
                let bestMgTag = { count: 0, date: null, campaign: null };
                let bestEhTag = { eh: 0, date: null, campaign: null };
                let bestMgWoche = { count: 0, week: null, campaign: null };
                let bestSchrieb = { amount: 0, date: null, campaign: null };

                Object.entries(recordsByDay).forEach(([day, recs]) => {
                    if (recs.length > bestMgTag.count) {
                        bestMgTag = { count: recs.length, date: day, campaign: campaignMap[recs[0]?.campaign_id] };
                    }
                    const eh = recs.reduce((sum, r) => sum + (r.yearly_amount || 0), 0) / 60;
                    if (eh > bestEhTag.eh) {
                        bestEhTag = { eh: Math.round(eh * 10) / 10, date: day, campaign: campaignMap[recs[0]?.campaign_id] };
                    }
                    const maxAmount = Math.max(...recs.map(r => r.yearly_amount || 0));
                    if (maxAmount > bestSchrieb.amount) {
                        bestSchrieb = { amount: maxAmount, date: day, campaign: campaignMap[recs[0]?.campaign_id] };
                    }
                });

                Object.entries(recordsByWeek).forEach(([week, recs]) => {
                    if (recs.length > bestMgWoche.count) {
                        bestMgWoche = { count: recs.length, week: week, campaign: campaignMap[recs[0]?.campaign_id] };
                    }
                });

                // Formatieren
                const formatDate = (d) => d ? new Date(d).toLocaleDateString('de-DE') : '-';

                achievementsData = {
                    'mg_tag': bestMgTag.count > 0 ? { score: `${bestMgTag.count} MG`, datum: formatDate(bestMgTag.date), kampagne: bestMgTag.campaign || '-', active: true } : null,
                    'eh_tag': bestEhTag.eh > 0 ? { score: `${bestEhTag.eh} EH`, datum: formatDate(bestEhTag.date), kampagne: bestEhTag.campaign || '-', active: true } : null,
                    'mg_woche': bestMgWoche.count > 0 ? { score: `${bestMgWoche.count} MG`, datum: bestMgWoche.week, kampagne: bestMgWoche.campaign || '-', active: true } : null,
                    'schrieb_nmg': bestSchrieb.amount > 0 ? { score: `${bestSchrieb.amount.toFixed(2)} €`, datum: formatDate(bestSchrieb.date), kampagne: bestSchrieb.campaign || '-', active: true } : null,
                    'eh_woche': null,
                    'beitragsanpassung': null,
                    'mg_stunde': null,
                    'eh_durchschnitt_tag': null,
                    'serie_stunde': null,
                    'serie_15min': null,
                    'tage_am_stueck': null,
                    'stornoquote_woche': null,
                    'eh_stunde': null
                };

                tlAchievementsData = { ...achievementsData };
                qAchievementsData = { ...achievementsData };
                rAchievementsData = { ...achievementsData };
                eAchievementsData = { ...achievementsData };

            } catch (error) {
                console.error('Fehler beim Berechnen der Achievements:', error);
            }
        }

        // Fallback für leere Daten
        const demoEAchievements = {
            'empfehlungen_monat': { score: '5', datumVon: '01.02.2025', datumBis: '28.02.2025', kampagne: 'DRK Darmstadt', active: true },
            'empfehlungen_quartal': { score: '12', datumVon: '01.01.2025', datumBis: '31.03.2025', kampagne: 'DRK Odenwald', active: false },
            'empfehlungen_serie': { score: '6', datum: '18.03.2025', kampagne: 'DRK Odenwald', active: true },
            'empfehlung_stufe': { score: 'Stufe 4', datum: '22.03.2025', kampagne: 'DRK Bergstraße', active: false }
        };

        // =============================================
        // RECRUITING/EMPFEHLUNGS-BÄUME AUS SUPABASE
        // =============================================
        let recruitingTreeData = { name: personName || 'Unbekannt', date: null, children: [] };
        let empfehlungTreeData = { name: personName || 'Unbekannt', date: null, children: [] };

        async function loadRecruitmentTrees() {
            if (!personId || personType !== 'werber') return;

            try {
                // User-Namen laden
                const { data: users } = await supabase.from('users').select('id, name');
                const userMap = Object.fromEntries((users || []).map(u => [u.id, u.name]));

                // Recruitments laden (diese Person als recruited_by)
                const { data: recruitments, error } = await supabase
                    .from('user_recruitments')
                    .select('user_id, recruited_by_id, recruitment_type, recruitment_date')
                    .eq('recruited_by_id', personId);

                if (error) {
                    console.log('user_recruitments Tabelle noch nicht vorhanden');
                    return;
                }

                // Rekursive Funktion um Baum aufzubauen
                async function buildTree(userId, type) {
                    const children = (recruitments || [])
                        .filter(r => r.recruited_by_id === userId && r.recruitment_type === type)
                        .map(r => ({
                            id: r.user_id,
                            name: userMap[r.user_id] || 'Unbekannt',
                            date: r.recruitment_date ? new Date(r.recruitment_date).toLocaleDateString('de-DE') : null,
                            children: []
                        }));

                    // Für jeden Child rekursiv weiter suchen
                    for (let child of children) {
                        const subRecruitments = await supabase
                            .from('user_recruitments')
                            .select('user_id, recruitment_date')
                            .eq('recruited_by_id', child.id)
                            .eq('recruitment_type', type);

                        if (subRecruitments.data) {
                            child.children = subRecruitments.data.map(sr => ({
                                name: userMap[sr.user_id] || 'Unbekannt',
                                date: sr.recruitment_date ? new Date(sr.recruitment_date).toLocaleDateString('de-DE') : null,
                                children: []
                            }));
                        }
                    }

                    return children;
                }

                recruitingTreeData = {
                    name: personName || userMap[personId] || 'Unbekannt',
                    date: null,
                    children: await buildTree(personId, 'recruiting')
                };

                empfehlungTreeData = {
                    name: personName || userMap[personId] || 'Unbekannt',
                    date: null,
                    children: await buildTree(personId, 'empfehlung')
                };

            } catch (error) {
                console.error('Fehler beim Laden der Recruitment-Bäume:', error);
            }
        }

        // Übersichts-Rows für Werber
        const uebersichtRows = [
            {
                kategorie: 'Netto Mitglieder Werben',
                type: 'netto',
                anzahl: 38,
                jahreseuros: '4.560 €',
                einheiten: 9.5,
                ruecklaufquote: '5,0%',
                ruecklaufquoteMg: '4,2%',
                ruecklaufquoteEur: '7,1%',
                beitrag: '10,00 €',
                alter: 52,
                mailOptin: '85% / 72%',
                telOptin: '78% / 65%',
                zahlungsrhythmus: { m: 45, qt: 25, hj: 15, j: 15 },
                provision: '1.824 €',
                faktor: 6.2,
                children: [
                    { kategorie: 'Neumitglieder', anzahl: 28, jahreseuros: '3.360 €', einheiten: 7.0, ruecklaufquote: '4,2%', ruecklaufquoteMg: '4,2%', ruecklaufquoteEur: '—', beitrag: '10,00 €', alter: 48, mailOptin: '88% / 75%', telOptin: '80% / 68%', zahlungsrhythmus: { m: 40, qt: 30, hj: 15, j: 15 }, provision: '1.344 €', faktor: 6.5 },
                    { kategorie: 'Erhöhungen', anzahl: 10, jahreseuros: '1.200 €', einheiten: 2.5, ruecklaufquote: '7,1%', ruecklaufquoteMg: '—', ruecklaufquoteEur: '7,1%', beitrag: '10,00 €', alter: 62, mailOptin: '78% / 65%', telOptin: '72% / 58%', zahlungsrhythmus: { m: 55, qt: 15, hj: 15, j: 15 }, provision: '480 €', faktor: 5.5 }
                ]
            },
            {
                kategorie: 'Netto Mitglieder Teamleitung',
                type: 'netto',
                anzahl: 156,
                jahreseuros: '18.720 €',
                einheiten: 39.0,
                ruecklaufquote: '4,8%',
                ruecklaufquoteMg: '4,0%',
                ruecklaufquoteEur: '6,5%',
                beitrag: '10,00 €',
                alter: 50,
                mailOptin: '86% / 74%',
                telOptin: '79% / 67%',
                zahlungsrhythmus: { m: 42, qt: 28, hj: 16, j: 14 },
                provision: '7.488 €',
                faktor: 6.4,
                children: [
                    { kategorie: 'Neumitglieder', anzahl: 118, jahreseuros: '14.160 €', einheiten: 29.5, ruecklaufquote: '4,0%', ruecklaufquoteMg: '4,0%', ruecklaufquoteEur: '—', beitrag: '10,00 €', alter: 46, mailOptin: '89% / 77%', telOptin: '81% / 69%', zahlungsrhythmus: { m: 38, qt: 32, hj: 16, j: 14 }, provision: '5.664 €', faktor: 6.7 },
                    { kategorie: 'Erhöhungen', anzahl: 38, jahreseuros: '4.560 €', einheiten: 9.5, ruecklaufquote: '6,5%', ruecklaufquoteMg: '—', ruecklaufquoteEur: '6,5%', beitrag: '10,00 €', alter: 60, mailOptin: '77% / 64%', telOptin: '73% / 59%', zahlungsrhythmus: { m: 52, qt: 18, hj: 16, j: 14 }, provision: '1.824 €', faktor: 5.6 }
                ]
            },
            {
                kategorie: 'Netto Mitglieder Quality',
                type: 'netto',
                anzahl: 42,
                jahreseuros: '5.040 €',
                einheiten: 10.5,
                ruecklaufquote: '2,1%',
                ruecklaufquoteMg: '1,8%',
                ruecklaufquoteEur: '2,9%',
                beitrag: '10,00 €',
                alter: 49,
                mailOptin: '92% / 85%',
                telOptin: '88% / 78%',
                zahlungsrhythmus: { m: 35, qt: 28, hj: 20, j: 17 },
                provision: '2.016 €',
                faktor: 6.8,
                children: [
                    { kategorie: 'Neumitglieder', anzahl: 32, jahreseuros: '3.840 €', einheiten: 8.0, ruecklaufquote: '1,8%', ruecklaufquoteMg: '1,8%', ruecklaufquoteEur: '—', beitrag: '10,00 €', alter: 45, mailOptin: '94% / 88%', telOptin: '90% / 80%', zahlungsrhythmus: { m: 32, qt: 30, hj: 20, j: 18 }, provision: '1.536 €', faktor: 7.0 },
                    { kategorie: 'Erhöhungen', anzahl: 10, jahreseuros: '1.200 €', einheiten: 2.5, ruecklaufquote: '2,9%', ruecklaufquoteMg: '—', ruecklaufquoteEur: '2,9%', beitrag: '10,00 €', alter: 58, mailOptin: '87% / 76%', telOptin: '82% / 70%', zahlungsrhythmus: { m: 42, qt: 22, hj: 20, j: 16 }, provision: '480 €', faktor: 6.2 }
                ]
            },
            {
                kategorie: 'Netto Mitglieder Recruiting',
                type: 'netto',
                anzahl: 85,
                jahreseuros: '10.200 €',
                einheiten: 21.3,
                ruecklaufquote: '4,5%',
                ruecklaufquoteMg: '3,8%',
                ruecklaufquoteEur: '6,2%',
                beitrag: '10,00 €',
                alter: 51,
                mailOptin: '84% / 71%',
                telOptin: '77% / 64%',
                zahlungsrhythmus: { m: 44, qt: 26, hj: 16, j: 14 },
                provision: '4.080 €',
                faktor: 6.3,
                children: [
                    { kategorie: 'Neumitglieder', anzahl: 64, jahreseuros: '7.680 €', einheiten: 16.0, ruecklaufquote: '3,8%', ruecklaufquoteMg: '3,8%', ruecklaufquoteEur: '—', beitrag: '10,00 €', alter: 47, mailOptin: '87% / 74%', telOptin: '80% / 67%', zahlungsrhythmus: { m: 40, qt: 29, hj: 16, j: 15 }, provision: '3.072 €', faktor: 6.6 },
                    { kategorie: 'Erhöhungen', anzahl: 21, jahreseuros: '2.520 €', einheiten: 5.3, ruecklaufquote: '6,2%', ruecklaufquoteMg: '—', ruecklaufquoteEur: '6,2%', beitrag: '10,00 €', alter: 61, mailOptin: '76% / 62%', telOptin: '70% / 56%', zahlungsrhythmus: { m: 54, qt: 18, hj: 16, j: 12 }, provision: '1.008 €', faktor: 5.5 }
                ]
            },
            {
                kategorie: 'Netto Mitglieder Empfehlung',
                type: 'netto',
                anzahl: 62,
                jahreseuros: '7.440 €',
                einheiten: 15.5,
                ruecklaufquote: '3,9%',
                ruecklaufquoteMg: '3,2%',
                ruecklaufquoteEur: '5,4%',
                beitrag: '10,00 €',
                alter: 48,
                mailOptin: '88% / 76%',
                telOptin: '82% / 70%',
                zahlungsrhythmus: { m: 38, qt: 30, hj: 18, j: 14 },
                provision: '2.976 €',
                faktor: 6.6,
                children: [
                    { kategorie: 'Neumitglieder', anzahl: 48, jahreseuros: '5.760 €', einheiten: 12.0, ruecklaufquote: '3,2%', ruecklaufquoteMg: '3,2%', ruecklaufquoteEur: '—', beitrag: '10,00 €', alter: 44, mailOptin: '91% / 79%', telOptin: '85% / 73%', zahlungsrhythmus: { m: 35, qt: 33, hj: 18, j: 14 }, provision: '2.304 €', faktor: 6.9 },
                    { kategorie: 'Erhöhungen', anzahl: 14, jahreseuros: '1.680 €', einheiten: 3.5, ruecklaufquote: '5,4%', ruecklaufquoteMg: '—', ruecklaufquoteEur: '5,4%', beitrag: '10,00 €', alter: 58, mailOptin: '80% / 68%', telOptin: '74% / 62%', zahlungsrhythmus: { m: 48, qt: 22, hj: 18, j: 12 }, provision: '672 €', faktor: 5.8 }
                ]
            }
        ];

        // Kombinierte Achievements für Kunde/Kampagne/Gebiet
        const kkAchievementTypes = [
            ...werbenAchievementTypes,
            { id: 'effizienz', name: 'Höchste Effizienz' },
            { id: 'eh_durchschnitt_woche', name: 'Höchster Tagesdurchschnitt an EH p.P. für eine Woche' },
            { id: 'einschulungen_woche', name: 'Meiste erfolgreiche Einschulungen in einer Woche' },
            { id: 'einschulungen_monat', name: 'Meiste erfolgreiche Einschulungen in einem Monat' },
            { id: 'zahlungsintervall_woche', name: 'Höchster %Satz an jährlichem Zahlungsintervall pro Woche' },
            { id: 'mail_optin_woche', name: 'Höchster %Satz an Mail + Opt In pro Woche' },
            { id: 'tel_optin_woche', name: 'Höchster %Satz an Tel + Opt In pro Woche' }
        ];

        const kkAchievements = {
            ...demoAchievements,
            'stornoquote_woche': { score: '2,1%', datumVon: '10.03.2025', datumBis: '14.03.2025', kampagne: 'DRK Odenwald', active: true },
            'effizienz': { score: '94%', datum: '20.03.2025', kampagne: 'DRK Odenwald', active: true },
            'eh_durchschnitt_woche': { score: '1,8 EH', datumVon: '06.01.2025', datumBis: '10.01.2025', kampagne: 'DRK Odenwald', active: false },
            'einschulungen_woche': { score: '4', datumVon: '27.01.2025', datumBis: '31.01.2025', kampagne: 'DRK Bergstraße', active: true },
            'einschulungen_monat': { score: '12', datumVon: '01.02.2025', datumBis: '28.02.2025', kampagne: 'DRK Darmstadt', active: false },
            'zahlungsintervall_woche': { score: '28%', datumVon: '17.02.2025', datumBis: '21.02.2025', kampagne: 'DRK Darmstadt', active: true },
            'mail_optin_woche': { score: '92%', datumVon: '10.03.2025', datumBis: '14.03.2025', kampagne: 'DRK Odenwald', active: false },
            'tel_optin_woche': null
        };

        // =============================================
        // INITIALISIERUNG
        // =============================================
        async function initDashboard() {
            // Daten aus Supabase laden
            await Promise.all([
                loadSearchData(),
                loadEinsaetze(),
                calculateAchievements(),
                loadRecruitmentTrees()
            ]);

            const isKundeOrKampagne = personType === 'kunde' || personType === 'kampagne' || personType === 'gebiet';

            if (isKundeOrKampagne) {
                // Kunde/Kampagne/Gebiet: Tabs ausblenden, nur Übersicht
                document.getElementById('dashboardSubTabs').style.display = 'none';
                document.getElementById('uebersichtPlaceholder').style.display = 'none';
                document.getElementById('kundeKampagneContent').style.display = 'block';

                document.querySelectorAll('.kw-tab-content:not(#tab-uebersicht)').forEach(el => {
                    el.style.display = 'none';
                });

                initStatsTable('kkStatsTableContainer');
                initWochenverlaufChart('kkChart');
                renderEinsatzTimeline('kkEinsatzTimeline', '01.01.2025', '31.03.2025', einsaetzeData.length > 0 ? einsaetzeData : []);
                renderAchievementGrid('kkAchievementGrid', kkAchievementTypes, achievementsData);

            } else {
                // Werber: Alle Tabs anzeigen
                initTabs('.kw-tab', '.kw-tab-content');

                // Übersicht
                initStatsTable('uebersichtStatsTableContainer', { rows: uebersichtRows });

                // Werben
                initStatsTable('statsTableContainer');
                initWochenverlaufChart('werbenChart');
                renderEinsatzTimeline('einsatzTimeline', '01.01.2025', '31.03.2025', einsaetzeData.length > 0 ? einsaetzeData : []);
                renderAchievementGrid('achievementGrid', werbenAchievementTypes, achievementsData);

                // Teamleitung
                initStatsTable('tlStatsTableContainer');
                initWochenverlaufChart('teamleitungChart');
                renderEinsatzTimeline('tlEinsatzTimeline', '01.01.2025', '31.03.2025', tlEinsaetzeData.length > 0 ? tlEinsaetzeData : [], {
                    stats: [{ key: 'effizienz', label: 'Effizienz', suffix: '%' }]
                });
                renderAchievementGrid('tlAchievementGrid', tlAchievementTypes, tlAchievementsData);

                // Quality
                initStatsTable('qStatsTableContainer');
                initWochenverlaufChart('qualityChart');
                renderEinsatzTimeline('qEinsatzTimeline', '01.01.2025', '31.03.2025', qEinsaetzeData.length > 0 ? qEinsaetzeData : [], {
                    stats: [{ key: 'stornoquote', label: 'Stornoquote', suffix: '%' }]
                });
                renderAchievementGrid('qAchievementGrid', qAchievementTypes, qAchievementsData);

                // Recruiting
                initStatsTable('rStatsTableContainer');
                renderReferralTree('rContentContainer', recruitingTreeData);
                renderAchievementGrid('rAchievementGrid', rAchievementTypes, rAchievementsData);

                // Empfehlung
                initStatsTable('eStatsTableContainer');
                renderReferralTree('eContentContainer', empfehlungTreeData);
                renderAchievementGrid('eAchievementGrid', eAchievementTypes, eAchievementsData);
            }
        }

        // Dashboard initialisieren
        initDashboard();
    </script>
</body>
</html>
