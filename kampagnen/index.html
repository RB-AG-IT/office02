<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kampagnen - RB Inside</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/main.js"></script>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Confirm Modal -->
<div class="modal modal-xs confirm-modal" id="confirmModal">
    <div class="page-container page-container--modal">
        <div class="modal-body">
            <div class="confirm-icon warning" id="confirmIcon">
                <span class="icon icon--warnung"></span>
            </div>
            <div class="confirm-title" id="confirmTitle">Bestätigung</div>
            <div class="confirm-message" id="confirmMessage">Sind Sie sicher?</div>
        </div>
        <div class="page-footer">
            <button type="button" class="btn btn-secondary" id="confirmCancelBtn">Abbrechen</button>
            <button type="button" class="btn btn-primary" id="confirmOkBtn">Bestätigen</button>
        </div>
    </div>
</div>

<!-- Anwesenheit Notizen Modal -->
<div class="modal modal-s" id="attendanceNotesModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift" id="notesModalMemberName">Mitarbeiter</span>
                    <span class="badge-zaehler" id="notesModalKw">KW 10</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeNotesModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="notizen">Notizen</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="page-content page-content--modal">
            <div class="attendance-notes-list" id="notesModalList">
                <div class="attendance-notes-empty">Keine Notizen vorhanden</div>
            </div>
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Neue Notiz</label>
                    <textarea id="notesModalTextarea" class="eingabefeld" rows="3" placeholder="Neue Notiz hinzufügen..."></textarea>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer">
            <button class="btn btn-secondary" onclick="closeNotesModal()">Abbrechen</button>
            <button class="btn btn-primary" onclick="saveNote()">Speichern</button>
        </div>
    </div>
</div>

<!-- Mitglied Modal (wiederverwendbar) -->
<div class="modal modal-s mitglied-modal" id="mitgliedModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift">Mitglied Details</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeMitgliedModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="details">Details</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="page-content page-content--modal">
            <!-- Mitglied Card (groß) -->
            <div class="mitglied-card-large" id="mitgliedCardLarge">
                <!-- Wird dynamisch gefüllt -->
            </div>

            <!-- Email bearbeiten -->
            <div class="unterabschnitt--card">
                <div class="zeile">
                    <div class="text-ueberschrift-unterabschnitt">E-Mail Adresse</div>
                </div>
                <div class="zeile">
                    <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <input type="email" class="eingabefeld" id="mitgliedEmail" placeholder="email@beispiel.de">
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                    <div class="eingabefeld-gruppe eingabefeld-gruppe--auto">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <button class="btn btn-primary" onclick="saveMitgliedEmail()">Speichern</button>
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                </div>
            </div>

            <!-- Werbegebiet ändern -->
            <div class="unterabschnitt--card">
                <div class="zeile">
                    <div class="text-ueberschrift-unterabschnitt">Werbegebiet</div>
                </div>
                <div class="zeile">
                    <div class="eingabefeld-gruppe">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <select class="eingabefeld" id="mitgliedWerbegebiet" onchange="changeMitgliedWerbegebiet()">
                            <!-- Wird dynamisch gefüllt -->
                        </select>
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                </div>
            </div>

            <!-- E-Mail Aktionen -->
            <div class="unterabschnitt--card">
                <div class="zeile">
                    <div class="text-ueberschrift-unterabschnitt">E-Mail senden</div>
                </div>
                <div class="zeile">
                    <div class="eingabefeld-gruppe">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <button id="btnWelcomeMail" class="btn btn-email btn-email-welcome" onclick="sendMitgliedEmail('welcome')" title="Willkommensmail senden">
                            <span class="icon icon--email"></span>
                            Willkommensmail
                        </button>
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                    <div class="eingabefeld-gruppe">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <button id="btnErhoehungMail" class="btn btn-email btn-email-erhoehung" onclick="sendMitgliedEmail('erhoehung')" title="Erhöhungsmail senden">
                            <span class="icon icon--trend"></span>
                            Erhöhungsmail
                        </button>
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                </div>
                <div class="zeile">
                    <div class="eingabefeld-gruppe">
                        <label class="eingabefeld-beschriftung-oben"></label>
                        <button id="btnIbanMail" class="btn btn-email btn-email-iban" onclick="sendMitgliedEmail('iban')" title="IBAN nachtragen Mail senden">
                            <span class="icon icon--kreditkarte"></span>
                            IBAN nachtragen
                        </button>
                        <span class="eingabefeld-beschriftung-unten"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer">
            <button class="btn btn-secondary" onclick="closeMitgliedModal()">Schließen</button>
        </div>
    </div>
</div>

<!-- Modal für Kampagnen-Übersicht (View) -->
<div class="modal modal-xl" id="campaignViewModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift">Kampagnen-Übersicht</span>
                </div>
                <div class="page-header-mitte">
                    <span class="text-ueberschrift" id="campaignViewName"></span>
                </div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="openCampaignSettingsModal()" title="Kampagnen-Einstellungen">
                        <span class="icon icon--einstellungen"></span>
                    </button>
                    <button class="btn btn-icon" onclick="closeViewModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs" id="campaignViewTabs">
                <div class="kw-tab active" data-tab="kw">KW-Übersicht</div>
                <div class="kw-tab" data-tab="provision">Werbegebiete & Provision</div>
            </div>
        </div>

        <!-- ===================== TAB 1: KW-Übersicht ===================== -->
        <div class="kw-tab-content active" id="tab-kw">
            <div class="page-content page-content--modal">
                <!-- Letzte Schriebe (5+5 Grid) -->
                <div class="abschnitt--card">
                    <div class="zeile zeile--center">
                        <span class="icon icon--dokument"></span>
                        <div class="text-ueberschrift-abschnitt">Letzte Schriebe</div>
                        <div class="kw-info-icon">
                            i
                            <div class="kw-info-tooltip kw-info-tooltip--bottom" style="left: 0; right: auto; min-width: 200px;">
                                <div class="kw-info-tooltip-row">
                                    <span class="icon icon--muted icon--email"></span>
                                    <span class="text-klein--fett">E-Mail versendet</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="icon icon--success icon--email"></span>
                                    <span class="text-klein--fett">E-Mail geöffnet</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="icon icon--error icon--email"></span>
                                    <span class="text-klein--fett">E-Mail nicht gesendet</span>
                                </div>
                                <div class="kw-info-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);">
                                    <span class="text-klein--fett" style="color: #22c55e;">IBAN</span>
                                    <span class="text-klein--fett">IBAN nachgetragen</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="text-klein--fett" style="color: var(--text-muted);">IBAN</span>
                                    <span class="text-klein--fett">IBAN fehlt noch</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="zeile">
                        <div class="anzeigenfeld anzeigenfeld--schriebe-row" id="viewLastSchriebeRow1">
                            <!-- 5 Kärtchen Reihe 1 - wird dynamisch gefüllt -->
                        </div>
                    </div>
                    <div class="zeile">
                        <div class="anzeigenfeld anzeigenfeld--schriebe-row" id="viewLastSchriebeRow2">
                            <!-- 5 Kärtchen Reihe 2 - wird dynamisch gefüllt -->
                        </div>
                    </div>
                </div>

                <hr class="trennlinie">

                <!-- KW-Einsatzplanung mit TC-Provision pro KW -->
                <div class="abschnitt--card">
                    <div class="zeile zeile--center">
                        <span class="icon icon--kalender"></span>
                        <div class="text-ueberschrift-abschnitt">Kampagnenplanung</div>
                        <div class="kw-info-icon">
                            i
                            <div class="kw-info-tooltip kw-info-tooltip--bottom" style="left: 0; right: auto;">
                                <div class="kw-info-tooltip-row">
                                    <span class="kw-info-tooltip-pill yellow"></span>
                                    <span class="text-klein--fett">Teamchef (TC)</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="kw-info-tooltip-pill green"></span>
                                    <span class="text-klein--fett">Neuanreise (neu in dieser KW)</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="kw-info-tooltip-pill red"></span>
                                    <span class="text-klein--fett">Abreise (letzte KW im Team)</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="kw-info-tooltip-pill white"></span>
                                    <span class="text-klein--fett">Normales Teammitglied</span>
                                </div>
                                <div class="kw-info-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(135deg, #22c55e 50%, #ef4444 50%); flex-shrink: 0;"></span>
                                    <span class="text-klein--fett">An- & Abreise in einer KW</span>
                                </div>
                                <div class="kw-info-tooltip-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color);">
                                    <span class="text-klein">TC-Provision: Aufteilung des TC-Faktors (max 1.0) auf verschiedene Dienste pro KW</span>
                                </div>
                                <div class="kw-info-tooltip-row">
                                    <span class="text-klein">Klicken Sie auf eine KW, um Details anzuzeigen. Pro KW können TC-Provision/Dienste, Anreisen und Abreisen eingetragen werden.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="viewKWDetails">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                </div>
            </div><!-- Ende page-content--modal -->
        </div><!-- Ende tab-kw -->

        <!-- ===================== TAB 2: Werbegebiete & Provisionen ===================== -->
        <div class="kw-tab-content" id="tab-provision">
            <!-- Split-Layout: Links Konfiguration, Rechts Sidebar -->
            <div class="page-content--modal-split">
                    <!-- Linke Seite: Platzhalter wenn kein WG ausgewählt -->
                    <div class="page-content page-content--modal page-content--empty" id="wgConfigPlaceholder">
                        <div class="empty-state">
                            <span class="icon icon--werbegebiet"></span>
                            <div class="text-ueberschrift-unterabschnitt">Kein Werbegebiet ausgewählt</div>
                            <span class="text-klein text-sekundaer">Wähle rechts einen Kunden und ein Werbegebiet aus</span>
                        </div>
                    </div>

                    <!-- Linke Seite: WG Konfiguration -->
                    <div class="page-content page-content--modal" id="wgConfigPanel" style="display: none;">
                            <!-- KW-Auswahl Header -->
                            <div class="zeile zeile--center zeile--spread">
                                <div class="text-ueberschrift-abschnitt" id="wgConfigName"></div>
                                <div class="anzeigenfeld anzeigenfeld--pills" id="wgKwSelection"></div>
                            </div>

                            <!-- Gruppenbild -->
                            <div class="unterabschnitt--card">
                                <div class="zeile">
                                    <div class="text-ueberschrift-unterabschnitt">Gruppenbild</div>
                                </div>
                                <div class="zeile">
                                    <span class="text-klein text-sekundaer">Wird im Formular angezeigt</span>
                                </div>
                                <div class="zeile">
                                    <div class="gruppenbild-upload" id="gruppenbildUpload" onclick="triggerGruppenbildUpload()">
                                        <input type="file" id="gruppenbildInput" accept="image/*" style="display: none;" onchange="handleGruppenbildUpload(event)">
                                        <img class="gruppenbild-preview" id="gruppenbildPreview" alt="Gruppenbild">
                                        <div class="gruppenbild-placeholder" id="gruppenbildPlaceholder">
                                            <span class="icon icon--bild"></span>
                                            <span>Klicken zum Hochladen</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="zeile gruppenbild-actions" id="gruppenbildActions" style="display: none;">
                                    <button class="btn btn-sm btn-secondary" onclick="triggerGruppenbildUpload()">Ändern</button>
                                    <button class="btn btn-sm btn-danger" onclick="removeGruppenbild()">Entfernen</button>
                                </div>
                            </div>

                            <!-- SONDIERUNG Provisionen -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Sondierung</div>
                                        <span class="text-klein text-sekundaer">Provisionen für Sondierungsphase</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wgSondierung" checked onchange="toggleSondierung()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div id="sondierungSection">
                                    <div class="zeile zeile--spread">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 1</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="sondJ1" value="80" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 2</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="sondJ2" value="50" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 3</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="sondJ3" value="30" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 4</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="sondJ4" value="0" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 5</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="sondJ5" value="0" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Limit</label>
                                            <input type="number" class="eingabefeld" id="sondLimit" value="100" min="0" onchange="updateSondLimitCalc()">
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-1">
                                            <label class="eingabefeld-beschriftung-oben">Typ</label>
                                            <select class="eingabefeld" id="sondLimitType" onchange="updateSondLimitCalc()">
                                                <option value="mg">MG</option>
                                                <option value="prozent">% Bevölkerung</option>
                                            </select>
                                        </div>
                                        <div class="eingabefeld-gruppe">
                                            <label class="eingabefeld-beschriftung-oben">&nbsp;</label>
                                            <span class="text-klein text-sekundaer" id="sondLimitCalc"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- REGULAR Provisionen -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Regular</div>
                                        <span class="text-klein text-sekundaer">Provisionen nach Sondierung</span>
                                    </div>
                                    <button type="button" class="btn btn-icon open" onclick="toggleCollapse(this, 'regularSection')">
                                        <span class="icon icon--pfeil-unten"></span>
                                    </button>
                                </div>
                                <div id="regularSection">
                                    <div class="zeile zeile--spread">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 1</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="regJ1" value="60" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 2</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="regJ2" value="40" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 3</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="regJ3" value="20" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 4</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="regJ4" value="0" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Jahr 5</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="regJ5" value="0" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Qualitätsbonus -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Qualitätsbonus</div>
                                        <span class="text-klein text-sekundaer">Bonus bei niedriger Stornoquote</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wgQualitaetsbonus" checked onchange="toggleQualiRules()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div id="qualiRulesSection">
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Storno unter</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="qualiStorno1" value="15" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Bonus</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <span class="text-klein--fett">+</span>
                                                <input type="number" class="eingabefeld" id="qualiPP1" value="3" min="0" max="20" onchange="updateQualiMaxBonus()">
                                                <span class="text-normal--fett">PP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="qualiStorno2" value="12" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <span class="text-klein--fett">+</span>
                                                <input type="number" class="eingabefeld" id="qualiPP2" value="3" min="0" max="20" onchange="updateQualiMaxBonus()">
                                                <span class="text-normal--fett">PP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="qualiStorno3" value="10" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <span class="text-klein--fett">+</span>
                                                <input type="number" class="eingabefeld" id="qualiPP3" value="3" min="0" max="20" onchange="updateQualiMaxBonus()">
                                                <span class="text-normal--fett">PP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="qualiStorno4" value="8" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <div class="eingabefeld-mit-einheit">
                                                <span class="text-klein--fett">+</span>
                                                <input type="number" class="eingabefeld" id="qualiPP4" value="1" min="0" max="20" onchange="updateQualiMaxBonus()">
                                                <span class="text-normal--fett">PP</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <span class="text-klein text-sekundaer" id="qualiMaxDisplay">Max. Bonus: +10 PP</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Teilvergütung -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Teilvergütung</div>
                                        <span class="text-klein text-sekundaer">Bei vorzeitigem Storno</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wgTeilverguetung">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div id="teilvSection" style="display: none;">
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-1">
                                            <label class="eingabefeld-beschriftung-oben">% der eingezogenen Beiträge</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="wgTeilvProzent" value="50" min="0" max="100">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Erhöhungen -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Erhöhungen</div>
                                        <span class="text-klein text-sekundaer">Beitragserhöhungen erlaubt</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wgErhohungen" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Zahlungsmodalitäten -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Zahlungsmodalitäten</div>
                                        <span class="text-klein text-sekundaer">Erlaubte Zahlungsweisen</span>
                                    </div>
                                    <button type="button" class="btn btn-icon open" onclick="toggleCollapse(this, 'zahlungsSection')">
                                        <span class="icon icon--pfeil-unten"></span>
                                    </button>
                                </div>
                                <div id="zahlungsSection">
                                    <div class="zeile">
                                        <div class="btn-toggle-group">
                                            <label class="btn btn-sm btn-secondary active" onclick="toggleZahlungsmodalitat(this, 'monthly')">
                                                <input type="checkbox" checked hidden>
                                                Monatlich
                                            </label>
                                            <label class="btn btn-sm btn-secondary active" onclick="toggleZahlungsmodalitat(this, 'quarterly')">
                                                <input type="checkbox" checked hidden>
                                                Quartal
                                            </label>
                                            <label class="btn btn-sm btn-secondary active" onclick="toggleZahlungsmodalitat(this, 'biannual')">
                                                <input type="checkbox" checked hidden>
                                                Halbjährlich
                                            </label>
                                            <label class="btn btn-sm btn-secondary active" onclick="toggleZahlungsmodalitat(this, 'annual')">
                                                <input type="checkbox" checked hidden>
                                                Jährlich
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Abrechnung -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Abrechnung</div>
                                        <span class="text-klein text-sekundaer">Stornopuffer und Endabrechnung</span>
                                    </div>
                                    <button type="button" class="btn btn-icon open" onclick="toggleCollapse(this, 'abrechnungSection')">
                                        <span class="icon icon--pfeil-unten"></span>
                                    </button>
                                </div>
                                <div id="abrechnungSection">
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Stornopuffer</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="wgStornopuffer" value="10" min="0" max="50">
                                                <span class="text-normal--fett">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                            <label class="eingabefeld-beschriftung-oben">Endabr. nach</label>
                                            <div class="eingabefeld-mit-einheit">
                                                <input type="number" class="eingabefeld" id="wgEndabrWochen" value="8" min="1" max="52">
                                                <span>Wochen</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Kostenübernahmen -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Kostenübernahmen</div>
                                        <span class="text-klein text-sekundaer">DRK Verband</span>
                                    </div>
                                    <button type="button" class="btn btn-icon open" onclick="toggleCollapse(this, 'kostenSection')">
                                        <span class="icon icon--pfeil-unten"></span>
                                    </button>
                                </div>
                                <div class="kosten-items" id="kostenSection">
                                    <!-- KFZ -->
                                    <div class="kosten-item">
                                        <div class="zeile eingabefeld-gruppe--mit-aktion">
                                            <span class="text-normal">KFZ</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="wgKostenKfz">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="kfzConfig" style="display: none;">
                                            <div class="zeile">
                                                <div class="eingabefeld-gruppe">
                                                    <label class="eingabefeld-beschriftung-oben">Kostenart</label>
                                                    <select class="eingabefeld" id="wgKfzArt" onchange="toggleKostenartFrei('kfz')">
                                                        <option value="aufwand">Aufwands- & Beschaffungskosten</option>
                                                        <option value="frei">Frei Eintragbar</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-1-5" id="wgKfzArtFreiGruppe" style="display: none;">
                                                    <label class="eingabefeld-beschriftung-oben">Beschreibung</label>
                                                    <input type="text" class="eingabefeld" id="wgKfzArtFrei" placeholder="z.B. Kilometerpauschale">
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Betrag</label>
                                                    <div class="eingabefeld-mit-einheit">
                                                        <input type="number" class="eingabefeld" id="wgKfzBetrag" value="0" min="0" step="1">
                                                        <span class="text-normal--fett">€</span>
                                                    </div>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Zeitraum</label>
                                                    <select class="eingabefeld" id="wgKfzZeitraum">
                                                        <option value="tag">pro Tag</option>
                                                        <option value="woche">pro Woche</option>
                                                        <option value="monat">pro Monat</option>
                                                        <option value="einmalig">einmalig</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Unterkunft -->
                                    <div class="kosten-item">
                                        <div class="zeile eingabefeld-gruppe--mit-aktion">
                                            <span class="text-normal">Unterkunft</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="wgKostenUnterkunft">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="unterkunftConfig" style="display: none;">
                                            <div class="zeile">
                                                <div class="eingabefeld-gruppe">
                                                    <label class="eingabefeld-beschriftung-oben">Kostenart</label>
                                                    <select class="eingabefeld" id="wgUnterkunftArt" onchange="toggleKostenartFrei('unterkunft')">
                                                        <option value="aufwand">Aufwands- & Beschaffungskosten</option>
                                                        <option value="frei">Frei Eintragbar</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-1-5" id="wgUnterkunftArtFreiGruppe" style="display: none;">
                                                    <label class="eingabefeld-beschriftung-oben">Beschreibung</label>
                                                    <input type="text" class="eingabefeld" id="wgUnterkunftArtFrei" placeholder="z.B. Hotelkosten">
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Betrag</label>
                                                    <div class="eingabefeld-mit-einheit">
                                                        <input type="number" class="eingabefeld" id="wgUnterkunftBetrag" value="0" min="0" step="1">
                                                        <span class="text-normal--fett">€</span>
                                                    </div>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Pro</label>
                                                    <select class="eingabefeld" id="wgUnterkunftPro">
                                                        <option value="person">pro Person</option>
                                                        <option value="nacht">pro Nacht</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Zeitraum</label>
                                                    <select class="eingabefeld" id="wgUnterkunftZeitraum">
                                                        <option value="tag">pro Tag</option>
                                                        <option value="woche">pro Woche</option>
                                                        <option value="monat">pro Monat</option>
                                                        <option value="einmalig">einmalig</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Verpflegung -->
                                    <div class="kosten-item">
                                        <div class="zeile eingabefeld-gruppe--mit-aktion">
                                            <span class="text-normal">Verpflegung</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="wgKostenVerpflegung">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="verpflegungConfig" style="display: none;">
                                            <div class="zeile">
                                                <div class="eingabefeld-gruppe">
                                                    <label class="eingabefeld-beschriftung-oben">Kostenart</label>
                                                    <select class="eingabefeld" id="wgVerpflegungArt" onchange="toggleKostenartFrei('verpflegung')">
                                                        <option value="aufwand">Aufwands- & Beschaffungskosten</option>
                                                        <option value="frei">Frei Eintragbar</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-1-5" id="wgVerpflegungArtFreiGruppe" style="display: none;">
                                                    <label class="eingabefeld-beschriftung-oben">Beschreibung</label>
                                                    <input type="text" class="eingabefeld" id="wgVerpflegungArtFrei" placeholder="z.B. Tagessatz">
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Betrag</label>
                                                    <div class="eingabefeld-mit-einheit">
                                                        <input type="number" class="eingabefeld" id="wgVerpflegungBetrag" value="0" min="0" step="1">
                                                        <span class="text-normal--fett">€</span>
                                                    </div>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Pro</label>
                                                    <select class="eingabefeld" id="wgVerpflegungPro">
                                                        <option value="person">pro Person</option>
                                                        <option value="tag">pro Tag</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Zeitraum</label>
                                                    <select class="eingabefeld" id="wgVerpflegungZeitraum">
                                                        <option value="tag">pro Tag</option>
                                                        <option value="woche">pro Woche</option>
                                                        <option value="monat">pro Monat</option>
                                                        <option value="einmalig">einmalig</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Kleidung -->
                                    <div class="kosten-item">
                                        <div class="zeile eingabefeld-gruppe--mit-aktion">
                                            <span class="text-normal">Kleidung</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="wgKostenKleidung">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="kleidungConfig" style="display: none;">
                                            <div class="zeile">
                                                <div class="eingabefeld-gruppe">
                                                    <label class="eingabefeld-beschriftung-oben">Kostenart</label>
                                                    <select class="eingabefeld" id="wgKleidungArt" onchange="toggleKostenartFrei('kleidung')">
                                                        <option value="aufwand">Aufwands- & Beschaffungskosten</option>
                                                        <option value="frei">Frei Eintragbar</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-1-5" id="wgKleidungArtFreiGruppe" style="display: none;">
                                                    <label class="eingabefeld-beschriftung-oben">Beschreibung</label>
                                                    <input type="text" class="eingabefeld" id="wgKleidungArtFrei" placeholder="z.B. T-Shirts">
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Betrag</label>
                                                    <div class="eingabefeld-mit-einheit">
                                                        <input type="number" class="eingabefeld" id="wgKleidungBetrag" value="0" min="0" step="1">
                                                        <span class="text-normal--fett">€</span>
                                                    </div>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Pro</label>
                                                    <select class="eingabefeld" id="wgKleidungPro">
                                                        <option value="person">pro Person</option>
                                                        <option value="stueck">pro Stück</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Zeitraum</label>
                                                    <select class="eingabefeld" id="wgKleidungZeitraum">
                                                        <option value="einmalig">einmalig</option>
                                                        <option value="woche">pro Woche</option>
                                                        <option value="monat">pro Monat</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ausweise -->
                                    <div class="kosten-item">
                                        <div class="zeile eingabefeld-gruppe--mit-aktion">
                                            <span class="text-normal">Ausweise</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="wgKostenAusweise">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="ausweiseConfig" style="display: none;">
                                            <div class="zeile">
                                                <div class="eingabefeld-gruppe">
                                                    <label class="eingabefeld-beschriftung-oben">Kostenart</label>
                                                    <select class="eingabefeld" id="wgAusweiseArt" onchange="toggleKostenartFrei('ausweise')">
                                                        <option value="aufwand">Aufwands- & Beschaffungskosten</option>
                                                        <option value="frei">Frei Eintragbar</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-1-5" id="wgAusweiseArtFreiGruppe" style="display: none;">
                                                    <label class="eingabefeld-beschriftung-oben">Beschreibung</label>
                                                    <input type="text" class="eingabefeld" id="wgAusweiseArtFrei" placeholder="z.B. Dienstausweis">
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Betrag</label>
                                                    <div class="eingabefeld-mit-einheit">
                                                        <input type="number" class="eingabefeld" id="wgAusweiseBetrag" value="0" min="0" step="1">
                                                        <span class="text-normal--fett">€</span>
                                                    </div>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Pro</label>
                                                    <select class="eingabefeld" id="wgAusweisePro">
                                                        <option value="person">pro Person</option>
                                                        <option value="stueck">pro Stück</option>
                                                    </select>
                                                </div>
                                                <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                                                    <label class="eingabefeld-beschriftung-oben">Zeitraum</label>
                                                    <select class="eingabefeld" id="wgAusweiseZeitraum">
                                                        <option value="einmalig">einmalig</option>
                                                        <option value="woche">pro Woche</option>
                                                        <option value="monat">pro Monat</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sonderposten -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Sonderposten</div>
                                        <span class="text-klein text-sekundaer">Zusätzliche Vergütungen</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="wgSonderpostenToggle" onchange="toggleSonderposten()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div id="sonderpostenSection" style="display: none;">
                                    <div id="sonderpostenList">
                                        <!-- Wird dynamisch gefüllt -->
                                    </div>
                                    <div class="zeile">
                                        <div class="anzeigefeld">
                                            <button class="btn btn-sm btn-secondary" id="btnAddSonderposten" onclick="addSonderposten()">
                                                <span class="icon icon--plus"></span>
                                                Sonderposten hinzufügen
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vertrag & AVV -->
                            <div class="unterabschnitt--card">
                                <div class="zeile eingabefeld-gruppe--mit-aktion">
                                    <div>
                                        <div class="text-ueberschrift-unterabschnitt">Verträge</div>
                                        <span class="text-klein text-sekundaer">Rahmenvertrag und AVV</span>
                                    </div>
                                    <button type="button" class="btn btn-icon open" onclick="toggleCollapse(this, 'vertraegeSection')">
                                        <span class="icon icon--pfeil-unten"></span>
                                    </button>
                                </div>
                                <div id="vertraegeSection">
                                    <div class="zeile">
                                        <div class="eingabefeld-gruppe">
                                            <label class="eingabefeld-beschriftung-oben">Rahmenvertrag</label>
                                            <select class="eingabefeld" id="wgRahmenvertrag">
                                                <option value="">Keiner</option>
                                            </select>
                                        </div>
                                        <div class="eingabefeld-gruppe">
                                            <label class="eingabefeld-beschriftung-oben">AVV</label>
                                            <select class="eingabefeld" id="wgAvv">
                                                <option value="">Keiner</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Aus Kampagne entfernen / Bearbeiten -->
                            <div class="unterabschnitt--card">
                                <div class="zeile zeile--spread">
                                    <button class="btn btn-danger" onclick="removeWgFromCampaign()">
                                        <span class="icon icon--loeschen"></span>
                                        Aus Kampagne entfernen
                                    </button>
                                    <button class="btn btn-secondary" id="btnWgEdit" onclick="toggleWgEditMode()">
                                        <span class="icon icon--bearbeiten"></span>
                                        Bearbeiten
                                    </button>
                                </div>
                            </div>

                            <!-- Footer für WG Config -->
                            <div class="page-footer" id="wgConfigFooter">
                                <button class="btn btn-secondary" onclick="cancelWgEdit()">
                                    Abbrechen
                                </button>
                                <button class="btn btn-primary" onclick="saveWgConfig()">
                                    <span class="icon icon--haken"></span>
                                    Speichern
                                </button>
                            </div>
                    </div>

                    <!-- Rechte Seite: Sidebar mit Kunde/WG Auswahl -->
                    <div class="page-content--modal-split-sidebar">
                        <!-- Kunde Auswahl -->
                        <div class="eingabefeld-gruppe">
                            <label class="eingabefeld-beschriftung-oben">Kunde auswählen</label>
                            <select class="eingabefeld" id="wgKundeSelect" onchange="onKundeSelectChange()">
                                <option value="">Bitte wählen...</option>
                                <!-- Wird dynamisch aus Supabase geladen -->
                            </select>
                        </div>

                        <!-- Verfügbare Werbegebiete -->
                        <div class="unterabschnitt--card unterabschnitt--card--no-border" id="wgListSection" style="display: none;">
                            <div class="anzeigenfeld eingabefeld-gruppe--mit-aktion">
                                <div class="text-ueberschrift-unterabschnitt text-primary">Verfügbare Werbegebiete</div>
                            </div>
                            <div id="wgAvailableList">
                                <!-- Wird dynamisch befüllt mit anzeigenfeld--card -->
                            </div>
                        </div>

                        <!-- Ausgewählte Werbegebiete in der Kampagne -->
                        <div class="unterabschnitt--card unterabschnitt--card--no-border" id="wgAllSection" style="display: none;">
                            <div class="anzeigenfeld eingabefeld-gruppe--mit-aktion">
                                <div class="text-ueberschrift-unterabschnitt text-primary">Ausgewählte Werbegebiete</div>
                                <span class="badge-zaehler" id="wgAllCount">0</span>
                            </div>
                            <div id="wgAllList">
                                <!-- Wird dynamisch befüllt mit anzeigenfeld--card -->
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- Ende page-content--modal-split -->
        </div><!-- Ende tab-provision -->
    </div><!-- Ende page-container--modal -->
</div><!-- Ende campaignViewModal -->

<!-- Modal für Kampagnen-Einstellungen -->
<div class="modal modal-s" id="campaignSettingsModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift">Kampagnen-Einstellungen</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeCampaignSettingsModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="einstellungen">Einstellungen</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="page-content page-content--modal">
            <!-- Kampagnenname + Jahr -->
            <div class="zeile">
                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                    <label class="eingabefeld-beschriftung-oben">Kampagnenname</label>
                    <input type="text" class="eingabefeld" id="editCampaignName" disabled>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Jahr</label>
                    <input type="number" class="eingabefeld" id="editCampaignYear" min="2020" max="2099" disabled>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>

            <!-- KW-Bereich -->
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Von KW</label>
                    <input type="number" class="eingabefeld" id="editKwFrom" min="1" max="53" disabled>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Bis KW</label>
                    <input type="number" class="eingabefeld" id="editKwTo" min="1" max="53" disabled>
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer" id="campaignSettingsActions">
            <button id="btnEditCampaignSettings" class="btn btn-secondary" onclick="toggleCampaignEditMode()">Bearbeiten</button>
            <button id="btnCancelCampaignSettings" class="btn btn-secondary" onclick="cancelCampaignEdit()" style="display: none;">Abbrechen</button>
            <button id="btnSaveCampaignSettings" class="btn btn-primary" onclick="saveCampaignSettings()" style="display: none;">Speichern</button>
        </div>
    </div>
</div>

<!-- Modal für neue Kampagne -->
<div class="modal modal-m" id="newCampaignModal">
    <div class="page-container page-container--modal">
        <!-- Modal Header -->
        <div class="page-header">
            <div class="page-header-row">
                <div class="page-header-links">
                    <span class="text-ueberschrift" id="modalTitle">Neue Kampagne</span>
                </div>
                <div class="page-header-mitte"></div>
                <div class="page-header-rechts">
                    <button class="btn btn-icon" onclick="closeCampaignModal()">
                        <span class="icon icon--schliessen"></span>
                    </button>
                </div>
            </div>
            <div class="page-header-tabs">
                <div class="kw-tab active" data-tab="neu">Basis</div>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="page-content page-content--modal">
            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Kampagnenname *</label>
                    <input type="text" class="eingabefeld" id="campaignName" placeholder="z.B. Frühjahrs-Kampagne">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>

            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Jahr *</label>
                    <input type="number" class="eingabefeld" id="campaignYear" placeholder="z.B. 2025" min="2020" max="2100" value="2025">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>

            <div class="zeile">
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Von KW *</label>
                    <input type="number" class="eingabefeld" id="kwFrom" placeholder="z.B. 10" min="1" max="53">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
                <div class="eingabefeld-gruppe">
                    <label class="eingabefeld-beschriftung-oben">Bis KW *</label>
                    <input type="number" class="eingabefeld" id="kwTo" placeholder="z.B. 15" min="1" max="53">
                    <span class="eingabefeld-beschriftung-unten"></span>
                </div>
            </div>

            <div class="zeile">
                <span class="text-klein">Weitere Einstellungen (Einsatzgebiete, Verträge, Mitarbeiter) können nach dem Erstellen in der Kampagnen-Detailansicht konfiguriert werden.</span>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="page-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCampaignModal()">Abbrechen</button>
            <button type="button" class="btn btn-primary" id="saveCampaignBtn" onclick="saveCampaign()">Kampagne erstellen</button>
        </div>
    </div>
</div>

<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <div class="page-header-links">
                <span class="text-ueberschrift">Kampagnen</span>
            </div>
            <div class="page-header-mitte"></div>
            <div class="page-header-rechts"></div>
        </div>
        <!-- Shell-Tab: Übersicht (1 Sub-Tab) -->
        <div class="page-header-tabs" id="uebersichtSubTabs">
            <div class="kw-tab active" data-tab="uebersicht">Übersicht</div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content">
        <!-- Campaign Grid -->
        <div class="campaign-grid" id="campaignGrid">
            <!-- Campaigns will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <span class="icon icon--archiv"></span>
            <h3>Keine Kampagnen gefunden</h3>
            <p class="text-secondary text-sm">Erstellen Sie Ihre erste Kampagne</p>
        </div>
    </div>
</div><!-- Ende page-container -->

<script>
// ============================================
// SUPABASE CLIENT (von Shell holen oder eigenen erstellen)
// ============================================
const SUPABASE_URL = 'https://lgztglycqtiwcmiydxnm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxnenRnbHljcXRpd2NtaXlkeG5tIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzgwNzYxNSwiZXhwIjoyMDc5MzgzNjE1fQ.54kSk9ZSUdQt6LKYWkblqgR6Sjev80W80qkNHYEbPgk';

// Versuche Client vom Parent zu holen, sonst eigenen erstellen
let supabase;
if (window.parent && window.parent.supabaseClient) {
    supabase = window.parent.supabaseClient;
} else {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// ============================================
// showToast und showConfirm kommen aus main.js
// ============================================

// ============================================
// DATA - wird aus Supabase geladen
// ============================================

// Employees/Werber (wird aus Supabase geladen)
let employees = [];

// Campaign storage (wird aus Supabase geladen)
let campaigns = [];

let editingCampaignId = null;

// ============================================
// ANWESENHEITS-TRACKING
// ============================================

// Anwesenheitsdaten: { campaignId: { kw: { memberId: { days: [true x 7], notes: [{timestamp, text}] } } } }
let attendanceData = {};

// Wochentage
const weekDays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

// ============================================
// SUPABASE DATA LOADING
// ============================================

// Rollen-Mapping für Karrierestufen
const ROLE_TO_STUFE = {
    'starting_marketing_advisor': 'SMA',
    'executive_marketing_advisor': 'EMA',
    'junior_marketing_manager': 'JMM',
    'executive_marketing_manager': 'EMM',
    'senior_marketing_manager': 'SMM',
    'chief_executive_marketing_manager': 'CEMM',
    'spitzen_botschafter': 'SPB',
    'kadermanager': 'KAD',
    'führungsebene': 'FUE',
    'sma': 'SMA', 'ema': 'EMA', 'jmm': 'JMM', 'emm': 'EMM',
    'smm': 'SMM', 'cemm': 'CEMM', 'spb': 'SPB', 'kad': 'KAD', 'fue': 'FUE'
};

// Werber/Employees aus Supabase laden
async function loadEmployeesFromSupabase() {
    if (!supabase) {
        console.error('Supabase client nicht verfügbar');
        return [];
    }

    try {
        // Users laden
        const { data: usersData, error: usersError } = await supabase
            .from('users')
            .select('*')
            .order('name', { ascending: true });

        if (usersError) throw usersError;

        // Karrierestufen laden
        const today = new Date().toISOString().split('T')[0];
        const { data: careerData } = await supabase
            .from('user_roles')
            .select('*')
            .eq('role_type', 'career')
            .lte('assigned_at', today)
            .or(`valid_until.gte.${today},valid_until.is.null`);

        return usersData.map(user => {
            const career = careerData?.find(c => c.user_id === user.id);
            const careerName = career?.role_name?.toLowerCase() || '';
            const stufe = ROLE_TO_STUFE[careerName] || 'SMA';

            return {
                id: user.id,
                name: user.name || user.email,
                role: stufe,
                additionalRoles: []
            };
        });
    } catch (error) {
        console.error('Fehler beim Laden der Werber:', error);
        return [];
    }
}

// Kampagnen aus Supabase laden
async function loadCampaignsFromSupabase() {
    if (!supabase) {
        console.error('Supabase client nicht verfügbar');
        return [];
    }

    try {
        // Kampagnen laden
        const { data: campaignsData, error: campaignsError } = await supabase
            .from('campaigns')
            .select('*')
            .order('created_at', { ascending: false });

        if (campaignsError) throw campaignsError;

        // Für jede Kampagne: Areas, Assignments und Challenges laden
        const campaignsWithDetails = await Promise.all(campaignsData.map(async (campaign) => {
            // Campaign Areas laden (mit customer_areas JOIN für customer_id)
            const { data: areasData } = await supabase
                .from('campaign_areas')
                .select('*, customer_areas(customer_id)')
                .eq('campaign_id', campaign.id);

            // Assignments laden
            const { data: assignmentsData } = await supabase
                .from('campaign_assignments')
                .select('*, campaign_assignment_werber(*)')
                .eq('campaign_id', campaign.id);

            // Challenges laden
            const { data: challengesData } = await supabase
                .from('campaign_challenges')
                .select('*')
                .eq('campaign_id', campaign.id);

            // Assignments in das erwartete Format konvertieren
            const assignments = {};
            if (assignmentsData) {
                assignmentsData.forEach(a => {
                    // wgMaZuordnung aus campaign_area_id aufbauen
                    const wgMaZuordnung = {};
                    (a.campaign_assignment_werber || []).forEach(w => {
                        if (w.campaign_area_id) {
                            if (!wgMaZuordnung[w.campaign_area_id]) {
                                wgMaZuordnung[w.campaign_area_id] = [];
                            }
                            wgMaZuordnung[w.campaign_area_id].push(w.werber_id);
                        }
                    });

                    assignments[a.kw] = {
                        teamchef: a.teamchef_id,
                        qualityManager: a.quality_manager_id,
                        werber: a.campaign_assignment_werber?.map(w => w.werber_id) || [],
                        wgMaZuordnung: wgMaZuordnung,
                        challenges: []
                    };
                });
            }

            // Challenges den Assignments zuordnen
            if (challengesData) {
                challengesData.forEach(c => {
                    if (assignments[c.kw]) {
                        assignments[c.kw].challenges.push({
                            id: c.id,
                            type: c.challenge_type,
                            ziel: c.ziel,
                            belohnung: c.belohnung,
                            completed: c.completed,
                            createdAt: c.created_at
                        });
                    }
                });
            }

            // Einsatzgebiete in das erwartete Format konvertieren
            const einsatzgebiete = (areasData || []).map(area => ({
                id: area.id,
                customer_area_id: area.customer_area_id,
                kunde: area.customer_areas?.customer_id || null,
                name: area.name,
                plz: area.plz,
                einwohner: area.einwohner || 0,
                rahmenvertrag: area.rahmenvertrag_name,
                avv: area.avv_url,
                gruppenbild: area.gruppenbild_url,
                // Erweiterte Felder
                provision_sondierung: area.provision_sondierung,
                provision_regular: area.provision_regular,
                qualitaetsbonus: area.qualitaetsbonus,
                teilverguetung: area.teilverguetung,
                teilv_prozent: area.teilv_prozent,
                stornopuffer: area.stornopuffer,
                endabr_wochen: area.endabr_wochen,
                kosten: area.kosten,
                sonderposten: area.sonderposten,
                active_kws: area.active_kws,
                // Formular-Einstellungen
                erhohungen: area.erhohungen_enabled !== false, // Default true
                paymentModalities: area.payment_modalities || ['monthly', 'quarterly', 'biannual', 'annual']
            }));

            return {
                id: campaign.id,
                name: campaign.name,
                year: campaign.year || new Date().getFullYear(),
                kwFrom: campaign.kw_from || 1,
                kwTo: campaign.kw_to || 52,
                customer_id: campaign.customer_id,
                pufferPercent: campaign.puffer_percent || 10,
                wartezeitWochen: campaign.wartezeit_wochen || 4,
                einsatzgebiete: einsatzgebiete,
                assignments: assignments
            };
        }));

        return campaignsWithDetails;
    } catch (error) {
        console.error('Fehler beim Laden der Kampagnen:', error);
        return [];
    }
}

// Anwesenheitsdaten aus Supabase laden
async function loadAttendanceFromSupabase(campaignId) {
    if (!supabase) return;

    try {
        const { data, error } = await supabase
            .from('campaign_attendance')
            .select('*, campaign_attendance_notes(*)')
            .eq('campaign_id', campaignId);

        if (error) throw error;

        // In lokales Format konvertieren
        if (!attendanceData[campaignId]) attendanceData[campaignId] = {};

        data?.forEach(record => {
            if (!attendanceData[campaignId][record.kw]) {
                attendanceData[campaignId][record.kw] = {};
            }
            attendanceData[campaignId][record.kw][record.user_id] = {
                id: record.id,
                days: [record.day_0, record.day_1, record.day_2, record.day_3, record.day_4, record.day_5, record.day_6],
                notes: (record.campaign_attendance_notes || []).map(n => ({
                    id: n.id,
                    timestamp: new Date(n.created_at).toLocaleString('de-DE'),
                    text: n.note_text
                }))
            };
        });
    } catch (error) {
        console.error('Fehler beim Laden der Anwesenheit:', error);
    }
}

// Alle Daten initial laden
async function loadAllData() {
    console.log('Lade Daten aus Supabase...');

    // Parallel laden
    const [loadedEmployees, loadedCampaigns] = await Promise.all([
        loadEmployeesFromSupabase(),
        loadCampaignsFromSupabase(),
        loadKundenForSelect()
    ]);

    employees = loadedEmployees;
    campaigns = loadedCampaigns;

    console.log(`Geladen: ${employees.length} Werber, ${campaigns.length} Kampagnen`);

    // UI aktualisieren
    renderCampaigns();
}

// Anwesenheit initialisieren für einen Mitarbeiter in einer KW
function initAttendance(campaignId, kw, memberId) {
    if (!attendanceData[campaignId]) attendanceData[campaignId] = {};
    if (!attendanceData[campaignId][kw]) attendanceData[campaignId][kw] = {};
    if (!attendanceData[campaignId][kw][memberId]) {
        attendanceData[campaignId][kw][memberId] = {
            days: [true, true, true, true, true, true, true], // Standard: alle anwesend
            notes: []
        };
    }
    return attendanceData[campaignId][kw][memberId];
}

// Anwesenheit für einen Tag togglen
async function toggleAttendance(campaignId, kw, memberId, dayIndex) {
    const data = initAttendance(campaignId, kw, memberId);
    data.days[dayIndex] = !data.days[dayIndex];

    // UI aktualisieren
    const btn = document.querySelector(`[data-attendance="${campaignId}-${kw}-${memberId}-${dayIndex}"]`);
    if (btn) {
        btn.classList.toggle('present', data.days[dayIndex]);
        btn.classList.toggle('absent', !data.days[dayIndex]);
    }

    // In Supabase speichern
    try {
        const dayColumn = `day_${dayIndex}`;

        // Prüfen ob Record existiert
        if (data.id) {
            // Update
            const { error: updateError } = await supabase
                .from('campaign_attendance')
                .update({ [dayColumn]: data.days[dayIndex] })
                .eq('id', data.id);

            if (updateError) {
                console.error('Fehler beim Update der Anwesenheit:', updateError);
                showToast('Fehler beim Speichern', 'error');
            }
        } else {
            // Insert
            const insertData = {
                campaign_id: campaignId,
                user_id: memberId,
                kw: kw,
                day_0: data.days[0],
                day_1: data.days[1],
                day_2: data.days[2],
                day_3: data.days[3],
                day_4: data.days[4],
                day_5: data.days[5],
                day_6: data.days[6]
            };

            console.log('Speichere Anwesenheit:', insertData);

            const { data: newRecord, error } = await supabase
                .from('campaign_attendance')
                .upsert(insertData, { onConflict: 'campaign_id,user_id,kw' })
                .select()
                .single();

            if (error) {
                console.error('Fehler beim Insert der Anwesenheit:', error);
                showToast('Fehler beim Speichern: ' + error.message, 'error');
            } else if (newRecord) {
                console.log('Anwesenheit gespeichert:', newRecord);
                data.id = newRecord.id;
            }
        }
    } catch (error) {
        console.error('Fehler beim Speichern der Anwesenheit:', error);
        showToast('Fehler beim Speichern', 'error');
    }
}

// Notizen-Modal öffnen
function openNotesModal(campaignId, kw, memberId, memberName) {
    const data = initAttendance(campaignId, kw, memberId);
    const modal = document.getElementById('attendanceNotesModal');

    // Modal-Daten setzen
    modal.dataset.campaignId = campaignId;
    modal.dataset.kw = kw;
    modal.dataset.memberId = memberId;

    // Header aktualisieren
    document.getElementById('notesModalMemberName').textContent = memberName;
    document.getElementById('notesModalKw').textContent = `KW ${kw}`;

    // Notizen rendern
    renderNotesList(data.notes);

    // Textarea leeren
    document.getElementById('notesModalTextarea').value = '';

    // Modal anzeigen
    modal.classList.add('active');
}

// Notizen-Modal schließen
function closeNotesModal() {
    const modal = document.getElementById('attendanceNotesModal');
    modal.classList.remove('active');
}

// Notizen-Liste rendern
function renderNotesList(notes) {
    const list = document.getElementById('notesModalList');

    if (notes.length === 0) {
        list.innerHTML = '<div class="attendance-notes-empty">Keine Notizen vorhanden</div>';
        return;
    }

    list.innerHTML = notes.map(note => `
        <div class="attendance-note-item">
            <div class="attendance-note-timestamp">${note.timestamp}</div>
            <div class="attendance-note-text">${escapeHtml(note.text)}</div>
        </div>
    `).join('');

    // Scroll nach unten
    list.scrollTop = list.scrollHeight;
}

// Notiz speichern
async function saveNote() {
    const modal = document.getElementById('attendanceNotesModal');
    const textarea = document.getElementById('notesModalTextarea');
    const text = textarea.value.trim();

    if (!text) {
        showToast('Bitte gib eine Notiz ein', 'warning');
        return;
    }

    const campaignId = modal.dataset.campaignId;
    const kw = parseInt(modal.dataset.kw);
    const memberId = modal.dataset.memberId;

    const data = initAttendance(campaignId, kw, memberId);

    // Timestamp formatieren
    const now = new Date();
    const timestamp = now.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    try {
        // Erst sicherstellen, dass Attendance-Record existiert
        if (!data.id) {
            const insertData = {
                campaign_id: campaignId,
                user_id: memberId,
                kw: kw,
                day_0: data.days[0],
                day_1: data.days[1],
                day_2: data.days[2],
                day_3: data.days[3],
                day_4: data.days[4],
                day_5: data.days[5],
                day_6: data.days[6]
            };

            const { data: newRecord, error } = await supabase
                .from('campaign_attendance')
                .upsert(insertData, { onConflict: 'campaign_id,user_id,kw' })
                .select()
                .single();

            if (error) throw error;
            data.id = newRecord.id;
        }

        // Notiz in Supabase speichern
        const { data: noteData, error: noteError } = await supabase
            .from('campaign_attendance_notes')
            .insert({
                attendance_id: data.id,
                note_text: text
            })
            .select()
            .single();

        if (noteError) throw noteError;

        // Notiz lokal hinzufügen
        data.notes.push({ id: noteData.id, timestamp, text });

        // UI aktualisieren
        renderNotesList(data.notes);
        textarea.value = '';

        // Notizen-Button aktualisieren (has-notes Klasse)
        const notesBtn = document.querySelector(`[data-notes="${campaignId}-${kw}-${memberId}"]`);
        if (notesBtn) {
            notesBtn.classList.add('has-notes');
        }

        showToast('Notiz gespeichert', 'success');

    } catch (error) {
        console.error('Fehler beim Speichern der Notiz:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// escapeHtml kommt aus main.js

// Anwesenheits-HTML für einen Mitarbeiter generieren
function renderAttendanceTracker(campaignId, kw, memberId, memberName) {
    const data = initAttendance(campaignId, kw, memberId);
    const hasNotes = data.notes.length > 0;

    return `
        <div class="kw-attendance-container">
            <div class="btn-toggle-group">
                ${weekDays.map((day, i) => `
                    <button
                        class="btn btn-toggle ${data.days[i] ? 'present' : 'absent'}"
                        data-attendance="${campaignId}-${kw}-${memberId}-${i}"
                        onclick="toggleAttendance('${campaignId}', ${kw}, '${memberId}', ${i})"
                        title="${day}: ${data.days[i] ? 'Anwesend' : 'Abwesend'}"
                    >${day}</button>
                `).join('')}
            </div>
            <button
                class="btn btn-sm btn-notes ${hasNotes ? 'has-notes' : ''}"
                data-notes="${campaignId}-${kw}-${memberId}"
                onclick="openNotesModal('${campaignId}', ${kw}, '${memberId}', '${memberName.replace(/'/g, "\\'")}')"
                title="Notizen ${hasNotes ? '(' + data.notes.length + ')' : ''}"
            >
                <span class="icon icon--stift"></span>
            </button>
        </div>
    `;
}

// getCurrentWeek kommt aus main.js

// getCampaignStatus kommt aus main.js

// Render campaigns
function renderCampaigns() {
    const grid = document.getElementById('campaignGrid');
    const emptyState = document.getElementById('emptyState');

    let filteredCampaigns = campaigns;

    if (filteredCampaigns.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    grid.style.display = 'grid';
    emptyState.style.display = 'none';

    grid.innerHTML = filteredCampaigns.map(campaign => {
        const status = getCampaignStatus(campaign.kwFrom, campaign.kwTo);
        const statusLabels = {
            active: 'Aktiv',
            planned: 'Geplant',
            inactive: 'Inaktiv'
        };
        const statusPillClass = {
            active: 'pill--success',
            planned: 'pill--werbegebiet',
            inactive: 'pill--inaktiv'
        };
        const statusIcon = {
            active: '',
            planned: '<span class="icon icon--uhr"></span>&nbsp;&nbsp;-&nbsp;&nbsp;',
            inactive: '<span class="icon icon--archiv"></span>&nbsp;&nbsp;-&nbsp;&nbsp;'
        };

        // Calculate date range from KW
        const year = campaign.year || 2025;
        const startDate = getKWDateRange(campaign.kwFrom, year).split(' - ')[0];
        const endDate = getKWDateRange(campaign.kwTo, year).split(' - ')[1];

        // Calculate number of weeks
        const weekCount = campaign.kwTo - campaign.kwFrom + 1;

        // Get Einsatzgebiete data
        const einsatzgebiete = campaign.einsatzgebiete || [];
        const einsatzgebieteCount = einsatzgebiete.length;

        // Calculate total Einwohner
        const totalEinwohner = einsatzgebiete.reduce((sum, eg) => sum + (eg.einwohner || 0), 0);
        const einwohnerPerKW = weekCount > 0 ? Math.round(totalEinwohner / weekCount) : 0;
        const einwohnerFormatted = totalEinwohner.toLocaleString('de-DE');
        const einwohnerPerKWFormatted = einwohnerPerKW.toLocaleString('de-DE');

        // Check contract status - green if all Einsatzgebiete have contracts, yellow if some missing
        const einsatzgebieteWithContract = einsatzgebiete.filter(eg => eg.rahmenvertrag || eg.contract).length;
        const allHaveContracts = einsatzgebieteCount > 0 && einsatzgebieteWithContract === einsatzgebieteCount;
        const someHaveContracts = einsatzgebieteWithContract > 0 && einsatzgebieteWithContract < einsatzgebieteCount;

        // Build KW timeline
        const currentWeek = getCurrentWeek();
        let kwTimelineHTML = '<div class="anzeigenfeld anzeigenfeld--wrap">';
        for (let kw = campaign.kwFrom; kw <= campaign.kwTo; kw++) {
            const assignment = campaign.assignments[kw] || {};
            const personCount = (assignment.werber?.length || 0) + (assignment.teamchef ? 1 : 0);
            const isCurrent = kw === currentWeek;
            const isEmpty = personCount === 0;
            kwTimelineHTML += `
                <div class="kw-timeline-item ${isCurrent ? 'kw-current' : ''} ${isEmpty ? 'kw-empty' : ''}">
                    <span class="kw-num text-klein--fett">KW ${kw}</span>
                    <span class="kw-count text-klein--fett">${personCount}P</span>
                </div>
            `;
        }
        kwTimelineHTML += '</div>';

        // Contract status badge
        let contractStatusHTML = '';
        if (einsatzgebieteCount > 0) {
            if (allHaveContracts) {
                contractStatusHTML = `
                    <span class="pill pill--success">
                        <span class="icon icon--haken"></span>&nbsp;&nbsp;-&nbsp;&nbsp;Verträge
                    </span>
                `;
            } else {
                contractStatusHTML = `
                    <span class="pill pill--warning">
                        <span class="icon icon--warnung"></span>&nbsp;&nbsp;-&nbsp;&nbsp;${einsatzgebieteWithContract}/${einsatzgebieteCount} Verträge
                    </span>
                `;
            }
        }

        // Kampagne-Badge für Übersicht
        const kampagneInitials = getInitials(campaign.name);

        return `
            <div class="campaign-card status-${status}" onclick="viewCampaign('${campaign.id}')">
                <div class="anzeigenfeld">
                    <div class="user-badge user-badge--kampagne user-badge--large">
                        <div class="user-badge__avatar">${kampagneInitials}</div>
                        <div class="user-badge__info">
                            <span class="user-badge__name">${campaign.name}</span>
                            <span class="user-badge__type">Kampagne</span>
                        </div>
                    </div>
                </div>
                <div class="anzeigenfeld">
                    <span class="text-klein--fett text-secondary">${startDate} - ${endDate} (KW ${campaign.kwFrom}-${campaign.kwTo}) · ${weekCount} W.</span>
                </div>
                <div class="anzeigenfeld">
                    <span class="pill ${statusPillClass[status]}">${statusIcon[status]}${statusLabels[status]}</span>
                    ${contractStatusHTML}
                </div>

                <div class="campaign-content">
                    <div class="anzeigenfeld anzeigenfeld--col">
                        <span class="text-normal--fett">Einwohner: ${einwohnerFormatted} ${totalEinwohner > 0 ? `(${einwohnerPerKWFormatted}/KW)` : ''}</span>
                        <span class="text-normal--fett">Einsatzgebiete: ${einsatzgebieteCount}</span>
                    </div>

                    <div class="campaign-kw-area">
                        ${kwTimelineHTML}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Open modal
function openCampaignModal() {
    editingCampaignId = null;
    document.getElementById('modalTitle').textContent = 'Neue Kampagne';
    openModalById('newCampaignModal');
    document.getElementById('campaignName').value = '';
    document.getElementById('campaignYear').value = new Date().getFullYear();
    document.getElementById('kwFrom').value = '';
    document.getElementById('kwTo').value = '';
}

// Close modal
function closeCampaignModal() {
    closeModalById('newCampaignModal');
}

// ============================================
// VIEW MODAL FUNCTIONS (ERWEITERT)
// ============================================

let viewingCampaignId = null;
let isEditMode = false;

// TC Dienste Konfiguration (kampagnenspezifisch)
const TC_DIENSTE = [
    { id: 'muell', name: 'Müll' },
    { id: 'motivation', name: 'Motivation' },
    { id: 'gebiet', name: 'Gebiet' },
    { id: 'einkauf', name: 'Einkauf' },
    { id: 'sonstige', name: 'Sonstige' }
];

// Stufen-Label generieren (kampagnenspezifisch, verwendet zentrale STUFEN_CONFIG)
function getStufeLabel(stufe, showFull = false) {
    const config = STUFEN_CONFIG[stufe?.toUpperCase()] || STUFEN_CONFIG.SMA;
    const text = showFull ? config.name : stufe?.toUpperCase() || 'SMA';
    return `<span class="stufen-label stufen-label-${config.class}">${text}</span>`;
}

// Alle Badge-Funktionen (getInitials, getBadgeSymbolSVG, getBadgeTypeRow, getStufeBadge, createWerberBadge)
// werden aus ../js/badge-system.js importiert

// Tab-Initialisierung für campaignViewModal (nutzt zentrale initTabs aus main.js)
initTabs('#campaignViewTabs .kw-tab', '.kw-tab-content');

// Aktuelle KW ermitteln
function getCurrentKW() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const diff = now - start;
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    return Math.ceil(((diff / oneWeek) + start.getDay() + 1) / 7);
}

// Open view modal (ERWEITERT)
async function viewCampaign(id) {
    const campaign = campaigns.find(c => c.id === id);
    if (!campaign) return;

    viewingCampaignId = id;

    // Kampagnen-Name im Header
    document.getElementById('campaignViewName').textContent = campaign.name;

    // Anwesenheitsdaten aus Supabase laden
    await loadAttendanceFromSupabase(id);

    // KW Details (erweitert)
    renderKWDetails(campaign);

    // Letzte Schriebe
    renderLastSchriebe(campaign);

    // Werbegebiete für Provision-Tab initialisieren
    initCampaignWerbegebiete(campaign);

    openModalById('campaignViewModal');
}

// Werbegebiete aus einsatzgebiete für den Provision-Tab initialisieren
function initCampaignWerbegebiete(campaign) {
    const einsatzgebiete = campaign.einsatzgebiete || [];

    // Reset
    campaignWerbegebiete = [];
    activeWgConfig = null;
    selectedWgKunde = null;

    // Konfiguration-Panel zurücksetzen
    document.getElementById('wgConfigPlaceholder').style.display = 'flex';
    document.getElementById('wgConfigPanel').style.display = 'none';

    // Kunden-Dropdown zurücksetzen
    const kundeSelect = document.getElementById('wgKundeSelect');
    if (kundeSelect) kundeSelect.value = '';
    document.getElementById('wgListSection').style.display = 'none';

    // Default KWs für die Kampagne
    const defaultKws = [];
    for (let kw = campaign.kwFrom; kw <= campaign.kwTo; kw++) {
        defaultKws.push(kw);
    }

    // Einsatzgebiete in campaignWerbegebiete Format konvertieren
    einsatzgebiete.forEach(eg => {
        // Sondierung aus DB oder Defaults
        const sondierung = eg.provision_sondierung || { j1: 80, j2: 50, j3: 30, j4: 0, j5: 0, limit: 100, limitType: 'mg' };

        // Regular aus DB oder Defaults
        const regular = eg.provision_regular || { j1: 60, j2: 40, j3: 20, j4: 0, j5: 0 };

        // Qualitätsbonus aus DB oder Defaults
        const qualitaetsbonus = eg.qualitaetsbonus || {
            aktiv: true,
            regeln: [
                { storno: 15, pp: 3 },
                { storno: 12, pp: 3 },
                { storno: 10, pp: 3 },
                { storno: 8, pp: 1 }
            ]
        };

        // KWs aus DB oder alle KWs der Kampagne
        const kws = eg.active_kws && eg.active_kws.length > 0 ? eg.active_kws : [...defaultKws];

        const wgConfig = {
            id: eg.id,
            customer_area_id: eg.customer_area_id,
            name: eg.name,
            plz: eg.plz,
            einwohner: eg.einwohner || 0,
            kunde: eg.kunde,
            kundeName: eg.kunde ? getKundeName(eg.kunde) : '',
            kws: kws,
            sondierung: sondierung,
            regular: regular,
            qualitaetsbonus: qualitaetsbonus,
            teilverguetung: eg.teilverguetung || false,
            teilvProzent: eg.teilv_prozent || 50,
            stornopuffer: eg.stornopuffer || 10,
            endabrWochen: eg.endabr_wochen || 8,
            kosten: eg.kosten || {
                kfz: { aktiv: false, art: 'aufwand', betrag: '', zeitraum: 'woche' },
                kleidung: { aktiv: false, art: 'aufwand', betrag: '', pro: 'person', zeitraum: 'woche' },
                ausweise: { aktiv: false, art: 'aufwand', betrag: '', pro: 'person', zeitraum: 'woche' }
            },
            gruppenbild: eg.gruppenbild || null,
            sonderposten: eg.sonderposten || [],
            rahmenvertrag: eg.rahmenvertrag || '',
            avv: eg.avv || '',
            erhohungen: eg.erhohungen !== false,
            paymentModalities: eg.paymentModalities || ['monthly', 'quarterly', 'biannual', 'annual']
        };

        campaignWerbegebiete.push(wgConfig);
    });

    // Alle Werbegebiete anzeigen
    renderAllCampaignWerbegebiete();

    console.log(`${campaignWerbegebiete.length} Werbegebiete für Kampagne initialisiert`);
}

// Alle Werbegebiete der Kampagne anzeigen (gruppiert nach Kunde)
function renderAllCampaignWerbegebiete() {
    const section = document.getElementById('wgAllSection');
    const container = document.getElementById('wgAllList');
    const countBadge = document.getElementById('wgAllCount');

    if (campaignWerbegebiete.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    countBadge.textContent = campaignWerbegebiete.length;

    // Nach Kunde gruppieren
    const kundenMap = {};
    campaignWerbegebiete.forEach(wg => {
        const kundeId = wg.kunde || 'unbekannt';
        const kundeName = wg.kundeName || 'Unbekannt';
        if (!kundenMap[kundeId]) {
            kundenMap[kundeId] = { name: kundeName, wgs: [] };
        }
        kundenMap[kundeId].wgs.push(wg);
    });

    let html = '';
    Object.entries(kundenMap).forEach(([kundeId, data]) => {
        // Kunde Header
        html += `<div class="eingabefeld-beschriftung-oben" style="margin-top: var(--spacing-md); margin-bottom: var(--spacing-xs);">${data.name}</div>`;

        // WGs des Kunden
        data.wgs.forEach(wg => {
            const wgInitials = getInitials(wg.name);
            const isActive = activeWgConfig === wg.id;

            html += `
                <div class="anzeigenfeld anzeigenfeld--card ${isActive ? 'active' : ''}">
                    <div class="anzeigenfeld--card-main" onclick="openWgConfig('${wg.id}')">
                        <div class="user-badge user-badge--werbegebiet user-badge--small">
                            <div class="user-badge__avatar">${wgInitials}</div>
                            <div class="user-badge__info">
                                <span class="user-badge__name">${wg.name}</span>
                                <span class="user-badge__type">Werbegebiet</span>
                            </div>
                        </div>
                    </div>
                    <div class="anzeigenfeld--card-actions">
                        <button class="btn btn-sm btn--hover-blau" onclick="event.stopPropagation(); openFormularLink('${wg.id}')" title="Formular öffnen">
                            <span class="icon icon--dokument"></span>
                        </button>
                        <button class="btn btn-sm btn--hover-blau" onclick="event.stopPropagation(); copyFormularLink('${wg.id}')" title="Link kopieren">
                            <span class="icon icon--clipboard"></span>
                        </button>
                    </div>
                </div>
            `;
        });
    });

    container.innerHTML = html;
}

// Settings Modal öffnen
function openCampaignSettingsModal() {
    if (!viewingCampaignId) return;
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    populateCampaignSettings(campaign);
    openModalById('campaignSettingsModal');
}

// Settings Modal schließen
function closeCampaignSettingsModal() {
    cancelCampaignEdit();
    closeModalById('campaignSettingsModal');
}

// Kampagnen-Einstellungen im Modal befüllen
function populateCampaignSettings(campaign) {
    document.getElementById('editCampaignName').value = campaign.name || '';
    document.getElementById('editKwFrom').value = campaign.kwFrom || '';
    document.getElementById('editKwTo').value = campaign.kwTo || '';

    // Jahr
    const year = campaign.year || new Date().getFullYear();
    document.getElementById('editCampaignYear').value = year;

    // Edit-Modus zurücksetzen
    campaignEditMode = false;
    const inputs = document.querySelectorAll('#campaignSettingsGrid .setting-input');
    const btnEdit = document.getElementById('btnEditCampaignSettings');
    const btnSave = document.getElementById('btnSaveCampaignSettings');
    const btnCancel = document.getElementById('btnCancelCampaignSettings');

    inputs.forEach(input => input.disabled = true);
    if (btnEdit) btnEdit.style.display = 'inline-flex';
    if (btnSave) btnSave.style.display = 'none';
    if (btnCancel) btnCancel.style.display = 'none';
}

// Customer Dropdown Toggle
function toggleCustomerDropdown() {
    const dropdown = document.getElementById('customerDropdown');
    const trigger = dropdown?.querySelector('.customer-dropdown-trigger');
    if (trigger?.classList.contains('disabled')) return;
    dropdown?.classList.toggle('open');
}

// Customer Selection Toggle
function toggleCustomerSelection(value) {
    const item = document.querySelector(`.customer-dropdown-item[data-value="${value}"]`);
    if (item) {
        item.classList.toggle('selected');
        updateCustomerPreview();
    }
}

// Update Customer Preview
function updateCustomerPreview() {
    const preview = document.getElementById('selectedCustomersPreview');
    const selected = document.querySelectorAll('.customer-dropdown-item.selected');

    const shortNames = {
        'drk': 'DRK',
        'unicef': 'UNICEF',
        'wwf': 'WWF',
        'greenpeace': 'Greenpeace',
        'aerzte': 'Ärzte o.G.'
    };

    if (selected.length === 0) {
        preview.innerHTML = '<span class="text-sekundaer">Kunde auswählen...</span>';
    } else {
        preview.innerHTML = Array.from(selected).map(item => {
            const value = item.dataset.value;
            return `<span class="selected-customer-tag">${shortNames[value] || value}</span>`;
        }).join('');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('customerDropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// Edit-Modus State
let campaignEditMode = false;

// Edit-Modus umschalten
function toggleCampaignEditMode() {
    campaignEditMode = !campaignEditMode;

    const inputs = document.querySelectorAll('#campaignSettingsModal .eingabefeld');
    const btnEdit = document.getElementById('btnEditCampaignSettings');
    const btnSave = document.getElementById('btnSaveCampaignSettings');
    const btnCancel = document.getElementById('btnCancelCampaignSettings');

    if (campaignEditMode) {
        // Edit-Modus aktivieren
        inputs.forEach(input => input.disabled = false);
        if (btnEdit) btnEdit.style.display = 'none';
        if (btnSave) btnSave.style.display = 'inline-flex';
        if (btnCancel) btnCancel.style.display = 'inline-flex';
    } else {
        // Edit-Modus deaktivieren
        inputs.forEach(input => input.disabled = true);
        if (btnEdit) btnEdit.style.display = 'inline-flex';
        if (btnSave) btnSave.style.display = 'none';
        if (btnCancel) btnCancel.style.display = 'none';
    }
}

// Bearbeitung abbrechen
function cancelCampaignEdit() {
    campaignEditMode = false;

    const inputs = document.querySelectorAll('#campaignSettingsModal .eingabefeld');
    const btnEdit = document.getElementById('btnEditCampaignSettings');
    const btnSave = document.getElementById('btnSaveCampaignSettings');
    const btnCancel = document.getElementById('btnCancelCampaignSettings');

    inputs.forEach(input => input.disabled = true);
    if (btnEdit) btnEdit.style.display = 'inline-flex';
    if (btnSave) btnSave.style.display = 'none';
    if (btnCancel) btnCancel.style.display = 'none';

    // Werte zurücksetzen auf aktuelle Kampagne
    if (viewingCampaignId) {
        const campaign = campaigns.find(c => c.id === viewingCampaignId);
        if (campaign) {
            document.getElementById('editCampaignName').value = campaign.name || '';
            document.getElementById('editKwFrom').value = campaign.kwFrom || '';
            document.getElementById('editKwTo').value = campaign.kwTo || '';
            document.getElementById('editCampaignYear').value = campaign.year || new Date().getFullYear();
        }
    }
}

// Einstellungen speichern
async function saveCampaignSettings() {
    if (!viewingCampaignId) return;

    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    // Werte aus Feldern lesen
    const newName = document.getElementById('editCampaignName').value.trim();
    const newKwFrom = parseInt(document.getElementById('editKwFrom').value);
    const newKwTo = parseInt(document.getElementById('editKwTo').value);
    const newYear = parseInt(document.getElementById('editCampaignYear').value);

    // Validierung
    if (!newName) {
        showToast('Bitte Kampagnenname eingeben', 'warning');
        return;
    }
    if (newKwFrom > newKwTo) {
        showToast('Von-KW muss kleiner als Bis-KW sein', 'warning');
        return;
    }

    // Start- und Enddatum aus KW berechnen
    function getDateFromKW(kw, year) {
        const jan4 = new Date(year, 0, 4);
        const dayOfWeek = jan4.getDay() || 7;
        const firstMonday = new Date(jan4);
        firstMonday.setDate(jan4.getDate() - dayOfWeek + 1);
        const targetDate = new Date(firstMonday);
        targetDate.setDate(firstMonday.getDate() + (kw - 1) * 7);
        return targetDate.toISOString().split('T')[0];
    }

    const startDate = getDateFromKW(newKwFrom, newYear);
    const endDateObj = new Date(getDateFromKW(newKwTo, newYear));
    endDateObj.setDate(endDateObj.getDate() + 6);
    const endDate = endDateObj.toISOString().split('T')[0];

    // In Supabase speichern
    try {
        const { error } = await supabase
            .from('campaigns')
            .update({
                name: newName,
                year: newYear,
                kw_from: newKwFrom,
                kw_to: newKwTo,
                start_date: startDate,
                end_date: endDate
            })
            .eq('id', viewingCampaignId);

        if (error) throw error;

        // Lokale Daten aktualisieren
        campaign.name = newName;
        campaign.kwFrom = newKwFrom;
        campaign.kwTo = newKwTo;
        campaign.year = newYear;

        // Grid in Kampagnen-Übersicht aktualisieren
        renderCampaignGrid();

        // Edit-Modus beenden
        toggleCampaignEditMode();

        showToast('Kampagnen-Einstellungen gespeichert', 'success');

    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// ===================== WERBEGEBIETE & PROVISIONEN TAB =====================

// Kunden aus Supabase
let kundenListe = [];

// Werbegebiete pro Kunde - werden aus Supabase geladen (customer_areas)
const kundenWerbegebiete = {};

// Verträge pro Kunde - werden aus Supabase geladen (customer_contracts)
const kundenVertraege = {};

// State für WG Tab
let selectedWgKunde = null;
let campaignWerbegebiete = []; // WGs die zur Kampagne hinzugefügt wurden
let activeWgConfig = null; // Aktuell ausgewähltes WG zur Konfiguration
let wgSonderposten = []; // Sonderposten für das aktuelle WG
let wgEditMode = false; // Edit-Modus für WG Konfiguration

// Kunden aus Supabase laden und Select befüllen
async function loadKundenForSelect() {
    try {
        const { data: customers, error } = await supabase
            .from('customers')
            .select('id, name, organisation, name_prefix, name_suffix')
            .order('name', { ascending: true });

        if (error) throw error;

        kundenListe = customers || [];

        // Select befüllen
        const select = document.getElementById('wgKundeSelect');
        if (!select) return;

        // Bestehende Optionen (außer Placeholder) entfernen
        while (select.options.length > 1) {
            select.remove(1);
        }

        // Kunden hinzufügen
        kundenListe.forEach(kunde => {
            const option = document.createElement('option');
            option.value = kunde.id;
            // Name zusammensetzen
            const fullName = [kunde.organisation, kunde.name_prefix, kunde.name, kunde.name_suffix]
                .filter(Boolean)
                .join(' ')
                .trim();
            option.textContent = fullName || kunde.name || 'Unbenannt';
            select.appendChild(option);
        });

        console.log(`${kundenListe.length} Kunden geladen`);

    } catch (error) {
        console.error('Fehler beim Laden der Kunden:', error);
    }
}

// Werbegebiete für Kunde aus Supabase laden
async function loadWerbegebieteForKunde(kundeId) {
    if (kundenWerbegebiete[kundeId]) {
        // Bereits geladen
        return kundenWerbegebiete[kundeId];
    }

    try {
        const { data: areas, error } = await supabase
            .from('customer_areas')
            .select('*')
            .eq('customer_id', kundeId)
            .order('name', { ascending: true });

        if (error) throw error;

        // In Cache speichern
        kundenWerbegebiete[kundeId] = (areas || []).map(area => ({
            id: area.id,
            name: area.name,
            plz: area.plz,
            einwohner: area.einwohner || 0
        }));

        console.log(`${kundenWerbegebiete[kundeId].length} Werbegebiete für Kunde ${kundeId} geladen`);

        return kundenWerbegebiete[kundeId];

    } catch (error) {
        console.error('Fehler beim Laden der Werbegebiete:', error);
        return [];
    }
}

// Kunde auswählen
async function onKundeSelectChange() {
    const select = document.getElementById('wgKundeSelect');
    selectedWgKunde = select.value;

    if (selectedWgKunde) {
        // Werbegebiete laden
        await loadWerbegebieteForKunde(selectedWgKunde);

        document.getElementById('wgListSection').style.display = 'block';
        renderAvailableWerbegebiete();
    } else {
        document.getElementById('wgListSection').style.display = 'none';
        document.getElementById('wgConfigPanel').style.display = 'none';
    }
}

// Verfügbare Werbegebiete rendern
function renderAvailableWerbegebiete() {
    const container = document.getElementById('wgAvailableList');
    const werbegebiete = kundenWerbegebiete[selectedWgKunde] || [];

    // Filtern: WGs die noch nicht hinzugefügt wurden
    // Vergleiche customer_area_id (nicht campaign_areas.id) mit customer_areas.id
    const addedCustomerAreaIds = campaignWerbegebiete.map(w => w.customer_area_id);
    const available = werbegebiete.filter(wg => !addedCustomerAreaIds.includes(wg.id));

    if (available.length === 0) {
        container.innerHTML = '<div class="anzeigenfeld anzeigenfeld--hinweis">Alle Werbegebiete hinzugefügt</div>';
        return;
    }

    container.innerHTML = available.map(wg => {
        const wgInitials = getInitials(wg.name);
        return `
            <div class="anzeigenfeld anzeigenfeld--card" onclick="addWgToCampaign('${wg.id}')">
                <div class="user-badge user-badge--werbegebiet user-badge--small">
                    <div class="user-badge__avatar">${wgInitials}</div>
                    <div class="user-badge__info">
                        <span class="user-badge__name">${wg.name}</span>
                        <span class="user-badge__type">Werbegebiet</span>
                    </div>
                </div>
                <div class="anzeigenfeld--card-right">
                    <button class="btn btn-icon">
                        <span class="icon icon--plus"></span>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// WG zur Kampagne hinzufügen
async function addWgToCampaign(wgId) {
    const werbegebiete = kundenWerbegebiete[selectedWgKunde] || [];
    const wg = werbegebiete.find(w => w.id === wgId);
    if (!wg) return;

    // WG mit Standardkonfiguration hinzufügen
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    const kwFrom = campaign?.kwFrom || 1;
    const kwTo = campaign?.kwTo || 12;

    // In Supabase speichern (INSERT mit customer_area_id Referenz)
    try {
        const { data: newArea, error } = await supabase
            .from('campaign_areas')
            .insert({
                campaign_id: viewingCampaignId,
                customer_area_id: wgId, // Referenz auf customer_areas
                name: wg.name,
                plz: wg.postal_code || wg.plz,
                einwohner: wg.einwohner || 0
            })
            .select()
            .single();

        if (error) throw error;

        const wgConfig = {
            id: newArea.id, // ID aus campaign_areas verwenden
            customer_area_id: wgId,
            name: wg.name,
            plz: wg.postal_code || wg.plz,
            einwohner: wg.einwohner || 0,
            kunde: selectedWgKunde,
            kundeName: getKundeName(selectedWgKunde),
            kws: Array.from({length: kwTo - kwFrom + 1}, (_, i) => kwFrom + i),
            sondierung: { j1: 80, j2: 50, j3: 30, j4: 0, j5: 0, limit: 100, limitType: 'mg' },
            regular: { j1: 60, j2: 40, j3: 20, j4: 0, j5: 0 },
            qualitaetsbonus: {
                aktiv: true,
                regeln: [
                    { storno: 15, pp: 3 },
                    { storno: 12, pp: 3 },
                    { storno: 10, pp: 3 },
                    { storno: 8, pp: 1 }
                ]
            },
            teilverguetung: false,
            teilvProzent: 50,
            stornopuffer: 10,
            endabrWochen: 8,
            kosten: {
                kfz: { aktiv: false, art: 'aufwand', betrag: '', zeitraum: 'woche' },
                kleidung: { aktiv: false, art: 'aufwand', betrag: '', pro: 'person', zeitraum: 'woche' },
                ausweise: { aktiv: false, art: 'aufwand', betrag: '', pro: 'person', zeitraum: 'woche' }
            },
            gruppenbild: null,
            sonderposten: [],
            rahmenvertrag: '',
            avv: ''
        };

        campaignWerbegebiete.push(wgConfig);

        renderAvailableWerbegebiete();
        renderAllCampaignWerbegebiete();

        // Direkt zur Konfiguration öffnen und im Edit-Modus starten
        openWgConfig(newArea.id);
        setWgConfigEditable(true);

        showToast(`${wg.name} hinzugefügt`, 'success');

    } catch (error) {
        console.error('Fehler beim Hinzufügen des Werbegebiets:', error);
        showToast('Fehler beim Hinzufügen: ' + error.message, 'error');
    }
}

// Kunde Name holen
function getKundeName(kundeId) {
    const kunde = kundenListe.find(k => k.id === kundeId);
    if (!kunde) return kundeId;

    const fullName = [kunde.organisation, kunde.name_prefix, kunde.name, kunde.name_suffix]
        .filter(Boolean)
        .join(' ')
        .trim();
    return fullName || kunde.name || 'Unbenannt';
}

// Formular-Link für Werbegebiet generieren
function getFormularLink(wgId) {
    const currentUser = window.parent?.currentUser;
    console.log('getFormularLink - currentUser:', currentUser);
    const botschafterId = currentUser?.id || '';
    const campaignId = viewingCampaignId || '';

    // Base URL (relativ oder absolut)
    const baseUrl = '../base/formular/';

    const params = new URLSearchParams({
        kampagne: campaignId,
        werbegebiet: wgId,
        botschafter: botschafterId
    });

    return `${baseUrl}?${params.toString()}`;
}

// Formular in neuem Tab öffnen
function openFormularLink(wgId) {
    const url = getFormularLink(wgId);
    window.open(url, '_blank');
}

// Formular-Link in Zwischenablage kopieren
async function copyFormularLink(wgId) {
    const url = getFormularLink(wgId);
    // Absolute URL erstellen
    const absoluteUrl = new URL(url, window.location.href).href;

    try {
        await navigator.clipboard.writeText(absoluteUrl);
        showToast('Link kopiert!', 'success');
    } catch (err) {
        // Fallback für ältere Browser
        const textArea = document.createElement('textarea');
        textArea.value = absoluteUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Link kopiert!', 'success');
    }
}

// WG Konfiguration öffnen und direkt bearbeitbar machen
function openWgConfigEditable(wgId) {
    openWgConfig(wgId);
    setWgConfigEditable(true);
}

// WG Konfiguration öffnen
function openWgConfig(wgId) {
    const wg = campaignWerbegebiete.find(w => w.id === wgId);
    if (!wg) return;

    activeWgConfig = wgId;
    wgSonderposten = [...(wg.sonderposten || [])];

    // Platzhalter ausblenden, Panel anzeigen
    document.getElementById('wgConfigPlaceholder').style.display = 'none';
    const panel = document.getElementById('wgConfigPanel');
    panel.style.display = 'flex';
    panel.scrollTop = 0;

    // WG-Name in Header setzen
    document.getElementById('wgConfigName').textContent = wg.name;

    // KW Pills generieren
    renderKwPills(wg);

    // Sondierung
    document.getElementById('sondJ1').value = wg.sondierung.j1;
    document.getElementById('sondJ2').value = wg.sondierung.j2;
    document.getElementById('sondJ3').value = wg.sondierung.j3;
    document.getElementById('sondJ4').value = wg.sondierung.j4;
    document.getElementById('sondJ5').value = wg.sondierung.j5;
    document.getElementById('sondLimit').value = wg.sondierung.limit;
    document.getElementById('sondLimitType').value = wg.sondierung.limitType;
    updateSondLimitCalc();

    // Regular
    document.getElementById('regJ1').value = wg.regular.j1;
    document.getElementById('regJ2').value = wg.regular.j2;
    document.getElementById('regJ3').value = wg.regular.j3;
    document.getElementById('regJ4').value = wg.regular.j4;
    document.getElementById('regJ5').value = wg.regular.j5;

    // Qualitätsbonus
    const qb = wg.qualitaetsbonus;
    const qbAktiv = typeof qb === 'object' ? qb.aktiv : qb;
    const qbRegeln = typeof qb === 'object' && qb.regeln ? qb.regeln : [
        { storno: 15, pp: 3 }, { storno: 12, pp: 3 }, { storno: 10, pp: 3 }, { storno: 8, pp: 1 }
    ];
    document.getElementById('wgQualitaetsbonus').checked = qbAktiv;
    document.getElementById('qualiStorno1').value = qbRegeln[0]?.storno || 15;
    document.getElementById('qualiPP1').value = qbRegeln[0]?.pp || 3;
    document.getElementById('qualiStorno2').value = qbRegeln[1]?.storno || 12;
    document.getElementById('qualiPP2').value = qbRegeln[1]?.pp || 3;
    document.getElementById('qualiStorno3').value = qbRegeln[2]?.storno || 10;
    document.getElementById('qualiPP3').value = qbRegeln[2]?.pp || 3;
    document.getElementById('qualiStorno4').value = qbRegeln[3]?.storno || 8;
    document.getElementById('qualiPP4').value = qbRegeln[3]?.pp || 1;
    document.getElementById('qualiRulesSection').style.display = qbAktiv ? 'block' : 'none';
    updateQualiMaxBonus();

    // Teilvergütung
    document.getElementById('wgTeilverguetung').checked = wg.teilverguetung;
    document.getElementById('wgTeilvProzent').value = wg.teilvProzent;
    document.getElementById('teilvSection').style.display = wg.teilverguetung ? 'flex' : 'none';

    // Abrechnung
    document.getElementById('wgStornopuffer').value = wg.stornopuffer;
    document.getElementById('wgEndabrWochen').value = wg.endabrWochen;

    // Kostenübernahmen
    const kosten = wg.kosten || {};

    // KFZ
    document.getElementById('wgKostenKfz').checked = kosten.kfz?.aktiv || false;
    document.getElementById('kfzConfig').style.display = kosten.kfz?.aktiv ? 'flex' : 'none';
    document.getElementById('wgKfzArt').value = kosten.kfz?.art || 'aufwand';
    document.getElementById('wgKfzArtFrei').value = kosten.kfz?.artFrei || '';
    document.getElementById('wgKfzBetrag').value = kosten.kfz?.betrag || 0;
    document.getElementById('wgKfzZeitraum').value = kosten.kfz?.zeitraum || 'woche';
    toggleKostenartFrei('kfz');

    // Kleidung
    document.getElementById('wgKostenKleidung').checked = kosten.kleidung?.aktiv || false;
    document.getElementById('kleidungConfig').style.display = kosten.kleidung?.aktiv ? 'flex' : 'none';
    document.getElementById('wgKleidungArt').value = kosten.kleidung?.art || 'aufwand';
    document.getElementById('wgKleidungArtFrei').value = kosten.kleidung?.artFrei || '';
    document.getElementById('wgKleidungBetrag').value = kosten.kleidung?.betrag || 0;
    document.getElementById('wgKleidungPro').value = kosten.kleidung?.pro || 'person';
    document.getElementById('wgKleidungZeitraum').value = kosten.kleidung?.zeitraum || 'woche';
    toggleKostenartFrei('kleidung');

    // Ausweise
    document.getElementById('wgKostenAusweise').checked = kosten.ausweise?.aktiv || false;
    document.getElementById('ausweiseConfig').style.display = kosten.ausweise?.aktiv ? 'flex' : 'none';
    document.getElementById('wgAusweiseArt').value = kosten.ausweise?.art || 'aufwand';
    document.getElementById('wgAusweiseArtFrei').value = kosten.ausweise?.artFrei || '';
    document.getElementById('wgAusweiseBetrag').value = kosten.ausweise?.betrag || 0;
    document.getElementById('wgAusweisePro').value = kosten.ausweise?.pro || 'person';
    document.getElementById('wgAusweiseZeitraum').value = kosten.ausweise?.zeitraum || 'woche';
    toggleKostenartFrei('ausweise');

    // Gruppenbild
    loadGruppenbild(wg.gruppenbild);

    // Erhöhungen
    document.getElementById('wgErhohungen').checked = wg.erhohungen !== false;

    // Zahlungsmodalitäten
    const allowedModalities = wg.paymentModalities || ['monthly', 'quarterly', 'biannual', 'annual'];
    const zahlungsSection = document.getElementById('zahlungsSection');
    if (zahlungsSection) {
        zahlungsSection.querySelectorAll('.btn-toggle-group .btn').forEach(btn => {
            const mod = btn.textContent.trim();
            const labelToValue = {
                'Monatlich': 'monthly',
                'Quartal': 'quarterly',
                'Halbjährlich': 'biannual',
                'Jährlich': 'annual'
            };
            const value = labelToValue[mod];
            const isActive = allowedModalities.includes(value);
            btn.classList.toggle('active', isActive);
            const checkbox = btn.querySelector('input');
            if (checkbox) checkbox.checked = isActive;
        });
    }

    // Sonderposten
    renderSonderposten();

    // Verträge laden
    loadKundenVertraege(wg.kunde, wg.rahmenvertrag, wg.avv);

    // Liste aktualisieren für active state
    renderAllCampaignWerbegebiete();

    // Standardmäßig im Read-Modus starten
    setWgConfigEditable(false);
}

// KW Pills rendern
function renderKwPills(wg) {
    const container = document.getElementById('wgKwSelection');
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    let html = '';
    for (let kw = campaign.kwFrom; kw <= campaign.kwTo; kw++) {
        const isActive = wg.kws.includes(kw);
        html += `<button class="btn btn-toggle ${isActive ? 'active' : 'neutral'}" onclick="toggleWgKw(${kw})">${kw}</button>`;
    }
    container.innerHTML = html;
}

// KW togglen
function toggleWgKw(kw) {
    const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
    if (!wg) return;

    const idx = wg.kws.indexOf(kw);
    if (idx > -1) {
        wg.kws.splice(idx, 1);
    } else {
        wg.kws.push(kw);
        wg.kws.sort((a, b) => a - b);
    }

    renderKwPills(wg);
}

// Sondierung ein-/ausblenden
function toggleSondierung() {
    const checked = document.getElementById('wgSondierung').checked;
    document.getElementById('sondierungSection').style.display = checked ? 'block' : 'none';
}

// Qualitätsbonus ein-/ausblenden
function toggleQualiRules() {
    const checked = document.getElementById('wgQualitaetsbonus').checked;
    document.getElementById('qualiRulesSection').style.display = checked ? 'block' : 'none';
}

// Sonderposten ein-/ausblenden
function toggleSonderposten() {
    const checked = document.getElementById('wgSonderpostenToggle').checked;
    document.getElementById('sonderpostenSection').style.display = checked ? 'block' : 'none';

    // Bei Aktivierung direkt einen Sonderposten hinzufügen, wenn noch keiner existiert
    if (checked && wgSonderposten.length === 0) {
        addSonderposten();
    }
}

// Max. Bonus berechnen und anzeigen
function updateQualiMaxBonus() {
    const pp1 = parseInt(document.getElementById('qualiPP1').value) || 0;
    const pp2 = parseInt(document.getElementById('qualiPP2').value) || 0;
    const pp3 = parseInt(document.getElementById('qualiPP3').value) || 0;
    const pp4 = parseInt(document.getElementById('qualiPP4').value) || 0;
    const maxBonus = pp1 + pp2 + pp3 + pp4;
    document.getElementById('qualiMaxDisplay').innerHTML = `<span>Max. Bonus: +${maxBonus} PP</span>`;
}

// Sond-Limit Berechnung aktualisieren
function updateSondLimitCalc() {
    const limitType = document.getElementById('sondLimitType').value;
    const limitValue = parseInt(document.getElementById('sondLimit').value) || 0;
    const calcEl = document.getElementById('sondLimitCalc');

    if (limitType === 'prozent') {
        // Bevölkerung vom aktuellen WG holen
        const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
        const bevolkerung = wg?.population || 0;
        if (bevolkerung > 0) {
            const mg = Math.round(bevolkerung * limitValue / 100);
            calcEl.textContent = `= ${mg.toLocaleString('de-DE')} MG`;
        } else {
            calcEl.textContent = '= ? MG';
        }
    } else {
        calcEl.textContent = '';
    }
}

// Verträge des Kunden laden
function loadKundenVertraege(kunde, selectedRahmenvertrag, selectedAvv) {
    const vertraege = kundenVertraege[kunde] || { rahmenvertraege: [], avv: [] };

    // Rahmenvertrag Dropdown
    const rvSelect = document.getElementById('wgRahmenvertrag');
    rvSelect.innerHTML = '<option value="">Keiner</option>' +
        vertraege.rahmenvertraege.map(rv =>
            `<option value="${rv}" ${rv === selectedRahmenvertrag ? 'selected' : ''}>${rv}</option>`
        ).join('');

    // AVV Dropdown
    const avvSelect = document.getElementById('wgAvv');
    avvSelect.innerHTML = '<option value="">Keiner</option>' +
        vertraege.avv.map(a =>
            `<option value="${a}" ${a === selectedAvv ? 'selected' : ''}>${a}</option>`
        ).join('');
}

// Sonderposten rendern
function renderSonderposten() {
    const container = document.getElementById('sonderpostenList');
    const toggle = document.getElementById('wgSonderpostenToggle');
    const section = document.getElementById('sonderpostenSection');

    // Toggle-Status basierend auf vorhandenen Sonderposten setzen
    const hasSonderposten = wgSonderposten.length > 0;
    toggle.checked = hasSonderposten;
    section.style.display = hasSonderposten ? 'block' : 'none';

    if (!hasSonderposten) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = wgSonderposten.map((sp, idx) => `
        <div class="zeile">
            <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                <label class="eingabefeld-beschriftung-oben">${idx === 0 ? 'Bezeichnung' : ''}</label>
                <input type="text" class="eingabefeld" value="${sp.name || ''}" placeholder="Bezeichnung" onchange="updateSonderposten(${idx}, 'name', this.value)">
            </div>
            <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                <label class="eingabefeld-beschriftung-oben">${idx === 0 ? 'Betrag' : ''}</label>
                <div class="eingabefeld-mit-einheit">
                    <input type="number" class="eingabefeld" value="${sp.summe || ''}" placeholder="0" onchange="updateSonderposten(${idx}, 'summe', this.value)">
                    <span class="text-normal--fett">€</span>
                </div>
            </div>
            <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-0-5">
                <label class="eingabefeld-beschriftung-oben">${idx === 0 ? 'Pro' : ''}</label>
                <select class="eingabefeld" onchange="updateSonderposten(${idx}, 'pro', this.value)">
                    <option value="" ${!sp.pro ? 'selected' : ''}>-</option>
                    <option value="pp" ${sp.pro === 'pp' ? 'selected' : ''}>p.P.</option>
                    <option value="team" ${sp.pro === 'team' ? 'selected' : ''}>Team</option>
                </select>
            </div>
            <div class="eingabefeld-gruppe eingabefeld-gruppe--fixed-1">
                <label class="eingabefeld-beschriftung-oben">${idx === 0 ? 'Zeitraum' : ''}</label>
                <select class="eingabefeld" onchange="updateSonderposten(${idx}, 'zeitraum', this.value)">
                    <option value="tag" ${sp.zeitraum === 'tag' ? 'selected' : ''}>Tag</option>
                    <option value="woche" ${sp.zeitraum === 'woche' ? 'selected' : ''}>Woche</option>
                    <option value="abschnitt" ${sp.zeitraum === 'abschnitt' ? 'selected' : ''}>Abschnitt</option>
                    <option value="einmalig" ${sp.zeitraum === 'einmalig' ? 'selected' : ''}>Einmalig</option>
                </select>
            </div>
            <div class="eingabefeld-gruppe eingabefeld-gruppe--auto">
                <label class="eingabefeld-beschriftung-oben">${idx === 0 ? '&nbsp;' : ''}</label>
                <button class="btn btn-sm btn-danger" onclick="removeSonderposten(${idx})">
                    <span class="icon icon--schliessen"></span>
                </button>
            </div>
        </div>
    `).join('');
}

// Sonderposten hinzufügen
function addSonderposten() {
    wgSonderposten.push({ name: '', summe: '', pro: '', zeitraum: 'woche' });
    renderSonderposten();
}

// Sonderposten aktualisieren
function updateSonderposten(idx, field, value) {
    if (wgSonderposten[idx]) {
        wgSonderposten[idx][field] = value;
    }
}

// Sonderposten entfernen
async function removeSonderposten(idx) {
    const sp = wgSonderposten[idx];
    const name = sp?.name || 'Sonderposten';
    const confirmed = await showConfirm(
        `Möchten Sie "${name}" wirklich löschen?`,
        'Sonderposten löschen',
        'error'
    );
    if (!confirmed) return;

    wgSonderposten.splice(idx, 1);
    renderSonderposten();
    showToast('Sonderposten gelöscht', 'info');
}

// Gruppenbild Upload triggern
function triggerGruppenbildUpload() {
    document.getElementById('gruppenbildInput').click();
}

// Gruppenbild Upload verarbeiten
function handleGruppenbildUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Nur Bilder erlauben
    if (!file.type.startsWith('image/')) {
        showToast('Bitte nur Bilddateien hochladen', 'error');
        return;
    }

    // Max 5MB
    if (file.size > 5 * 1024 * 1024) {
        showToast('Bild darf max. 5MB groß sein', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const dataUrl = e.target.result;

        // Preview anzeigen
        const preview = document.getElementById('gruppenbildPreview');
        preview.src = dataUrl;
        preview.classList.add('visible');

        // Placeholder verstecken
        document.getElementById('gruppenbildPlaceholder').style.display = 'none';

        // Upload-Box stylen
        document.getElementById('gruppenbildUpload').classList.add('has-image');

        // Actions anzeigen
        document.getElementById('gruppenbildActions').style.display = 'flex';

        // Im WG speichern
        const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
        if (wg) {
            wg.gruppenbild = dataUrl;
        }

        showToast('Gruppenbild hochgeladen', 'success');
    };
    reader.readAsDataURL(file);
}

// Gruppenbild entfernen
async function removeGruppenbild() {
    const confirmed = await showConfirm(
        'Möchten Sie das Gruppenbild wirklich löschen?',
        'Gruppenbild löschen',
        'error'
    );
    if (!confirmed) return;

    // Preview zurücksetzen
    const preview = document.getElementById('gruppenbildPreview');
    preview.src = '';
    preview.classList.remove('visible');

    // Placeholder anzeigen
    document.getElementById('gruppenbildPlaceholder').style.display = 'flex';

    // Upload-Box stylen
    document.getElementById('gruppenbildUpload').classList.remove('has-image');

    // Actions verstecken
    document.getElementById('gruppenbildActions').style.display = 'none';

    // Input zurücksetzen
    document.getElementById('gruppenbildInput').value = '';

    // Im WG löschen
    const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
    if (wg) {
        wg.gruppenbild = null;
    }

    showToast('Gruppenbild entfernt', 'info');
}

// Gruppenbild in UI laden
function loadGruppenbild(gruppenbild) {
    const preview = document.getElementById('gruppenbildPreview');
    const placeholder = document.getElementById('gruppenbildPlaceholder');
    const uploadBox = document.getElementById('gruppenbildUpload');
    const actions = document.getElementById('gruppenbildActions');

    if (gruppenbild) {
        preview.src = gruppenbild;
        preview.classList.add('visible');
        placeholder.style.display = 'none';
        uploadBox.classList.add('has-image');
        actions.style.display = 'flex';
    } else {
        preview.src = '';
        preview.classList.remove('visible');
        placeholder.style.display = 'flex';
        uploadBox.classList.remove('has-image');
        actions.style.display = 'none';
    }
}

// WG aus Kampagne entfernen
async function removeWgFromCampaign() {
    if (!activeWgConfig) return;

    const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
    if (!wg) return;

    const confirmed = await showConfirm(
        `Möchten Sie "${wg.name}" wirklich aus der Kampagne entfernen? Alle Konfigurationen gehen verloren.`,
        'Einsatzgebiet entfernen',
        'error'
    );
    if (!confirmed) return;

    // Aus Supabase löschen
    try {
        const { error } = await supabase
            .from('campaign_areas')
            .delete()
            .eq('id', wg.id);

        if (error) throw error;

        // Aus lokalem Array entfernen
        const idx = campaignWerbegebiete.indexOf(wg);
        if (idx > -1) {
            campaignWerbegebiete.splice(idx, 1);
        }

        // Auch aus campaign.einsatzgebiete entfernen (damit es konsistent bleibt)
        const campaign = campaigns.find(c => c.id === viewingCampaignId);
        if (campaign && campaign.einsatzgebiete) {
            const egIdx = campaign.einsatzgebiete.findIndex(eg => eg.id === wg.id);
            if (egIdx > -1) {
                campaign.einsatzgebiete.splice(egIdx, 1);
            }
        }

        activeWgConfig = null;
        document.getElementById('wgConfigPanel').style.display = 'none';
        document.getElementById('wgConfigPlaceholder').style.display = 'flex';

        renderAvailableWerbegebiete();
        renderAllCampaignWerbegebiete();

        showToast(`${wg.name} entfernt`, 'success');

    } catch (error) {
        console.error('Fehler beim Löschen:', error);
        showToast('Fehler beim Löschen: ' + error.message, 'error');
    }
}

// WG Konfiguration speichern
async function saveWgConfig() {
    const wg = campaignWerbegebiete.find(w => w.id === activeWgConfig);
    if (!wg) return;

    // Sondierung
    wg.sondierung = {
        j1: parseInt(document.getElementById('sondJ1').value) || 0,
        j2: parseInt(document.getElementById('sondJ2').value) || 0,
        j3: parseInt(document.getElementById('sondJ3').value) || 0,
        j4: parseInt(document.getElementById('sondJ4').value) || 0,
        j5: parseInt(document.getElementById('sondJ5').value) || 0,
        limit: parseInt(document.getElementById('sondLimit').value) || 100,
        limitType: document.getElementById('sondLimitType').value
    };

    // Regular
    wg.regular = {
        j1: parseInt(document.getElementById('regJ1').value) || 0,
        j2: parseInt(document.getElementById('regJ2').value) || 0,
        j3: parseInt(document.getElementById('regJ3').value) || 0,
        j4: parseInt(document.getElementById('regJ4').value) || 0,
        j5: parseInt(document.getElementById('regJ5').value) || 0
    };

    // Qualitätsbonus
    wg.qualitaetsbonus = {
        aktiv: document.getElementById('wgQualitaetsbonus').checked,
        regeln: [
            { storno: parseInt(document.getElementById('qualiStorno1').value) || 15, pp: parseInt(document.getElementById('qualiPP1').value) || 3 },
            { storno: parseInt(document.getElementById('qualiStorno2').value) || 12, pp: parseInt(document.getElementById('qualiPP2').value) || 3 },
            { storno: parseInt(document.getElementById('qualiStorno3').value) || 10, pp: parseInt(document.getElementById('qualiPP3').value) || 3 },
            { storno: parseInt(document.getElementById('qualiStorno4').value) || 8, pp: parseInt(document.getElementById('qualiPP4').value) || 1 }
        ]
    };

    // Teilvergütung
    wg.teilverguetung = document.getElementById('wgTeilverguetung').checked;
    wg.teilvProzent = parseInt(document.getElementById('wgTeilvProzent').value) || 50;

    // Abrechnung
    wg.stornopuffer = parseInt(document.getElementById('wgStornopuffer').value) || 10;
    wg.endabrWochen = parseInt(document.getElementById('wgEndabrWochen').value) || 8;

    // Kostenübernahmen
    wg.kosten = {
        kfz: {
            aktiv: document.getElementById('wgKostenKfz').checked,
            art: document.getElementById('wgKfzArt').value,
            artFrei: document.getElementById('wgKfzArtFrei').value,
            betrag: document.getElementById('wgKfzBetrag').value,
            zeitraum: document.getElementById('wgKfzZeitraum').value
        },
        kleidung: {
            aktiv: document.getElementById('wgKostenKleidung').checked,
            art: document.getElementById('wgKleidungArt').value,
            artFrei: document.getElementById('wgKleidungArtFrei').value,
            betrag: document.getElementById('wgKleidungBetrag').value,
            pro: document.getElementById('wgKleidungPro').value,
            zeitraum: document.getElementById('wgKleidungZeitraum').value
        },
        ausweise: {
            aktiv: document.getElementById('wgKostenAusweise').checked,
            art: document.getElementById('wgAusweiseArt').value,
            artFrei: document.getElementById('wgAusweiseArtFrei').value,
            betrag: document.getElementById('wgAusweiseBetrag').value,
            pro: document.getElementById('wgAusweisePro').value,
            zeitraum: document.getElementById('wgAusweiseZeitraum').value
        }
    };

    // Sonderposten
    wg.sonderposten = [...wgSonderposten];

    // Verträge
    wg.rahmenvertrag = document.getElementById('wgRahmenvertrag').value;
    wg.avv = document.getElementById('wgAvv').value;

    // Zahlungsmodalitäten aus Toggle-Gruppe sammeln
    const zahlungsSection = document.getElementById('zahlungsSection');
    const activeModalities = [];
    if (zahlungsSection) {
        zahlungsSection.querySelectorAll('.btn-toggle-group .btn').forEach(btn => {
            if (btn.classList.contains('active')) {
                const mod = btn.textContent.trim();
                const labelToValue = {
                    'Monatlich': 'monthly',
                    'Quartal': 'quarterly',
                    'Halbjährlich': 'biannual',
                    'Jährlich': 'annual'
                };
                if (labelToValue[mod]) {
                    activeModalities.push(labelToValue[mod]);
                }
            }
        });
    }
    wg.paymentModalities = activeModalities.length > 0 ? activeModalities : ['monthly', 'quarterly', 'biannual', 'annual'];

    // Erhöhungen
    wg.erhohungen = document.getElementById('wgErhohungen').checked;

    // In Supabase speichern
    try {
        const { error } = await supabase
            .from('campaign_areas')
            .update({
                provision_sondierung: wg.sondierung,
                provision_regular: wg.regular,
                qualitaetsbonus: wg.qualitaetsbonus,
                teilverguetung: wg.teilverguetung,
                teilv_prozent: wg.teilvProzent,
                stornopuffer: wg.stornopuffer,
                endabr_wochen: wg.endabrWochen,
                kosten: wg.kosten,
                sonderposten: wg.sonderposten,
                rahmenvertrag_name: wg.rahmenvertrag,
                avv_url: wg.avv,
                payment_modalities: wg.paymentModalities,
                erhohungen_enabled: wg.erhohungen
            })
            .eq('id', wg.id);

        if (error) throw error;

        showToast(`${wg.name} gespeichert`, 'success');

        // Edit-Modus beenden
        setWgConfigEditable(false);

    } catch (error) {
        console.error('Fehler beim Speichern der WG-Konfiguration:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// Toggle WG Edit-Modus
function toggleWgEditMode() {
    setWgConfigEditable(!wgEditMode);
}

// Abbrechen der WG Bearbeitung
function cancelWgEdit() {
    // Werte zurücksetzen auf gespeicherte Werte durch Neu-Laden
    if (activeWgConfig) {
        openWgConfig(activeWgConfig);
    } else {
        setWgConfigEditable(false);
    }
}

// WG Config editable/readonly setzen
function setWgConfigEditable(editable) {
    wgEditMode = editable;

    const configBody = document.getElementById('wgConfigPanel');
    if (!configBody) return;

    // Alle Inputs, Selects und Textareas im Config-Body
    const inputs = configBody.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.disabled = !editable;
    });

    // Toggle-Switches
    const toggles = configBody.querySelectorAll('.toggle-switch input');
    toggles.forEach(toggle => {
        toggle.disabled = !editable;
        const slider = toggle.closest('.toggle-switch');
        if (slider) {
            slider.style.opacity = editable ? '1' : '0.6';
            slider.style.pointerEvents = editable ? 'auto' : 'none';
        }
    });

    // Zahlungsmodalitäten Toggle-Buttons
    const zahlungsBtns = configBody.querySelectorAll('.btn-toggle-group .btn');
    zahlungsBtns.forEach(btn => {
        btn.style.pointerEvents = editable ? 'auto' : 'none';
        btn.style.opacity = editable ? '1' : '0.6';
    });

    // Gruppenbild Upload
    const gruppenbildUpload = document.getElementById('gruppenbildUpload');
    if (gruppenbildUpload) {
        gruppenbildUpload.style.pointerEvents = editable ? 'auto' : 'none';
        gruppenbildUpload.style.opacity = editable ? '1' : '0.7';
    }
    const gruppenbildActions = document.getElementById('gruppenbildActions');
    if (gruppenbildActions) {
        gruppenbildActions.style.display = editable && document.getElementById('gruppenbildPreview').src ? 'flex' : 'none';
    }

    // Sonderposten hinzufügen Button
    const addSonderpostenBtn = document.getElementById('btnAddSonderposten');
    if (addSonderpostenBtn) {
        addSonderpostenBtn.style.display = editable ? 'flex' : 'none';
    }

    // Sonderposten entfernen Buttons
    const removeSonderpostenBtns = document.querySelectorAll('#sonderpostenList .btn-danger');
    removeSonderpostenBtns.forEach(btn => {
        btn.style.display = editable ? 'flex' : 'none';
    });

    // Sonderposten Toggle
    const sonderpostenToggle = document.getElementById('wgSonderpostenToggle');
    if (sonderpostenToggle) {
        sonderpostenToggle.disabled = !editable;
        const slider = sonderpostenToggle.nextElementSibling;
        if (slider) {
            slider.style.opacity = editable ? '1' : '0.6';
            slider.style.pointerEvents = editable ? 'auto' : 'none';
        }
    }

    // Bearbeiten-Button Text/Icon ändern
    const btnEdit = document.getElementById('btnWgEdit');
    if (btnEdit) {
        btnEdit.style.display = editable ? 'none' : 'inline-flex';
    }

    // Speichern/Abbrechen Buttons anzeigen/verstecken
    const editButtons = document.getElementById('wgConfigFooter');
    if (editButtons) {
        editButtons.style.display = editable ? 'flex' : 'none';
    }

    // KW Buttons deaktivieren/aktivieren
    const kwButtons = configBody.querySelectorAll('.btn.btn-toggle');
    kwButtons.forEach(btn => {
        btn.style.pointerEvents = editable ? 'auto' : 'none';
        btn.style.opacity = editable ? '1' : '0.7';
    });
}

// Toggle Kostenart Frei-Textfeld
function toggleKostenartFrei(typ) {
    const typCapitalized = typ.charAt(0).toUpperCase() + typ.slice(1);
    const selectId = `wg${typCapitalized}Art`;
    const freiGruppeId = `wg${typCapitalized}ArtFreiGruppe`;
    const select = document.getElementById(selectId);
    const freiGruppe = document.getElementById(freiGruppeId);

    if (select && freiGruppe) {
        freiGruppe.style.display = select.value === 'frei' ? 'flex' : 'none';
    }
}

// Toggle Event Listeners für Kostenübernahmen und Teilvergütung
document.addEventListener('DOMContentLoaded', function() {
    // Teilvergütung Toggle
    const teilvToggle = document.getElementById('wgTeilverguetung');
    if (teilvToggle) {
        teilvToggle.addEventListener('change', function() {
            document.getElementById('teilvSection').style.display = this.checked ? 'flex' : 'none';
        });
    }

    // KFZ Toggle
    const kfzToggle = document.getElementById('wgKostenKfz');
    if (kfzToggle) {
        kfzToggle.addEventListener('change', function() {
            document.getElementById('kfzConfig').style.display = this.checked ? 'flex' : 'none';
        });
    }

    // Unterkunft Toggle
    const unterkunftToggle = document.getElementById('wgKostenUnterkunft');
    if (unterkunftToggle) {
        unterkunftToggle.addEventListener('change', function() {
            document.getElementById('unterkunftConfig').style.display = this.checked ? 'flex' : 'none';
        });
    }

    // Verpflegung Toggle
    const verpflegungToggle = document.getElementById('wgKostenVerpflegung');
    if (verpflegungToggle) {
        verpflegungToggle.addEventListener('change', function() {
            document.getElementById('verpflegungConfig').style.display = this.checked ? 'flex' : 'none';
        });
    }

    // Kleidung Toggle
    const kleidungToggle = document.getElementById('wgKostenKleidung');
    if (kleidungToggle) {
        kleidungToggle.addEventListener('change', function() {
            document.getElementById('kleidungConfig').style.display = this.checked ? 'flex' : 'none';
        });
    }

    // Ausweise Toggle
    const ausweiseToggle = document.getElementById('wgKostenAusweise');
    if (ausweiseToggle) {
        ausweiseToggle.addEventListener('change', function() {
            document.getElementById('ausweiseConfig').style.display = this.checked ? 'flex' : 'none';
        });
    }
});

// Team Overview Stats
function renderTeamOverview(campaign) {
    const allEmployeeIds = new Set();
    const tcIds = new Set();
    const qmIds = new Set();

    for (let kw = campaign.kwFrom; kw <= campaign.kwTo; kw++) {
        const assignment = campaign.assignments[kw] || {};
        if (assignment.teamchef) {
            tcIds.add(assignment.teamchef);
            allEmployeeIds.add(assignment.teamchef);
        }
        (assignment.werber || []).forEach(id => allEmployeeIds.add(id));
    }

    // Check for QMs in employees
    allEmployeeIds.forEach(id => {
        const emp = employees.find(e => e.id === id);
        if (emp && emp.isQM) qmIds.add(id);
    });

    document.getElementById('viewTotalEmployees').textContent = allEmployeeIds.size;
    document.getElementById('viewTotalTCs').textContent = tcIds.size;
    document.getElementById('viewTotalQMs').textContent = qmIds.size;
}

// TC Dienste Aufteilung rendern
function renderTCDienste(campaign) {
    const container = document.getElementById('viewTCDienste');

    // TC-Dienste aus Supabase
    const tcDienste = campaign.tcDienste || [];

    const gesamtFaktor = tcDienste.reduce((sum, d) => sum + d.faktor, 0);
    const isOver = gesamtFaktor > 1;
    const isUnder = gesamtFaktor < 1;

    let html = '<div class="inline-editable" id="tcDiensteEditable">';

    tcDienste.forEach((dienst, index) => {
        const dienstConfig = TC_DIENSTE.find(d => d.id === dienst.dienst) || { name: dienst.dienst };
        html += `
            <div class="tc-dienst-row">
                <input type="number" class="tc-dienst-faktor" value="${dienst.faktor}" min="0" max="1" step="1"
                    onchange="updateTCDienst(${index}, this.value)">
                <select class="tc-dienst-select" onchange="changeTCDienstType(${index}, this.value)">
                    ${TC_DIENSTE.map(d => `<option value="${d.id}" ${d.id === dienst.dienst ? 'selected' : ''}>${d.name}</option>`).join('')}
                </select>
                <button class="tc-dienst-remove" onclick="removeTCDienst(${index})" title="Entfernen">
                    <span class="icon icon--schliessen"></span>
                </button>
            </div>
        `;
    });

    html += `
        <button class="tc-dienst-add" onclick="addTCDienst()">
            <span class="icon icon--plus"></span>
            Dienst hinzufügen
        </button>
        <div class="tc-gesamt">
            <span class="tc-gesamt-label">Gesamt TC-Faktor:</span>
            <span class="tc-gesamt-value ${isOver || isUnder ? 'warning' : ''}">${gesamtFaktor.toFixed(2)} / 1.00</span>
        </div>
    `;

    html += '</div>';
    container.innerHTML = html;
}

// TC-Dienst Hilfsfunktionen mit Faktor-Validierung
// Regeln: Faktor insgesamt max. 1, min. 0 pro Dienst
let currentCampaignTCDienste = {};

function updateTCDienst(index, value) {
    const faktor = parseFloat(value);

    // Validierung: min 0
    if (isNaN(faktor) || faktor < 0) {
        showToast('Minimum Faktor: 0.00', 'warning');
        return;
    }

    if (faktor > 1) {
        showToast('Maximum Faktor: 1.00', 'warning');
        return;
    }

    console.log('Update Dienst', index, 'to', faktor);
    showToast(`Faktor auf ${faktor.toFixed(2)} gesetzt`, 'success');
}

function changeTCDienstType(index, type) {
    console.log('Change Dienst type', index, 'to', type);
}

function removeTCDienst(index) {
    console.log('Remove Dienst', index);
    showToast('Dienst entfernt', 'success');
}

function addTCDienst() {
    console.log('Add new Dienst');
    showToast('Neuer Dienst hinzugefügt', 'success');
}

// Validiere TC-Faktor Eingabe pro KW
function validateKWTCFaktor(input, kw) {
    const container = input.closest('.inline-editable');
    if (!container) return;

    const inputs = container.querySelectorAll('.tc-dienst-faktor');
    let total = 0;

    inputs.forEach(inp => {
        const val = parseFloat(inp.value);
        if (!isNaN(val)) total += val;
    });

    // Update Gesamt-Anzeige
    const gesamtEl = container.querySelector('.tc-gesamt-value');
    if (gesamtEl) {
        gesamtEl.textContent = total.toFixed(2);
        if (total > 1) {
            gesamtEl.style.color = '#dc2626';
            gesamtEl.style.fontWeight = '700';
            showToast(`KW ${kw}: Gesamt-Faktor max. 1! (aktuell: ${total.toFixed(2)})`, 'error');
        } else if (total === 1) {
            gesamtEl.style.color = '#16a34a';
            gesamtEl.style.fontWeight = '700';
        } else {
            gesamtEl.style.color = 'var(--text-secondary)';
            gesamtEl.style.fontWeight = '600';
        }
    }
}

// KW Details - NEUE STRUKTUR
function renderKWDetails(campaign) {
    const container = document.getElementById('viewKWDetails');
    const currentKW = getCurrentKW();
    let html = '';

    // Kampagnen-Werbegebiete (aus Einsatzgebieten oder campaign_areas aus Supabase)
    const campaignWerbegebiete = campaign.einsatzgebiete || [];

    for (let kw = campaign.kwFrom; kw <= campaign.kwTo; kw++) {
        const assignment = campaign.assignments[kw] || {};
        const prevAssignment = campaign.assignments[kw - 1] || {};
        const nextAssignment = campaign.assignments[kw + 1] || {};

        const tcId = assignment.teamchef;
        const werberIds = assignment.werber || [];
        const tc = tcId ? employees.find(e => e.id === tcId) : null;
        const werberList = werberIds.map(id => employees.find(e => e.id === id)).filter(Boolean);

        // TC der vorherigen/nächsten KW für Label-Berechnung
        const prevTcId = prevAssignment.teamchef;
        const nextTcId = nextAssignment.teamchef;
        const prevWerberIds = prevAssignment.werber || [];
        const nextWerberIds = nextAssignment.werber || [];

        // Ist dies die erste KW der Kampagne?
        const isFirstKW = kw === campaign.kwFrom;
        const isLastKW = kw === campaign.kwTo;

        // Berechne Labels für TC
        let tcLabel = '';
        if (tc) {
            const tcWasInPrevKW = prevTcId === tcId || prevWerberIds.includes(tcId);
            const tcIsInNextKW = nextTcId === tcId || nextWerberIds.includes(tcId);
            const isNew = isFirstKW || !tcWasInPrevKW;
            const isLeaving = !tcIsInNextKW && !isLastKW;
            // Beide = An- und Abreise in einer KW
            if (isNew && isLeaving) tcLabel = 'beide';
            else if (isNew) tcLabel = 'neuanreise';
            else if (isLeaving) tcLabel = 'abreise';
        }

        // Berechne Labels für Werber
        const werberWithLabels = werberList.map(w => {
            const wasInPrevKW = prevWerberIds.includes(w.id) || prevTcId === w.id;
            const isInNextKW = nextWerberIds.includes(w.id) || nextTcId === w.id;
            const isNew = isFirstKW || !wasInPrevKW;
            const isLeaving = !isInNextKW && !isLastKW;
            let label = '';
            // Beide = An- und Abreise in einer KW
            if (isNew && isLeaving) label = 'beide';
            else if (isNew) label = 'neuanreise';
            else if (isLeaving) label = 'abreise';
            return { ...w, label };
        });

        // Zähle Anreisen/Abreisen für Header
        const anreisenCount = werberWithLabels.filter(w => w.label === 'neuanreise').length + (tcLabel === 'neuanreise' ? 1 : 0);
        const abreisenCount = werberWithLabels.filter(w => w.label === 'abreise').length + (tcLabel === 'abreise' ? 1 : 0);
        const totalCount = werberList.length + (tc ? 1 : 0);

        const isCurrentWeek = kw === currentKW;
        const hasTc = !!tc;
        const dateRange = getKWDateRange(kw, 2025);

        // Sortiere Werber alphabetisch für Header-Pills
        const werberSorted = [...werberWithLabels].sort((a, b) => a.name.localeCompare(b.name));

        // TC-Dienste pro KW (aus Supabase)
        const kwDienste = assignment.tcDienste || [];
        const vergebenerFaktor = kwDienste.reduce((sum, d) => sum + (d.faktor || 0), 0);
        const tcFaktorVerbleibend = Math.max(0, 1 - vergebenerFaktor);

        // Werbegebiete dieser KW
        const kwWerbegebiete = assignment.werbegebiete || campaignWerbegebiete.map(wg => wg.id);
        const activeWerbegebiete = campaignWerbegebiete.filter(wg => kwWerbegebiete.includes(wg.id));

        // MA-Zuordnung pro Werbegebiet
        const wgMaZuordnung = assignment.wgMaZuordnung || {};

        let classes = 'unterabschnitt--card unterabschnitt--card--expandable';
        if (isCurrentWeek) classes += ' current-week open';
        if (hasTc) classes += ' has-tc';

        // Generiere Header Team Pills HTML als mini badges
        const qmId = assignment.qualityManager;
        const qm = qmId ? employees.find(e => e.id === qmId) : null;
        const headerTeamPillsHtml = (() => {
            let pills = '';
            // 1. TC zuerst - als Werber-Badge mit TC Extra
            if (tc) {
                const tcInitials = getInitials(tc.name);
                const tcIsQM = tc.id === qmId; // Nur eingetragener QM
                const tcStufe = tc.role || '';
                pills += '<div class="user-badge user-badge--werber user-badge--small">' +
                    '<div class="user-badge__avatar">' + tcInitials + getStufeBadge(tcStufe) + '</div>' +
                    '<div class="user-badge__info">' +
                        '<span class="user-badge__name">' + tc.name + '</span>' +
                        getBadgeTypeRow('Werber', true, tcIsQM) +
                    '</div>' +
                '</div>';
            }
            // 2. QM direkt nach TC (wenn vorhanden und nicht gleich TC)
            if (qm && qm.id !== tcId) {
                const qmInitials = getInitials(qm.name);
                const qmStufe = qm.role || '';
                pills += '<div class="user-badge user-badge--werber user-badge--small">' +
                    '<div class="user-badge__avatar">' + qmInitials + getStufeBadge(qmStufe) + '</div>' +
                    '<div class="user-badge__info">' +
                        '<span class="user-badge__name">' + qm.name + '</span>' +
                        getBadgeTypeRow('Werber', false, true) +
                    '</div>' +
                '</div>';
            }
            // 3. Dann restliche Werber alphabetisch sortiert (ohne TC und QM)
            werberSorted.filter(w => w.id !== tcId && w.id !== qmId).forEach(w => {
                const wInitials = getInitials(w.name);
                const wStufe = w.role || '';
                pills += '<div class="user-badge user-badge--werber user-badge--small">' +
                    '<div class="user-badge__avatar">' + wInitials + getStufeBadge(wStufe) + '</div>' +
                    '<div class="user-badge__info">' +
                        '<span class="user-badge__name">' + w.name + '</span>' +
                        getBadgeTypeRow('Werber', false, false) +
                    '</div>' +
                '</div>';
            });
            return pills;
        })();

        // Berechne Gesamt-Einwohner für aktive Werbegebiete
        const totalEinwohner = activeWerbegebiete.reduce((sum, wg) => sum + (wg.einwohner || 0), 0);
        const einwohnerFormatted = totalEinwohner.toLocaleString('de-DE');

        // Werbegebiete-Namen für zweite Zeile als badges
        const wgNamesHtml = activeWerbegebiete.map(wg => {
            const wgName = wg.name.replace(' e.V.', '');
            const wgInitials = getInitials(wgName);
            return '<div class="user-badge user-badge--werbegebiet">' +
                '<div class="user-badge__avatar">' + wgInitials + '</div>' +
                '<div class="user-badge__info">' +
                    '<span class="user-badge__name">' + wgName + '</span>' +
                    '<span class="user-badge__type">Werbegebiet</span>' +
                '</div>' +
            '</div>';
        }).join('');

        html += `
            <div class="${classes}" data-kw="${kw}">
                <div class="kw-detail-header" onclick="toggleKWDetail(${kw})">
                    <!-- Zeile 1: KW + Datum | Team-Namen | Personenanzahl -->
                    <div class="kw-header-row1">
                        <div class="kw-detail-title">
                            <span class="text-ueberschrift-abschnitt">KW ${kw}</span>
                            <span class="pill pill--inaktiv">${dateRange}</span>
                        </div>
                        <div class="kw-header-team">
                            ${headerTeamPillsHtml}
                        </div>
                        <div class="kw-header-badges">
                            ${qmId ? '<span class="user-badge__extra user-badge__extra--q" title="Quality Manager eingeteilt">Q</span>' : ''}
                            <span class="pill pill--werber">${totalCount} Pers.</span>
                        </div>
                    </div>
                    <!-- Trennlinie zwischen Team und WG (nur eingeklappt sichtbar) -->
                    <div class="kw-header-divider"></div>
                    <!-- Zeile 2: Werbegebiete (links) | Einwohner (rechts) -->
                    <div class="kw-header-row2">
                        <div class="kw-header-wg-list">
                            ${wgNamesHtml || '<span class="text-klein">Keine Werbegebiete</span>'}
                        </div>
                        <span class="pill pill--werbegebiet">${einwohnerFormatted} EW</span>
                    </div>
                </div>
                <div class="unterabschnitt--card-details">

                    <!-- =============== 1. TC & QUALITY (nebeneinander) =============== -->
                    <div class="anzeige-box-row">
                        <!-- TC Box -->
                        <div class="anzeige-box">
                            <div class="anzeigenfeld">
                                <span class="icon icon--stern"></span>
                                <span class="text-normal text-normal--fett">Teamchef</span>
                            </div>
                            <div class="anzeigenfeld anzeigenfeld--no-padding-x">
                                <select class="eingabefeld" onchange="setKWTeamchef(${kw}, this.value)" id="tc-select-kw-${kw}">
                                    <option value="">-- TC auswählen --</option>
                                    ${employees.filter(e => e.role && ['EMM', 'CEMM', 'SPB', 'KAD', 'FUE'].includes(e.role)).map(e =>
                                        `<option value="${e.id}" ${e.id === tcId ? 'selected' : ''}>${e.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <!-- Quality Box -->
                        <div class="anzeige-box">
                            <div class="anzeigenfeld">
                                <span class="icon icon--check-kreis"></span>
                                <span class="text-normal text-normal--fett">Quality</span>
                            </div>
                            <div class="anzeigenfeld anzeigenfeld--no-padding-x">
                                <select class="eingabefeld" onchange="setKWQualityManager(${kw}, this.value)" id="qm-select-kw-${kw}">
                                    <option value="">-- QM auswählen --</option>
                                    ${(() => {
                                        // Nur Teammitglieder dieser KW können als QM gewählt werden
                                        const teamMemberIds = [...werberList.map(w => w.id), tcId].filter(id => id);
                                        return employees.filter(e =>
                                            e.additionalRoles &&
                                            e.additionalRoles.includes('quality_manager') &&
                                            teamMemberIds.includes(e.id)
                                        ).map(e =>
                                            `<option value="${e.id}" ${e.id === (assignment.qualityManager || '') ? 'selected' : ''}>${e.name}</option>`
                                        ).join('');
                                    })()}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- =============== 2. DIENSTE + CHALLENGE (nebeneinander) =============== -->
                    <div class="anzeige-box-row">
                        <!-- Dienste Box -->
                        <div class="anzeige-box">
                            <div class="anzeigenfeld">
                                <span class="icon icon--clipboard"></span>
                                <span class="text-normal text-normal--fett">Dienste</span>
                                ${hasTc ? `<span class="btn btn-sm btn-card" id="tc-faktor-kw-${kw}">TC: ${tcFaktorVerbleibend.toFixed(2)}</span>` : ''}
                            </div>
                            ${hasTc ? `
                            <div class="anzeigenfeld anzeigenfeld--no-padding-x">
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                                    <span class="eingabefeld-beschriftung-oben">Dienst</span>
                                    <select class="eingabefeld" id="dienst-select-kw-${kw}">
                                        <option value=""></option>
                                        ${TC_DIENSTE.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                                    <span class="eingabefeld-beschriftung-oben">Werber</span>
                                    <select class="eingabefeld" id="dienst-werber-kw-${kw}">
                                        <option value=""></option>
                                        ${werberList.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="eingabefeld-gruppe">
                                    <span class="eingabefeld-beschriftung-oben">Faktor</span>
                                    <input type="number" class="eingabefeld" style="text-align: center;" id="dienst-faktor-kw-${kw}" min="0" max="1" step="1" value="0.00">
                                </div>
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-0-5">
                                    <span class="eingabefeld-beschriftung-oben"></span>
                                    <button class="btn btn-sm btn-primary" onclick="addKWDienst(${kw})">
                                        <span class="icon icon--plus"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="anzeigenfeld">
                                <div class="kw-dienste-list" id="dienste-list-kw-${kw}">
                                    ${kwDienste.length > 0 ? kwDienste.map((d, idx) => {
                                        const dienstName = TC_DIENSTE.find(td => td.id === d.dienst)?.name || d.dienst;
                                        const werber = employees.find(e => e.id === d.werberId);
                                        return `
                                            <div class="kw-dienst-item">
                                                <div class="kw-dienst-item-info">
                                                    <span class="kw-dienst-name">${dienstName}</span>
                                                    <span class="kw-dienst-werber">→ ${werber?.name || 'Unbekannt'}</span>
                                                </div>
                                                <div class="kw-dienst-item-actions">
                                                    <span class="kw-dienst-faktor">${d.faktor.toFixed(2)}</span>
                                                    <button class="btn btn-sm btn-icon btn-danger" onclick="removeKWDienst(${kw}, ${idx})" title="Entfernen">
                                                        <span class="icon icon--schliessen"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<div class="anzeigenfeld anzeigenfeld--hinweis">Keine Dienste</div>'}
                                </div>
                            </div>
                            ` : `
                            <div class="anzeigenfeld">
                                <select class="eingabefeld" disabled>
                                    <option value="">-- Kein TC --</option>
                                </select>
                            </div>
                            `}
                        </div>
                        <!-- Challenge Box -->
                        <div class="anzeige-box">
                            <div class="anzeigenfeld">
                                <span class="icon icon--blitz"></span>
                                <span class="text-normal text-normal--fett">Challenge</span>
                                ${assignment.qualityManager ? '<span class="btn btn-sm btn-card">Q</span>' : ''}
                            </div>
                            ${assignment.qualityManager ? `
                            <div class="anzeigenfeld anzeigenfeld--no-padding-x">
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                                    <span class="eingabefeld-beschriftung-oben">Typ</span>
                                    <select class="eingabefeld" id="challenge-type-kw-${kw}">
                                        <option value=""></option>
                                        <option value="mitglieder">Mitglieder Challenge</option>
                                        <option value="eh">EH Challenge</option>
                                    </select>
                                </div>
                                <div class="eingabefeld-gruppe">
                                    <span class="eingabefeld-beschriftung-oben">Ziel</span>
                                    <input type="number" class="eingabefeld" id="challenge-ziel-kw-${kw}" min="1" step="1">
                                </div>
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                                    <span class="eingabefeld-beschriftung-oben">Belohnung</span>
                                    <input type="number" class="eingabefeld" id="challenge-belohnung-kw-${kw}" min="0" step="5">
                                </div>
                                <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-0-5">
                                    <span class="eingabefeld-beschriftung-oben"></span>
                                    <button class="btn btn-sm btn-primary" onclick="addKWChallenge(${kw})">
                                        <span class="icon icon--plus"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="anzeigenfeld">
                                <div class="kw-challenges-list" id="challenges-list-kw-${kw}">
                                    ${(assignment.challenges || []).length > 0 ? (assignment.challenges || []).map((ch, idx) => `
                                        <div class="kw-challenge-item ${ch.completed ? 'completed' : ''}">
                                            <div class="kw-challenge-info">
                                                <span class="kw-challenge-type">${ch.type === 'mitglieder' ? 'Mitglieder' : 'EH'}</span>
                                                <span class="kw-challenge-goal">Ziel: ${ch.ziel}</span>
                                            </div>
                                            <div class="kw-challenge-reward">
                                                <span class="kw-challenge-amount">${ch.belohnung}€</span>
                                                <button class="btn btn-sm btn-icon btn-danger" onclick="removeKWChallenge(${kw}, ${idx})" title="Entfernen">
                                                    <span class="icon icon--schliessen"></span>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') : '<div class="anzeigenfeld anzeigenfeld--hinweis">Keine Challenges</div>'}
                                </div>
                            </div>
                            ` : `
                            <div class="anzeigenfeld">
                                <select class="eingabefeld" disabled>
                                    <option value="">-- Kein QM --</option>
                                </select>
                            </div>
                            `}
                        </div>
                    </div>

                    <!-- =============== 3. TEAM-MITGLIEDER (volle Breite) =============== -->
                    <div class="anzeige-box">
                        <div class="anzeigenfeld">
                            <span class="icon icon--team"></span>
                            <span class="text-normal text-normal--fett">Team-Mitglieder</span>
                            <span class="text-klein--fett">(${werberList.length})</span>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--no-padding-x">
                            <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-2">
                                <span class="eingabefeld-beschriftung-oben">Mitarbeiter</span>
                                <select class="eingabefeld" id="add-member-kw-${kw}">
                                    <option value=""></option>
                                    ${employees.filter(e => !werberIds.includes(e.id) && e.id !== tcId).map(e =>
                                        `<option value="${e.id}">${e.name} (${e.role || 'SMA'})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="eingabefeld-gruppe eingabefeld-gruppe--flex-0-5">
                                <span class="eingabefeld-beschriftung-oben"></span>
                                <button class="btn btn-sm btn-primary" onclick="addKWMember(${kw})">
                                    <span class="icon icon--plus"></span>
                                </button>
                            </div>
                        </div>
                            ${(() => {
                                // TC und QM zuerst anzeigen, dann Trennlinie, dann normale Werber
                                let leadersHtml = '';
                                const qm = qmId ? employees.find(e => e.id === qmId) : null;

                                // TC anzeigen (wenn vorhanden)
                                if (tc) {
                                    const tcStufe = tc.role || '';
                                    const tcIsAlsoQM = tc.id === qmId;
                                    leadersHtml += `
                                    <div class="anzeigenfeld anzeigenfeld--card">
                                        <div class="user-badge user-badge--werber">
                                            <div class="user-badge__avatar">${getInitials(tc.name)}${getStufeBadge(tcStufe)}</div>
                                            <div class="user-badge__info">
                                                <span class="user-badge__name">${tc.name}</span>
                                                ${getBadgeTypeRow('Werber', true, tcIsAlsoQM)}
                                            </div>
                                        </div>
                                        ${renderAttendanceTracker(campaign.id, kw, tc.id, tc.name)}
                                        <div class="anzeigenfeld--card-right">
                                            <button class="btn btn-icon btn-danger" onclick="removeKWMember(${kw}, '${tc.id}')" title="Entfernen">
                                                <span class="icon icon--schliessen"></span>
                                            </button>
                                        </div>
                                    </div>`;
                                }

                                // Quality anzeigen (wenn vorhanden und nicht gleich TC)
                                if (qm && qm.id !== tcId) {
                                    const qmStufe = qm.role || '';
                                    leadersHtml += `
                                    <div class="anzeigenfeld anzeigenfeld--card">
                                        <div class="user-badge user-badge--werber">
                                            <div class="user-badge__avatar">${getInitials(qm.name)}${getStufeBadge(qmStufe)}</div>
                                            <div class="user-badge__info">
                                                <span class="user-badge__name">${qm.name}</span>
                                                ${getBadgeTypeRow('Werber', false, true)}
                                            </div>
                                        </div>
                                        ${renderAttendanceTracker(campaign.id, kw, qm.id, qm.name)}
                                        <div class="anzeigenfeld--card-right">
                                            <button class="btn btn-icon btn-danger" onclick="removeKWMember(${kw}, '${qm.id}')" title="Entfernen">
                                                <span class="icon icon--schliessen"></span>
                                            </button>
                                        </div>
                                    </div>`;
                                }

                                // Normale Werber (ohne TC und QM)
                                const normalWerber = werberWithLabels.filter(w => w.id !== tcId && w.id !== qmId);
                                const werberHtml = normalWerber.length > 0 ? normalWerber.map(w => {
                                    const wStufe = w.role || '';
                                    return `
                                    <div class="anzeigenfeld anzeigenfeld--card">
                                        <div class="user-badge user-badge--werber">
                                            <div class="user-badge__avatar">${getInitials(w.name)}${getStufeBadge(wStufe)}</div>
                                            <div class="user-badge__info">
                                                <span class="user-badge__name">${w.name}</span>
                                                ${getBadgeTypeRow('Werber', false, false)}
                                            </div>
                                        </div>
                                        ${renderAttendanceTracker(campaign.id, kw, w.id, w.name)}
                                        <div class="anzeigenfeld--card-right">
                                            ${w.label ? '<span class="pill pill--' + (w.label === 'neuanreise' ? 'success' : w.label === 'abreise' ? 'error' : 'beide') + '">' + (w.label === 'neuanreise' ? 'Neuanreise' : w.label === 'abreise' ? 'Abreise' : 'An/Ab') + '</span>' : ''}
                                            <button class="btn btn-icon btn-danger" onclick="removeKWMember(${kw}, '${w.id}')" title="Entfernen">
                                                <span class="icon icon--schliessen"></span>
                                            </button>
                                        </div>
                                    </div>`;
                                }).join('') : '';

                                if (!leadersHtml && !werberHtml) {
                                    return '<div class="anzeigenfeld anzeigenfeld--hinweis">Keine Mitglieder</div>';
                                }

                                return leadersHtml + werberHtml;
                            })()}
                    </div>

                    <!-- =============== 4. WERBEGEBIETE =============== -->
                    <div class="anzeige-box">
                        <div class="anzeigenfeld">
                            <span class="icon icon--standort"></span>
                            <span class="text-normal text-normal--fett">Werbegebiete dieser KW</span>
                        </div>
                        <div class="anzeige-box-row anzeige-box-row--wrap" id="wg-container-kw-${kw}">
                            ${campaignWerbegebiete.map(wg => {
                                const isSelected = kwWerbegebiete.includes(wg.id);
                                // TC separat oben, dann Werber (ohne TC, um Duplikate zu vermeiden)
                                const werberOhneTc = werberList.filter(w => w.id !== tcId);
                                const allMembers = tc ? [tc, ...werberOhneTc] : werberList;
                                const assignedCount = (wgMaZuordnung[wg.id] || []).length;
                                const ewFormatted = (wg.einwohner || 0).toLocaleString('de-DE');

                                // Hilfsfunktion: In welchem WG ist der MA?
                                const getMaWgId = (maId) => {
                                    for (const checkWgId of Object.keys(wgMaZuordnung)) {
                                        if (wgMaZuordnung[checkWgId] && wgMaZuordnung[checkWgId].includes(maId)) {
                                            return checkWgId;
                                        }
                                    }
                                    return null;
                                };

                                const wgInitials = getInitials(wg.name);
                                return '<div class="anzeige-box anzeige-box--no-border anzeige-box--no-padding anzeige-box--no-margin ' + (isSelected ? 'selected' : '') + '" data-wg-id="' + wg.id + '">' +
                                    '<div class="kw-wg-chip" onclick="handleWgClick(' + kw + ', \'' + wg.id + '\', ' + isSelected + ')">' +
                                                                                '<div class="user-badge user-badge--werbegebiet user-badge--small">' +
                                            '<div class="user-badge__avatar">' + wgInitials + '</div>' +
                                            '<div class="user-badge__info">' +
                                                '<span class="user-badge__name">' + wg.name + '</span>' +
                                                '<span class="user-badge__type">Werbegebiet</span>' +
                                            '</div>' +
                                        '</div>' +
                                        '<span class="pill pill--werbegebiet">' + ewFormatted + ' EW</span>' +
                                    '</div>' +
                                    (isSelected ?
                                        '<div class="kw-wg-accordion">' +
                                            '<div class="kw-wg-accordion-body">' +
                                                '<div class="kw-wg-ma-list">' +
                                                    (allMembers.length === 0 ?
                                                        '<p class="text-klein">Keine Teammitglieder</p>' :
                                                        allMembers.map(m => {
                                                            const maCurrentWg = getMaWgId(m.id);
                                                            const isInThisWg = maCurrentWg === wg.id;
                                                            const isInOtherWg = maCurrentWg && maCurrentWg !== wg.id;
                                                            const initials = getInitials(m.name);
                                                            const mIsTC = m.id === tcId;
                                                            const mIsQM = m.id === qmId; // Nur eingetragener QM
                                                            const mStufe = m.role || '';

                                                            return '<label class="kw-wg-ma-item ' + (isInThisWg ? 'checked' : '') + (isInOtherWg ? ' in-other-wg' : '') + '" data-ma-id="' + m.id + '">' +
                                                                '<input type="checkbox" ' + (isInThisWg ? 'checked' : '') +
                                                                    ' onchange="toggleWgMaZuordnungLive(' + kw + ', \'' + wg.id + '\', \'' + m.id + '\', this.checked)">' +
                                                                '<div class="user-badge user-badge--werber user-badge--mini" style="flex: 1;">' +
                                                                    '<div class="user-badge__avatar">' + initials + getStufeBadge(mStufe) + '</div>' +
                                                                    '<div class="user-badge__info">' +
                                                                        '<span class="user-badge__name">' + m.name + '</span>' +
                                                                        getBadgeTypeRow('Werber', mIsTC, mIsQM) +
                                                                    '</div>' +
                                                                '</div>' +
                                                            '</label>';
                                                        }).join('')
                                                    ) +
                                                '</div>' +
                                            '</div>' +
                                        '</div>'
                                    : '') +
                                '</div>';
                            }).join('')}
                        </div>
                    </div>

                </div>
            </div>
        `;
    }

    container.innerHTML = html || '<p class="text-sekundaer">Keine KW-Daten</p>';

    // Initialize employee cards
    if (typeof EmployeeCard !== 'undefined') {
        EmployeeCard.init();
    }
}

// ============================================
// HILFSFUNKTIONEN FÜR KW-AKTIONEN (NEUE STRUKTUR)
// ============================================

// Teamchef für KW setzen
async function setKWTeamchef(kw, tcId) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    // Alten TC ermitteln (aus lokalem State oder DB)
    const oldTcId = campaign.assignments[kw]?.teamchef || null;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }
    campaign.assignments[kw].teamchef = tcId || null;

    // In Supabase speichern (upsert um sicherzustellen dass Assignment existiert)
    try {
        const { error } = await supabase
            .from('campaign_assignments')
            .upsert({
                campaign_id: campaign.id,
                kw: kw,
                teamchef_id: tcId || null
            }, { onConflict: 'campaign_id,kw' });

        if (error) {
            console.error('Fehler beim Speichern des Teamchefs:', error);
            showToast('Fehler beim Speichern', 'error');
            return;
        }

        // User-Rollen automatisch aktualisieren
        await updateTeamchefRoles(oldTcId, tcId);

    } catch (error) {
        console.error('Fehler beim Speichern des Teamchefs:', error);
        showToast('Fehler beim Speichern', 'error');
        return;
    }

    showToast(`Teamchef für KW ${kw} ${tcId ? 'gesetzt' : 'entfernt'}`, 'success');
    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Helper: User-Rollen bei TC-Änderung aktualisieren
async function updateTeamchefRoles(oldTcId, newTcId) {
    try {
        // Neuen TC auf Rolle 'teamleiter' setzen
        if (newTcId) {
            await supabase
                .from('users')
                .update({ role: 'teamleiter' })
                .eq('id', newTcId);
        }

        // Alten TC prüfen: Hat er noch andere TC-Zuweisungen?
        if (oldTcId && oldTcId !== newTcId) {
            const { data: otherAssignments } = await supabase
                .from('campaign_assignments')
                .select('id')
                .eq('teamchef_id', oldTcId)
                .limit(1);

            // Keine anderen TC-Zuweisungen -> Rolle auf 'werber' zurücksetzen
            if (!otherAssignments || otherAssignments.length === 0) {
                await supabase
                    .from('users')
                    .update({ role: 'werber' })
                    .eq('id', oldTcId);
            }
        }
    } catch (error) {
        console.error('Fehler beim Aktualisieren der User-Rollen:', error);
    }
}

// Quality Manager für KW setzen
async function setKWQualityManager(kw, qmId) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    // Alten QM ermitteln (aus lokalem State)
    const oldQmId = campaign.assignments[kw]?.qualityManager || null;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }

    // In Supabase speichern (upsert um sicherzustellen dass Assignment existiert)
    try {
        const { error } = await supabase
            .from('campaign_assignments')
            .upsert({
                campaign_id: campaign.id,
                kw: kw,
                quality_manager_id: qmId || null
            }, { onConflict: 'campaign_id,kw' });

        if (error) {
            console.error('Fehler beim Speichern des Quality Managers:', error);
            showToast('Fehler beim Speichern', 'error');
            return;
        }

        // User-Rollen automatisch aktualisieren
        await updateQualityManagerRoles(oldQmId, qmId);

    } catch (error) {
        console.error('Fehler beim Speichern des Quality Managers:', error);
        showToast('Fehler beim Speichern', 'error');
        return;
    }

    campaign.assignments[kw].qualityManager = qmId || null;

    showToast(`Quality Manager für KW ${kw} ${qmId ? 'gesetzt' : 'entfernt'}`, 'success');
    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Helper: User-Rollen bei QM-Änderung aktualisieren
async function updateQualityManagerRoles(oldQmId, newQmId) {
    try {
        // Neuen QM auf Rolle 'quality' setzen
        if (newQmId) {
            await supabase
                .from('users')
                .update({ role: 'quality' })
                .eq('id', newQmId);
        }

        // Alten QM prüfen: Hat er noch andere QM-Zuweisungen?
        if (oldQmId && oldQmId !== newQmId) {
            const { data: otherAssignments } = await supabase
                .from('campaign_assignments')
                .select('id')
                .eq('quality_manager_id', oldQmId)
                .limit(1);

            // Keine anderen QM-Zuweisungen -> Rolle auf 'werber' zurücksetzen
            if (!otherAssignments || otherAssignments.length === 0) {
                await supabase
                    .from('users')
                    .update({ role: 'werber' })
                    .eq('id', oldQmId);
            }
        }
    } catch (error) {
        console.error('Fehler beim Aktualisieren der User-Rollen:', error);
    }
}

// Challenge hinzufügen (nur QM kann Challenges erstellen)
async function addKWChallenge(kw) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    const typeSelect = document.getElementById(`challenge-type-kw-${kw}`);
    const zielInput = document.getElementById(`challenge-ziel-kw-${kw}`);
    const belohnungInput = document.getElementById(`challenge-belohnung-kw-${kw}`);

    const type = typeSelect.value;
    const ziel = parseInt(zielInput.value) || 0;
    const belohnung = parseInt(belohnungInput.value) || 0;

    if (!type) {
        showToast('Bitte Challenge-Typ auswählen', 'error');
        return;
    }
    if (ziel <= 0) {
        showToast('Bitte gültiges Ziel eingeben', 'error');
        return;
    }
    if (belohnung <= 0) {
        showToast('Bitte Belohnung eingeben', 'error');
        return;
    }

    // In Supabase speichern
    try {
        const { data: newChallenge, error } = await supabase
            .from('campaign_challenges')
            .insert({
                campaign_id: campaign.id,
                kw: kw,
                challenge_type: type,
                ziel: ziel,
                belohnung: belohnung,
                completed: false
            })
            .select()
            .single();

        if (error) throw error;

        if (!campaign.assignments[kw]) {
            campaign.assignments[kw] = {};
        }
        if (!campaign.assignments[kw].challenges) {
            campaign.assignments[kw].challenges = [];
        }

        campaign.assignments[kw].challenges.push({
            id: newChallenge.id,
            type: type,
            ziel: ziel,
            belohnung: belohnung,
            completed: false,
            createdAt: newChallenge.created_at
        });

        // Reset inputs
        typeSelect.value = '';
        zielInput.value = '';
        belohnungInput.value = '';

        showToast(`${type === 'mitglieder' ? 'Mitglieder' : 'EH'}-Challenge hinzugefügt (${belohnung}€ Belohnung)`, 'success');
        rerenderKWDetails(campaign);

    } catch (error) {
        console.error('Fehler beim Speichern der Challenge:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// Challenge entfernen
async function removeKWChallenge(kw, idx) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign || !campaign.assignments[kw] || !campaign.assignments[kw].challenges) return;

    const challenge = campaign.assignments[kw].challenges[idx];
    if (!challenge) return;

    // Aus Supabase löschen
    try {
        const { error } = await supabase
            .from('campaign_challenges')
            .delete()
            .eq('id', challenge.id);

        if (error) throw error;

        campaign.assignments[kw].challenges.splice(idx, 1);
        showToast('Challenge entfernt', 'success');
        rerenderKWDetails(campaign);

    } catch (error) {
        console.error('Fehler beim Löschen der Challenge:', error);
        showToast('Fehler beim Löschen: ' + error.message, 'error');
    }
}

// Dienst hinzufügen
function addKWDienst(kw) {
    const dienstSelect = document.getElementById(`dienst-select-kw-${kw}`);
    const werberSelect = document.getElementById(`dienst-werber-kw-${kw}`);
    const faktorInput = document.getElementById(`dienst-faktor-kw-${kw}`);

    const dienst = dienstSelect?.value;
    const werberId = werberSelect?.value ? parseInt(werberSelect.value) : null;
    const faktor = parseFloat(faktorInput?.value) || 0;

    if (!dienst) {
        showToast('Bitte Dienst auswählen', 'warning');
        return;
    }
    if (!werberId) {
        showToast('Bitte Werber auswählen', 'warning');
        return;
    }
    if (faktor < 0 || faktor > 1) {
        showToast('Faktor muss zwischen 0 und 1 sein', 'warning');
        return;
    }

    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }
    if (!campaign.assignments[kw].tcDienste) {
        campaign.assignments[kw].tcDienste = [];
    }

    // Prüfe ob Gesamtfaktor nicht über 1
    const currentTotal = campaign.assignments[kw].tcDienste.reduce((sum, d) => sum + (d.faktor || 0), 0);
    if (currentTotal + faktor > 1) {
        showToast(`Faktor zu hoch! Verfügbar: ${(1 - currentTotal).toFixed(2)}`, 'error');
        return;
    }

    campaign.assignments[kw].tcDienste.push({ dienst, werberId, faktor });

    const dienstName = TC_DIENSTE.find(d => d.id === dienst)?.name || dienst;
    showToast(`Dienst "${dienstName}" hinzugefügt (${faktor.toFixed(2)})`, 'success');

    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Dienst entfernen (mit Bestätigung)
async function removeKWDienst(kw, index) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign || !campaign.assignments[kw]?.tcDienste) return;

    const dienst = campaign.assignments[kw].tcDienste[index];
    const dienstName = TC_DIENSTE.find(d => d.id === dienst?.dienst)?.name || 'Dienst';

    const confirmed = await showConfirm(
        `"${dienstName}" wirklich entfernen?`,
        'Dienst löschen',
        'error'
    );
    if (!confirmed) return;

    campaign.assignments[kw].tcDienste.splice(index, 1);
    showToast(`Dienst entfernt`, 'success');

    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Mitglied zur KW hinzufügen
async function addKWMember(kw) {
    const select = document.getElementById(`add-member-kw-${kw}`);
    const memberId = select?.value || null;

    if (!memberId) {
        showToast('Bitte Mitarbeiter auswählen', 'warning');
        return;
    }

    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }
    if (!campaign.assignments[kw].werber) {
        campaign.assignments[kw].werber = [];
    }

    if (campaign.assignments[kw].werber.includes(memberId)) {
        showToast('Mitarbeiter bereits in dieser KW', 'warning');
        return;
    }

    // In Supabase speichern
    try {
        // Assignment-ID holen oder erstellen
        let { data: assignment, error: fetchError } = await supabase
            .from('campaign_assignments')
            .select('id')
            .eq('campaign_id', campaign.id)
            .eq('kw', kw)
            .single();

        // Wenn kein Assignment existiert, eines erstellen
        if (!assignment) {
            const { data: newAssignment, error: insertError } = await supabase
                .from('campaign_assignments')
                .insert({
                    campaign_id: campaign.id,
                    kw: kw
                })
                .select('id')
                .single();

            if (insertError) {
                console.error('Fehler beim Erstellen des Assignments:', insertError);
                showToast('Fehler beim Speichern', 'error');
                return;
            }
            assignment = newAssignment;
        }

        // Werber zum Assignment hinzufügen
        const { error: werberError } = await supabase
            .from('campaign_assignment_werber')
            .insert({
                assignment_id: assignment.id,
                werber_id: memberId
            });

        if (werberError) {
            console.error('Fehler beim Hinzufügen des Werbers:', werberError);
            showToast('Fehler beim Speichern', 'error');
            return;
        }
    } catch (error) {
        console.error('Fehler beim Hinzufügen des Werbers:', error);
        showToast('Fehler beim Speichern', 'error');
        return;
    }

    campaign.assignments[kw].werber.push(memberId);

    const member = employees.find(e => e.id === memberId);
    showToast(`${member?.name || 'Mitarbeiter'} zu KW ${kw} hinzugefügt`, 'success');

    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Mitglied aus KW entfernen (mit Bestätigung)
async function removeKWMember(kw, memberId) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign || !campaign.assignments[kw]?.werber) return;

    const member = employees.find(e => e.id === memberId);
    const memberName = member?.name || 'Mitarbeiter';

    const confirmed = await showConfirm(
        `"${memberName}" aus KW ${kw} entfernen?`,
        'Mitarbeiter entfernen',
        'error'
    );
    if (!confirmed) return;

    const index = campaign.assignments[kw].werber.indexOf(memberId);
    if (index > -1) {
        // Aus Supabase löschen
        try {
            const { data: assignment } = await supabase
                .from('campaign_assignments')
                .select('id')
                .eq('campaign_id', campaign.id)
                .eq('kw', kw)
                .single();

            if (assignment) {
                await supabase
                    .from('campaign_assignment_werber')
                    .delete()
                    .eq('assignment_id', assignment.id)
                    .eq('werber_id', memberId);
            }
        } catch (error) {
            console.error('Fehler beim Entfernen des Werbers:', error);
        }

        campaign.assignments[kw].werber.splice(index, 1);
        showToast(`Mitarbeiter aus KW ${kw} entfernt`, 'success');
        // View aktualisieren (expanded-Zustand erhalten)
        rerenderKWDetails(campaign);
    }
}

// Werbegebiet-Klick Handler: Auswählen oder Deaktivieren (mit Bestätigung)
async function handleWgClick(kw, wgId, isCurrentlySelected) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    // Scroll-Position speichern
    const scrollY = window.scrollY;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }

    // Default: alle WGs der Kampagne sind aktiv
    const campaignWerbegebiete = campaign.einsatzgebiete || [];
    const currentWGs = campaign.assignments[kw].werbegebiete || campaignWerbegebiete.map(wg => wg.id);

    if (isCurrentlySelected) {
        // Bereits ausgewählt → Bestätigung zum Deaktivieren
        const wgName = campaignWerbegebiete.find(w => w.id === wgId)?.name || wgId;
        const confirmed = await showConfirm(
            `Werbegebiet "${wgName}" für KW ${kw} deaktivieren?\n\nAlle Mitarbeiter-Zuordnungen werden entfernt.`,
            'Werbegebiet deaktivieren',
            'warning'
        );

        if (confirmed) {
            // WG deaktivieren
            campaign.assignments[kw].werbegebiete = currentWGs.filter(id => id !== wgId);

            // MA-Zuordnungen für dieses WG auch entfernen
            if (campaign.assignments[kw].wgMaZuordnung && campaign.assignments[kw].wgMaZuordnung[wgId]) {
                delete campaign.assignments[kw].wgMaZuordnung[wgId];
            }

            showToast(`Werbegebiet deaktiviert`, 'success');
        } else {
            // Abgebrochen - nichts tun
            return;
        }
    } else {
        // Noch nicht ausgewählt → Aktivieren
        campaign.assignments[kw].werbegebiete = [...currentWGs, wgId];
    }

    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);

    // Scroll-Position wiederherstellen
    requestAnimationFrame(() => {
        window.scrollTo(0, scrollY);
    });
}

// Werbegebiet für KW an/aus togglen (nicht mehr benutzt, aber für Kompatibilität behalten)
function toggleKWWerbegebiet(kw, wgId) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }

    // Default: alle WGs der Kampagne sind aktiv (gleiche Datenquelle wie beim Rendern!)
    const campaignWerbegebiete = campaign.einsatzgebiete || [];
    const currentWGs = campaign.assignments[kw].werbegebiete || campaignWerbegebiete.map(wg => wg.id);

    if (currentWGs.includes(wgId)) {
        // WG deaktivieren
        campaign.assignments[kw].werbegebiete = currentWGs.filter(id => id !== wgId);

        // MA-Zuordnungen für dieses WG auch entfernen
        if (campaign.assignments[kw].wgMaZuordnung && campaign.assignments[kw].wgMaZuordnung[wgId]) {
            delete campaign.assignments[kw].wgMaZuordnung[wgId];
        }
    } else {
        // WG aktivieren
        campaign.assignments[kw].werbegebiete = [...currentWGs, wgId];
    }

    // View aktualisieren (expanded-Zustand erhalten)
    rerenderKWDetails(campaign);
}

// Supabase Update für Werber-Einsatzgebiet-Zuordnung
async function saveWerberAreaAssignment(campaignId, kw, werberId, campaignAreaId) {
    try {
        // Assignment ID für diese KW finden
        const { data: assignment } = await supabase
            .from('campaign_assignments')
            .select('id')
            .eq('campaign_id', campaignId)
            .eq('kw', kw)
            .single();

        if (!assignment) {
            console.error('Assignment nicht gefunden für KW', kw);
            return false;
        }

        // campaign_area_id in campaign_assignment_werber updaten
        const { error } = await supabase
            .from('campaign_assignment_werber')
            .update({ campaign_area_id: campaignAreaId })
            .eq('assignment_id', assignment.id)
            .eq('werber_id', werberId);

        if (error) {
            console.error('Fehler beim Speichern der WG-Zuordnung:', error);
            return false;
        }
        return true;
    } catch (error) {
        console.error('Fehler beim Speichern der WG-Zuordnung:', error);
        return false;
    }
}

// MA-Zuordnung zu Werbegebiet togglen (nur 1 WG pro Werber!)
async function toggleWgMaZuordnung(kw, wgId, maId, isChecked) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    // Scroll-Position speichern
    const scrollY = window.scrollY;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }
    if (!campaign.assignments[kw].wgMaZuordnung) {
        campaign.assignments[kw].wgMaZuordnung = {};
    }

    // WICHTIG: Jeder Werber kann nur in EINEM Werbegebiet sein!
    if (isChecked) {
        // Erst aus allen anderen WGs entfernen
        Object.keys(campaign.assignments[kw].wgMaZuordnung).forEach(otherWgId => {
            const idx = campaign.assignments[kw].wgMaZuordnung[otherWgId].indexOf(maId);
            if (idx > -1) {
                campaign.assignments[kw].wgMaZuordnung[otherWgId].splice(idx, 1);
            }
        });

        // Dann zum neuen WG hinzufügen
        if (!campaign.assignments[kw].wgMaZuordnung[wgId]) {
            campaign.assignments[kw].wgMaZuordnung[wgId] = [];
        }
        if (!campaign.assignments[kw].wgMaZuordnung[wgId].includes(maId)) {
            campaign.assignments[kw].wgMaZuordnung[wgId].push(maId);
        }
    } else {
        // Aus diesem WG entfernen
        if (campaign.assignments[kw].wgMaZuordnung[wgId]) {
            const index = campaign.assignments[kw].wgMaZuordnung[wgId].indexOf(maId);
            if (index > -1) {
                campaign.assignments[kw].wgMaZuordnung[wgId].splice(index, 1);
            }
        }
    }

    // In Supabase speichern (wgId wenn checked, null wenn unchecked)
    const newAreaId = isChecked ? wgId : null;
    await saveWerberAreaAssignment(campaign.id, kw, maId, newAreaId);

    // Nur die Checkboxen in dieser KW aktualisieren (ohne volles Re-render)
    const card = document.querySelector(`.unterabschnitt--card--expandable[data-kw="${kw}"]`);
    if (card) {
        // Alle Checkboxen für diesen MA in allen WGs dieser KW aktualisieren
        card.querySelectorAll(`input[type="checkbox"]`).forEach(cb => {
            const match = cb.onchange.toString().match(/toggleWgMaZuordnung\(\d+,\s*'([^']+)',\s*(\d+)/);
            if (match && parseInt(match[2]) === maId) {
                const cbWgId = match[1];
                const isAssigned = campaign.assignments[kw].wgMaZuordnung[cbWgId]?.includes(maId);
                cb.checked = isAssigned;
            }
        });
    }

    // Scroll-Position wiederherstellen
    window.scrollTo(0, scrollY);
}

// MA-Zuordnung zu Werbegebiet togglen - LIVE ohne Re-render
async function toggleWgMaZuordnungLive(kw, wgId, maId, isChecked) {
    const campaign = campaigns.find(c => c.id === viewingCampaignId);
    if (!campaign) return;

    if (!campaign.assignments[kw]) {
        campaign.assignments[kw] = {};
    }
    if (!campaign.assignments[kw].wgMaZuordnung) {
        campaign.assignments[kw].wgMaZuordnung = {};
    }

    // WICHTIG: Jeder Werber kann nur in EINEM Werbegebiet sein!
    let previousWgId = null;

    if (isChecked) {
        // Erst aus allen anderen WGs entfernen
        Object.keys(campaign.assignments[kw].wgMaZuordnung).forEach(otherWgId => {
            const idx = campaign.assignments[kw].wgMaZuordnung[otherWgId].indexOf(maId);
            if (idx > -1) {
                previousWgId = otherWgId;
                campaign.assignments[kw].wgMaZuordnung[otherWgId].splice(idx, 1);
            }
        });

        // Dann zum neuen WG hinzufügen
        if (!campaign.assignments[kw].wgMaZuordnung[wgId]) {
            campaign.assignments[kw].wgMaZuordnung[wgId] = [];
        }
        if (!campaign.assignments[kw].wgMaZuordnung[wgId].includes(maId)) {
            campaign.assignments[kw].wgMaZuordnung[wgId].push(maId);
        }
    } else {
        // Aus diesem WG entfernen
        if (campaign.assignments[kw].wgMaZuordnung[wgId]) {
            const index = campaign.assignments[kw].wgMaZuordnung[wgId].indexOf(maId);
            if (index > -1) {
                campaign.assignments[kw].wgMaZuordnung[wgId].splice(index, 1);
            }
        }
    }

    // In Supabase speichern (wgId wenn checked, null wenn unchecked)
    const newAreaId = isChecked ? wgId : null;
    saveWerberAreaAssignment(campaign.id, kw, maId, newAreaId);

    // === LIVE DOM UPDATES (ohne Re-render) ===
    const card = document.querySelector(`.unterabschnitt--card--expandable[data-kw="${kw}"]`);
    if (!card) return;

    // Finde das WG in dem der MA jetzt ist (oder null)
    let maCurrentWgId = null;
    Object.keys(campaign.assignments[kw].wgMaZuordnung || {}).forEach(wId => {
        if (campaign.assignments[kw].wgMaZuordnung[wId]?.includes(maId)) {
            maCurrentWgId = wId;
        }
    });

    // Alle WG-Boxen in dieser KW durchgehen
    card.querySelectorAll('.anzeige-box[data-wg-id]').forEach(wrapper => {
        const thisWgId = wrapper.dataset.wgId;

        // MA-Item für diesen Werber in diesem WG finden
        const maItem = wrapper.querySelector(`.kw-wg-ma-item[data-ma-id="${maId}"]`);
        if (maItem) {
            const checkbox = maItem.querySelector('input[type="checkbox"]');
            const isInThisWg = maCurrentWgId === thisWgId;
            const isInOtherWg = maCurrentWgId && maCurrentWgId !== thisWgId;

            // Checkbox-Status
            if (checkbox) checkbox.checked = isInThisWg;

            // CSS-Klassen aktualisieren
            maItem.classList.toggle('checked', isInThisWg);
            maItem.classList.toggle('in-other-wg', isInOtherWg);
        }

        // X/X Zähler im Chip aktualisieren
        const countSpan = wrapper.querySelector(`[data-wg-count="${thisWgId}"]`);
        if (countSpan) {
            const assignedCount = campaign.assignments[kw].wgMaZuordnung[thisWgId]?.length || 0;
            const assignment = campaign.assignments[kw] || {};
            const tcId = assignment.teamchef;
            const werberIds = assignment.werber || [];
            const totalMembers = (tcId ? 1 : 0) + werberIds.length;
            countSpan.textContent = assignedCount + '/' + totalMembers;
        }
    });
}

// Toggle KW Detail Card
function toggleKWDetail(kw) {
    const card = document.querySelector(`.unterabschnitt--card--expandable[data-kw="${kw}"]`);
    if (card) {
        // Speichere Position des Headers relativ zum Viewport
        const header = card.querySelector('.kw-detail-header');
        const headerRect = header.getBoundingClientRect();
        const headerTopBefore = headerRect.top;

        // Toggle open state
        card.classList.toggle('open');

        // Nach dem Toggle: Scroll anpassen damit Header an gleicher Position bleibt
        requestAnimationFrame(() => {
            const newHeaderRect = header.getBoundingClientRect();
            const diff = newHeaderRect.top - headerTopBefore;
            if (diff !== 0) {
                window.scrollBy(0, diff);
            }
        });
    }
}

// Speichert welche KWs open sind
function getExpandedKWs() {
    const expanded = [];
    document.querySelectorAll('.unterabschnitt--card--expandable.open').forEach(card => {
        expanded.push(parseInt(card.dataset.kw));
    });
    return expanded;
}

// Stellt open-Zustand wieder her
function restoreExpandedKWs(expandedKWs) {
    expandedKWs.forEach(kw => {
        const card = document.querySelector('.unterabschnitt--card--expandable[data-kw="' + kw + '"]');
        if (card) card.classList.add('open');
    });
}

// Wrapper für renderKWDetails der expanded-Zustand erhält
function rerenderKWDetails(campaign) {
    const expandedKWs = getExpandedKWs();
    renderKWDetails(campaign);
    restoreExpandedKWs(expandedKWs);
}

// Letzte 10 Schriebe (5+5 in zwei Reihen)
function renderLastSchriebe(campaign) {
    const row1Container = document.getElementById('viewLastSchriebeRow1');
    const row2Container = document.getElementById('viewLastSchriebeRow2');

    // Schriebe werden aus records-Tabelle geladen (TODO: Implementierung)
    // Vorerst leer
    const schriebe = [];

    // Aufteilen in zwei Reihen
    const row1Data = schriebe.slice(0, 5);
    const row2Data = schriebe.slice(5, 10);

    // HTML für eine Reihe generieren
    function generateRowHtml(schriebe) {
        let html = '';
        schriebe.forEach(schrieb => {
        // Email-Icon bestimmen
        let emailIcon = '';
        let emailClass = '';
        let emailTitle = '';
        if (schrieb.emailStatus === 'opened') {
            emailClass = 'email-opened';
            emailTitle = 'E-Mail geöffnet';
        } else if (schrieb.emailStatus === 'sent') {
            emailClass = 'email-sent';
            emailTitle = 'E-Mail versendet';
        } else {
            emailClass = 'email-not-sent';
            emailTitle = 'E-Mail nicht gesendet';
        }
        emailIcon = `<span class="icon icon--email schrieb-status-icon ${emailClass}" title="${emailTitle}"></span>`;

        // IBAN-Status
        const ibanHtml = schrieb.ibanFilled
            ? '<span class="pill pill--success" title="IBAN nachgetragen">IBAN</span>'
            : '<span class="pill pill--inaktiv" title="IBAN fehlt noch">IBAN</span>';

        // User-Badge Klasse basierend auf Typ
        const badgeType = schrieb.typ === 'NMG' ? 'neumitglied' : 'erhoehung';
        const badgeClass = `user-badge--${badgeType}`;
        const typeLabel = schrieb.typ === 'NMG' ? 'Neumitglied' : 'Erhöhung';
        const badgeSVG = getBadgeSymbolSVG(badgeType);

        // Botschafter und WG Initialen
        const botschafterInitials = getInitials(schrieb.botschafter);
        const wgInitials = getInitials(schrieb.werbegebiet);

        html += `
            <div class="schrieb-compact" onclick="openSchriebDetails('${schrieb.id}')" title="${schrieb.memberName} - ${schrieb.eh} EH">
                <div class="schrieb-compact-header">
                    <div class="schrieb-compact-member">
                        <div class="user-badge ${badgeClass} user-badge--small">
                            <div class="user-badge__avatar">${badgeSVG}</div>
                            <div class="user-badge__info">
                                <span class="user-badge__name">${schrieb.memberName}</span>
                                <span class="user-badge__type">${typeLabel}</span>
                            </div>
                        </div>
                        <div class="schrieb-compact-location">
                            <div class="user-badge user-badge--werbegebiet user-badge--mini">
                                <div class="user-badge__avatar">${wgInitials}</div>
                                <div class="user-badge__info">
                                    <span class="user-badge__name">${schrieb.werbegebiet}</span>
                                </div>
                            </div>
                            <span class="schrieb-compact-strasse"><span class="location-emoji">📍</span>${schrieb.strasse} ${schrieb.hausnr}</span>
                        </div>
                    </div>
                    <div class="schrieb-compact-meta">
                        <span class="schrieb-compact-time">${schrieb.uhrzeit}</span>
                        <span class="schrieb-compact-eh">${schrieb.eh} EH</span>
                    </div>
                </div>
                <div class="schrieb-compact-footer">
                    <div class="schrieb-compact-status">
                        ${emailIcon}
                        ${ibanHtml}
                    </div>
                    <div class="user-badge user-badge--werber user-badge--mini">
                        <div class="user-badge__avatar">${botschafterInitials}${getStufeBadge(schrieb.botschafterStufe || '')}</div>
                        <div class="user-badge__info">
                            <span class="user-badge__name">${schrieb.botschafter}</span>
                            <span class="user-badge__type">Werber</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        });
        return html;
    }

    // Container füllen
    if (row1Container) {
        const html1 = generateRowHtml(row1Data);
        row1Container.innerHTML = html1 || '<p class="text-sekundaer">Keine Schriebe vorhanden</p>';
    }
    if (row2Container) {
        const html2 = generateRowHtml(row2Data);
        row2Container.innerHTML = html2 || '';
    }
}

// ============================================
// MITGLIED MODAL FUNKTIONEN (wiederverwendbar)
// ============================================

// Aktuelles Mitglied im Modal
let currentMitglied = null;

// Mitglieder-Daten - werden aus Supabase geladen (records)
// typ: 'NMG' (Neumitglied) oder 'ERH' (Erhöhung)
const mitgliederData = {};

// Verfügbare Werbegebiete - werden aus campaign_areas geladen
const verfuegbareWerbegebiete = [];

// Mitglied Card für Modal - exakt gleiche Karte wie im Grid (nicht klickbar)
function renderMitgliedCardLarge(mitglied) {
    // Email-Status Icon
    let emailIconClass = 'email-sent';
    let emailTitle = 'E-Mail versendet';
    if (mitglied.emailStatus === 'opened') {
        emailIconClass = 'email-opened';
        emailTitle = 'E-Mail geöffnet';
    } else if (mitglied.emailStatus === 'not_sent') {
        emailIconClass = 'email-not-sent';
        emailTitle = 'E-Mail nicht gesendet';
    }

    // IBAN-Status
    const ibanHtml = mitglied.ibanFilled
        ? '<span class="pill pill--success" title="IBAN nachgetragen">IBAN</span>'
        : '<span class="pill pill--inaktiv" title="IBAN fehlt noch">IBAN</span>';

    // Email Icon
    const emailIcon = `<span class="icon icon--email schrieb-status-icon ${emailIconClass}" title="${emailTitle}"></span>`;

    // User-Badge Klasse basierend auf Typ
    const badgeType = mitglied.typ === 'NMG' ? 'neumitglied' : 'erhoehung';
    const badgeClass = `user-badge--${badgeType}`;
    const typeLabel = mitglied.typ === 'NMG' ? 'Neumitglied' : 'Erhöhung';
    const badgeSVG = getBadgeSymbolSVG(badgeType);

    // Botschafter Initialen
    const botschafterInitials = getInitials(mitglied.botschafter);

    // WG Initialen
    const wgInitials = getInitials(mitglied.werbegebiet);

    // Popup-Karte mit gleicher Struktur wie Grid
    return `
        <div class="schrieb-compact" style="cursor: default; pointer-events: none;">
            <div class="schrieb-compact-header">
                <div class="schrieb-compact-member">
                    <div class="user-badge ${badgeClass} user-badge--small">
                        <div class="user-badge__avatar">${badgeSVG}</div>
                        <div class="user-badge__info">
                            <span class="user-badge__name">${mitglied.name}</span>
                            <span class="user-badge__type">${typeLabel}</span>
                        </div>
                    </div>
                    <div class="schrieb-compact-location">
                        <div class="user-badge user-badge--werbegebiet user-badge--mini">
                            <div class="user-badge__avatar">${wgInitials}</div>
                            <div class="user-badge__info">
                                <span class="user-badge__name">${mitglied.werbegebiet}</span>
                            </div>
                        </div>
                        <span class="schrieb-compact-strasse"><span class="location-emoji">📍</span>${mitglied.strasse} ${mitglied.hausnr}</span>
                    </div>
                </div>
                <div class="schrieb-compact-meta">
                    <span class="schrieb-compact-time">${mitglied.uhrzeit}</span>
                    <span class="schrieb-compact-eh">${mitglied.eh} EH</span>
                </div>
            </div>
            <div class="schrieb-compact-footer">
                <div class="schrieb-compact-status">
                    ${emailIcon}
                    ${ibanHtml}
                </div>
                <div class="user-badge user-badge--werber user-badge--mini">
                    <div class="user-badge__avatar">${botschafterInitials}${getStufeBadge(mitglied.botschafterStufe || '')}</div>
                    <div class="user-badge__info">
                        <span class="user-badge__name">${mitglied.botschafter}</span>
                        <span class="user-badge__type">Werber</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Schrieb/Mitglied Details öffnen
function openSchriebDetails(id) {
    const mitglied = mitgliederData[id];
    if (!mitglied) {
        showToast('Mitglied nicht gefunden', 'error');
        return;
    }

    currentMitglied = mitglied;

    // Card befüllen
    document.getElementById('mitgliedCardLarge').innerHTML = renderMitgliedCardLarge(mitglied);

    // Email-Feld befüllen
    document.getElementById('mitgliedEmail').value = mitglied.email || '';

    // Werbegebiet-Select befüllen
    const wgSelect = document.getElementById('mitgliedWerbegebiet');
    wgSelect.innerHTML = verfuegbareWerbegebiete.map(wg =>
        `<option value="${wg.id}" ${wg.id === mitglied.werbegebietId ? 'selected' : ''}>${wg.name}</option>`
    ).join('');

    // Button disabled states setzen
    const btnWelcome = document.getElementById('btnWelcomeMail');
    const btnIban = document.getElementById('btnIbanMail');
    const btnErhoehung = document.getElementById('btnErhoehungMail');

    // Willkommensmail: disabled wenn IBAN fehlt ODER bei ERH (nur NMG mit IBAN)
    const welcomeDisabled = !mitglied.ibanFilled || mitglied.typ === 'ERH';
    btnWelcome.disabled = welcomeDisabled;
    if (!mitglied.ibanFilled) {
        btnWelcome.title = 'IBAN muss zuerst eingetragen werden';
    } else if (mitglied.typ === 'ERH') {
        btnWelcome.title = 'Nicht verfügbar für Erhöhungen';
    } else {
        btnWelcome.title = 'Willkommensmail senden';
    }

    // IBAN nachtragen Mail: disabled wenn IBAN bereits vorhanden
    btnIban.disabled = mitglied.ibanFilled === true;
    btnIban.title = mitglied.ibanFilled
        ? 'IBAN bereits vorhanden'
        : 'IBAN nachtragen Mail senden';

    // Erhöhungsmail: disabled bei NMG (nur ERH kann Erhöhung haben)
    btnErhoehung.disabled = mitglied.typ === 'NMG';
    btnErhoehung.title = mitglied.typ === 'NMG'
        ? 'Nicht verfügbar für Neumitglieder'
        : 'Erhöhungsmail senden';

    // Modal öffnen
    openModalById('mitgliedModal');
}

// Modal schließen
function closeMitgliedModal() {
    closeModalById('mitgliedModal');
    currentMitglied = null;
}

// Email speichern
function saveMitgliedEmail() {
    if (!currentMitglied) return;

    const newEmail = document.getElementById('mitgliedEmail').value.trim();
    if (!newEmail) {
        showToast('Bitte E-Mail Adresse eingeben', 'warning');
        return;
    }

    // Email-Format prüfen
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newEmail)) {
        showToast('Ungültiges E-Mail Format', 'error');
        return;
    }

    const oldEmail = currentMitglied.email;
    currentMitglied.email = newEmail;
    mitgliederData[currentMitglied.id].email = newEmail;

    if (oldEmail !== newEmail) {
        showToast(`E-Mail geändert: ${newEmail}`, 'success');
    } else {
        showToast('E-Mail gespeichert', 'success');
    }
}

// Werbegebiet ändern
function changeMitgliedWerbegebiet() {
    if (!currentMitglied) return;

    const newWgId = document.getElementById('mitgliedWerbegebiet').value;
    const newWg = verfuegbareWerbegebiete.find(wg => wg.id === newWgId);

    if (newWg && newWgId !== currentMitglied.werbegebietId) {
        currentMitglied.werbegebietId = newWgId;
        currentMitglied.werbegebiet = newWg.name;
        mitgliederData[currentMitglied.id].werbegebietId = newWgId;
        mitgliederData[currentMitglied.id].werbegebiet = newWg.name;

        // Card aktualisieren
        document.getElementById('mitgliedCardLarge').innerHTML = renderMitgliedCardLarge(currentMitglied);

        showToast(`Werbegebiet geändert: ${newWg.name}`, 'success');
    }
}

// Email senden
async function sendMitgliedEmail(type) {
    if (!currentMitglied) return;

    const email = document.getElementById('mitgliedEmail').value.trim();
    if (!email) {
        showToast('Bitte zuerst E-Mail Adresse eingeben', 'warning');
        return;
    }

    const emailTypes = {
        'welcome': 'Willkommensmail',
        'iban': 'IBAN-Aufforderung',
        'erhoehung': 'Erhöhungsmail'
    };

    const typeName = emailTypes[type] || type;

    const confirmed = await showConfirm(
        `${typeName} an "${email}" senden?`,
        'E-Mail senden',
        'info'
    );

    if (confirmed) {
        // Hier würde die API aufgerufen werden
        showToast(`${typeName} wird gesendet an: ${email}`, 'success');

        // Status aktualisieren (Simulation)
        currentMitglied.emailStatus = 'sent';
        mitgliederData[currentMitglied.id].emailStatus = 'sent';
        document.getElementById('mitgliedCardLarge').innerHTML = renderMitgliedCardLarge(currentMitglied);
    }
}

// ============================================
// AUDIT LOG - Letzte 25 Mitglieder
// Nutzt zentrale renderMemberCards() aus member-cards.js
// ============================================
function renderAuditLog() {
    const container = document.getElementById('auditMitgliederGrid');
    if (!container) return;

    // Alle Mitglieder aus mitgliederData als Array (sortiert nach ID absteigend = neueste zuerst)
    // Daten kommen aus Supabase (records Tabelle)
    const allMitglieder = Object.values(mitgliederData).sort((a, b) => b.id - a.id);

    // Nur die ersten 25 nehmen
    const mitglieder = allMitglieder.slice(0, 25);

    // Zentrale renderMemberCards() Funktion verwenden
    if (mitglieder.length === 0) {
        container.innerHTML = '<p class="text-muted">Noch keine Mitglieder erfasst.</p>';
    } else {
        container.innerHTML = renderMemberCards(mitglieder);
    }
}

// Toggle Zahlungsmodalität im WG-Config Panel
function toggleZahlungsmodalitat(element, modality) {
    event.preventDefault();
    const checkbox = element.querySelector('input');

    // Toggle active state
    element.classList.toggle('active');
    checkbox.checked = !checkbox.checked;

    // TODO: Save to database
    console.log('Zahlungsmodalität toggled:', modality, checkbox.checked);
}

// Close view modal
function closeViewModal() {
    closeModalById('campaignViewModal');
    viewingCampaignId = null;
}

// Edit from view modal
function editFromView() {
    if (viewingCampaignId) {
        const campaignIdToEdit = viewingCampaignId; // Speichere ID bevor closeViewModal sie löscht
        closeViewModal();
        editCampaign(campaignIdToEdit);
    }
}

// Close view modal on background click
initModalBackdropClose('campaignViewModal', closeViewModal);

// Save campaign (neue Kampagne erstellen)
async function saveCampaign() {
    const name = document.getElementById('campaignName').value.trim();
    const year = parseInt(document.getElementById('campaignYear').value);
    const kwFrom = parseInt(document.getElementById('kwFrom').value);
    const kwTo = parseInt(document.getElementById('kwTo').value);

    if (!name || !year || !kwFrom || !kwTo) {
        showToast('Bitte alle Pflichtfelder ausfüllen', 'error');
        return;
    }

    if (kwFrom > kwTo) {
        showToast('Von-KW muss kleiner oder gleich Bis-KW sein', 'error');
        return;
    }

    if (kwFrom < 1 || kwTo > 53) {
        showToast('KW muss zwischen 1 und 53 liegen', 'error');
        return;
    }

    try {
        // Start- und Enddatum aus KW berechnen
        function getDateFromKW(kw, year) {
            // ISO 8601: KW1 ist die Woche mit dem ersten Donnerstag des Jahres
            const jan4 = new Date(year, 0, 4);
            const dayOfWeek = jan4.getDay() || 7;
            const firstMonday = new Date(jan4);
            firstMonday.setDate(jan4.getDate() - dayOfWeek + 1);
            const targetDate = new Date(firstMonday);
            targetDate.setDate(firstMonday.getDate() + (kw - 1) * 7);
            return targetDate.toISOString().split('T')[0];
        }

        const startDate = getDateFromKW(kwFrom, year);
        const endDateObj = new Date(getDateFromKW(kwTo, year));
        endDateObj.setDate(endDateObj.getDate() + 6); // Ende der Woche (Sonntag)
        const endDate = endDateObj.toISOString().split('T')[0];

        // In Supabase speichern
        const { data: newCampaignData, error } = await supabase
            .from('campaigns')
            .insert({
                name: name,
                year: year,
                kw_from: kwFrom,
                kw_to: kwTo,
                start_date: startDate,
                end_date: endDate,
                status: 'active'
            })
            .select()
            .single();

        if (error) throw error;

        // Leere Assignments für jede KW erstellen
        const assignmentInserts = [];
        for (let kw = kwFrom; kw <= kwTo; kw++) {
            assignmentInserts.push({
                campaign_id: newCampaignData.id,
                kw: kw,
                teamchef_id: null
            });
        }

        if (assignmentInserts.length > 0) {
            await supabase.from('campaign_assignments').insert(assignmentInserts);
        }

        // Lokale Daten aktualisieren
        const newCampaign = {
            id: newCampaignData.id,
            name: name,
            year: year,
            kwFrom: kwFrom,
            kwTo: kwTo,
            einsatzgebiete: [],
            assignments: {}
        };

        // Leere Assignments lokal erstellen
        for (let kw = kwFrom; kw <= kwTo; kw++) {
            newCampaign.assignments[kw] = { teamchef: null, werber: [] };
        }

        campaigns.push(newCampaign);

        closeCampaignModal();
        renderCampaigns();
        showToast('Kampagne erfolgreich erstellt', 'success');

        // Öffne direkt die Detailansicht der neuen Kampagne
        viewCampaign(newCampaign.id);

    } catch (error) {
        console.error('Fehler beim Speichern der Kampagne:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// Edit campaign
function editCampaign(id) {
    const campaign = campaigns.find(c => c.id === id);
    if (!campaign) return;

    editingCampaignId = id;

    document.getElementById('modalTitle').textContent = 'Kampagne bearbeiten';
    document.getElementById('campaignName').value = campaign.name;
    document.getElementById('kwFrom').value = campaign.kwFrom;
    document.getElementById('kwTo').value = campaign.kwTo;

    // Set customer
    const customerSelect = document.getElementById('customer');
    for (let option of customerSelect.options) {
        if (option.text === campaign.customer) {
            option.selected = true;
            break;
        }
    }

    // Set Abrechnungs-Einstellungen
    document.getElementById('pufferPercent').value = campaign.pufferPercent || 10;
    document.getElementById('wartezeitWochen').value = campaign.wartezeitWochen || 4;

    document.getElementById('saveCampaignBtn').style.display = 'inline-flex';
    openModalById('newCampaignModal');
}

// Modal close on background click
initModalBackdropClose('newCampaignModal', closeCampaignModal);
initModalBackdropClose('attendanceNotesModal', closeNotesModal);
initModalBackdropClose('mitgliedModal', closeMitgliedModal);
initModalBackdropClose('campaignSettingsModal', closeCampaignSettingsModal);

// ============================================
// EINSATZGEBIETE & KONDITIONEN
// ============================================

// Werbegebiete pro Kunde (wird aus Supabase geladen wenn Kunde verknüpft)
const customerAreas = {};

// Verträge pro Kunde (wird aus Supabase geladen wenn Kunde verknüpft)
const customerContracts = {};

// Initial render - Daten aus Supabase laden
(async function init() {
    await loadAllData();

    // Check for URL parameter or sessionStorage to open view modal
    const urlParams = new URLSearchParams(window.location.search);
    let viewId = urlParams.get('view');

    // Also check sessionStorage (set from Kunden page navigation)
    if (!viewId) {
        viewId = sessionStorage.getItem('viewCampaignId');
        if (viewId) {
            sessionStorage.removeItem('viewCampaignId'); // Clear after reading
        }
    }

    if (viewId) {
        const campaign = campaigns.find(c => c.id === viewId || c.id === parseInt(viewId));
        if (campaign) {
            viewCampaign(campaign.id);
        }
    }
})();

// Listen for messages from parent shell
window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'toolbarAction') {
        if (e.data.action === 'add') {
            openCampaignModal();
        }
    }
});
</script>

</body>
</html>
