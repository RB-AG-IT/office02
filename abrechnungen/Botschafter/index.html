<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datensätze - RB Inside Office</title>
    <!-- Zentrale Styles -->
    <link rel="stylesheet" href="../../css/styles.css">
    <script src="../../js/main.js"></script>
    <!-- Zentrale Scripts -->
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- SheetJS für Excel/CSV Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Seiten-spezifische Styles (nur wenn nötig) */
        body {
            background: var(--bg-secondary);
        }
        /* Dropdown-Optionen Stornieren und Löschen ausblenden */
        .dropdown-item.warning,
        .dropdown-item.danger,
        .dropdown-item.warning + .dropdown-divider,
        .dropdown-divider:has(+ .dropdown-item.warning) {
            display: none;
        }
    </style>
</head>
<body class="datensaetze-page">
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <div class="page-header-links">
                <span class="text-ueberschrift-unterabschnitt">Botschafter</span>
            </div>
            <div class="page-header-mitte">
                <span class="text-ueberschrift">Abrechnungen</span>
            </div>
        </div>
        <!-- Lokale Tabs (per Klick navigierbar) -->
        <div class="page-header-tabs" id="datensaetzeSubTabs">
            <div class="kw-tab active" data-tab="records">Übersicht <span class="tab-badge" id="recordsBadge">32</span></div>
            <div class="kw-tab" data-tab="bestand">TEST <span class="tab-badge" id="bestandBadge">142</span></div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content page-content--table">

            <!-- NEUMITGLIEDER / ERHÖHUNGEN TAB -->
            <div class="kw-tab-content active" id="tab-records">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <button class="btn btn-sm active" data-filter="all" onclick="setFilter('all')">Alle</button>
                            <button class="btn btn-sm" data-filter="offenerVorschuss" onclick="setFilter('offenerVorschuss')">Offener Vorschuss</button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Anzeigenfeld 2: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="recordsSelectionGroup">
                            <span class="btn btn-sm" id="recordsSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="recordsSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('records')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="createAbrechnung('records')">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 3: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('records')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('nmg-erh', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="recordsTable">
                            <thead id="recordsTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="recordsTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BESTANDSMITGLIEDER TAB -->
            <div class="kw-tab-content" id="tab-bestand">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden anzeigenfeld--min-height" id="bestandSelectionGroup">
                            <span class="btn btn-sm" id="bestandSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="bestandSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('bestand')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="createAbrechnung('bestand')">
                                <span class="icon icon--dokument"></span>
                                Abrechnung erstellen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 2: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('bestand')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('bestand', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="bestandTable">
                            <thead id="bestandTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="bestandTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="bestandTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
        </div>
    </div><!-- Ende page-content -->
</div><!-- Ende page-container -->

<!-- Storno Modal (aus zentralem Template) -->
    <!-- Wird durch ModalTemplates.init(['storno']) erstellt -->

    <!-- Alle Modals werden durch ModalTemplates.init() erstellt -->
    <!-- Verfügbar: storno, columns, edit, import, export -->

    <!-- Seiten-spezifische Daten und Initialisierung -->
    <script>
        // ========== TEST DATA ==========
        const testRecordsData = [
            { id: 1, offenerVorschuss: '250,00 €', offeneEndabrechnung: '120,00 €', name: 'Max Mustermann', typ: 'nmg', date: '10.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Hauptstraße', houseNumber: '12', zipCode: '60311', city: 'Frankfurt', email: 'max.mustermann@email.de', phoneFixed: '069 12345678', phoneMobile: '0170 1234567', status: 'aktiv' },
            { id: 2, name: 'Anna Schmidt', typ: 'nmg', date: '09.12.2025', je: '60,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Berliner Str.', houseNumber: '45', zipCode: '60311', city: 'Frankfurt', email: 'anna.schmidt@email.de', phoneFixed: '069 23456789', phoneMobile: '0171 2345678', status: 'aktiv' },
            { id: 3, name: 'Peter Weber', typ: 'nmg', date: '08.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Rheinstraße', houseNumber: '78', zipCode: '64283', city: 'Darmstadt', email: 'peter.weber@email.de', phoneFixed: '06151 345678', phoneMobile: '0172 3456789', status: 'aktiv' },
            { id: 4, name: 'Lisa Müller', typ: 'nmg', date: '07.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Goethestraße', houseNumber: '23', zipCode: '60313', city: 'Frankfurt', email: 'lisa.mueller@email.de', phoneFixed: '069 34567890', phoneMobile: '0173 4567890', status: 'storniert' },
            { id: 5, name: 'Julia Wagner', typ: 'nmg', date: '06.12.2025', je: '60,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Sarah Weber', teamchef: 'Petra Schulz', street: 'Kaiserstraße', houseNumber: '56', zipCode: '63065', city: 'Offenbach', email: 'julia.wagner@email.de', phoneFixed: '069 45678901', phoneMobile: '0174 5678901', status: 'aktiv' },
            { id: 6, name: 'Daniel Hoffmann', typ: 'nmg', date: '05.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Thomas Müller', teamchef: 'Markus Lang', street: 'Wilhelmstraße', houseNumber: '89', zipCode: '65183', city: 'Wiesbaden', email: 'daniel.hoffmann@email.de', phoneFixed: '0611 567890', phoneMobile: '0175 6789012', status: 'aktiv' },
            { id: 7, name: 'Sandra Klein', typ: 'nmg', date: '04.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Schillerstraße', houseNumber: '34', zipCode: '60313', city: 'Frankfurt', email: 'sandra.klein@email.de', phoneFixed: '069 56789012', phoneMobile: '0176 7890123', status: 'aktiv' },
            { id: 8, name: 'Markus Bauer', typ: 'nmg', date: '03.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Luisenplatz', houseNumber: '7', zipCode: '64283', city: 'Darmstadt', email: 'markus.bauer@email.de', phoneFixed: '06151 678901', phoneMobile: '0177 8901234', status: 'aktiv' },
            { id: 9, name: 'Katrin Schulz', typ: 'nmg', date: '02.12.2025', je: '60,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Frankfurter Str.', houseNumber: '123', zipCode: '63065', city: 'Offenbach', email: 'katrin.schulz@email.de', phoneFixed: '069 67890123', phoneMobile: '0178 9012345', status: 'aktiv' },
            { id: 10, name: 'Christian Wolf', typ: 'nmg', date: '01.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Bahnhofstraße', houseNumber: '45', zipCode: '65183', city: 'Wiesbaden', email: 'christian.wolf@email.de', phoneFixed: '0611 789012', phoneMobile: '0179 0123456', status: 'aktiv' },
            { id: 101, name: 'Klaus Becker', typ: 'erh', date: '10.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Adlerstraße', houseNumber: '77', zipCode: '60316', city: 'Frankfurt', email: 'klaus.becker@email.de', phoneFixed: '069 55667788', phoneMobile: '0175 8789012', status: 'aktiv' },
            { id: 102, name: 'Maria Schneider', typ: 'erh', date: '08.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Elisabethenstr.', houseNumber: '88', zipCode: '64283', city: 'Darmstadt', email: 'maria.schneider@email.de', phoneFixed: '06151 667788', phoneMobile: '0176 9890123', status: 'aktiv' },
            { id: 103, name: 'Stefan Koch', typ: 'erh', date: '05.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Taunusstraße', houseNumber: '99', zipCode: '65185', city: 'Wiesbaden', email: 'stefan.koch@email.de', phoneFixed: '0611 778899', phoneMobile: '0177 0901234', status: 'aktiv' },
            { id: 104, name: 'Heike Lorenz', typ: 'erh', date: '04.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Münchener Str.', houseNumber: '10', zipCode: '60329', city: 'Frankfurt', email: 'heike.lorenz@email.de', phoneFixed: '069 66778899', phoneMobile: '0178 1012345', status: 'aktiv' },
            { id: 105, name: 'Jürgen Schuster', typ: 'erh', date: '03.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Heinrichstraße', houseNumber: '21', zipCode: '64283', city: 'Darmstadt', email: 'juergen.schuster@email.de', phoneFixed: '06151 889900', phoneMobile: '0179 2123456', status: 'storniert' },
            { id: 11, name: 'Tobias Richter', typ: 'nmg', date: '30.11.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Bergstraße', houseNumber: '15', zipCode: '60311', city: 'Frankfurt', email: 'tobias.richter@email.de', phoneFixed: '069 11223344', phoneMobile: '0170 2233445', status: 'aktiv' },
            { id: 12, name: 'Sabine Hartmann', typ: 'nmg', date: '29.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Parkstraße', houseNumber: '8', zipCode: '64283', city: 'Darmstadt', email: 'sabine.hartmann@email.de', phoneFixed: '06151 223344', phoneMobile: '0171 3344556', status: 'aktiv' },
            { id: 13, name: 'Andreas Vogel', typ: 'nmg', date: '28.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Ringstraße', houseNumber: '22', zipCode: '65183', city: 'Wiesbaden', email: 'andreas.vogel@email.de', phoneFixed: '0611 334455', phoneMobile: '0172 4455667', status: 'aktiv' },
            { id: 14, name: 'Monika Krause', typ: 'nmg', date: '27.11.2025', je: '240,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Waldweg', houseNumber: '33', zipCode: '63065', city: 'Offenbach', email: 'monika.krause@email.de', phoneFixed: '069 445566', phoneMobile: '0173 5566778', status: 'aktiv' },
            { id: 15, name: 'Rainer Schwarz', typ: 'nmg', date: '26.11.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Lindenallee', houseNumber: '44', zipCode: '60329', city: 'Frankfurt', email: 'rainer.schwarz@email.de', phoneFixed: '069 556677', phoneMobile: '0174 6677889', status: 'aktiv' },
            { id: 16, name: 'Eva Zimmermann', typ: 'nmg', date: '25.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Michael Braun', teamchef: 'Klaus Fischer', street: 'Schulstraße', houseNumber: '55', zipCode: '64283', city: 'Darmstadt', email: 'eva.zimmermann@email.de', phoneFixed: '06151 667788', phoneMobile: '0175 7788990', status: 'aktiv' },
            { id: 17, name: 'Frank Berger', typ: 'nmg', date: '24.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Thomas Müller', teamchef: 'Markus Lang', street: 'Kirchplatz', houseNumber: '66', zipCode: '65185', city: 'Wiesbaden', email: 'frank.berger@email.de', phoneFixed: '0611 778899', phoneMobile: '0176 8899001', status: 'aktiv' },
            { id: 18, name: 'Claudia Werner', typ: 'nmg', date: '23.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Marktplatz', houseNumber: '77', zipCode: '60313', city: 'Frankfurt', email: 'claudia.werner@email.de', phoneFixed: '069 889900', phoneMobile: '0177 9900112', status: 'storniert' },
            { id: 19, name: 'Uwe Friedrich', typ: 'nmg', date: '22.11.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Michael Braun', teamchef: 'Petra Schulz', street: 'Gartenweg', houseNumber: '88', zipCode: '63065', city: 'Offenbach', email: 'uwe.friedrich@email.de', phoneFixed: '069 990011', phoneMobile: '0178 0011223', status: 'aktiv' },
            { id: 20, name: 'Birgit Keller', typ: 'nmg', date: '21.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Brunnenweg', houseNumber: '99', zipCode: '64283', city: 'Darmstadt', email: 'birgit.keller@email.de', phoneFixed: '06151 001122', phoneMobile: '0179 1122334', status: 'aktiv' },
            { id: 21, name: 'Holger Lange', typ: 'nmg', date: '20.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Sarah Weber', teamchef: 'Markus Lang', street: 'Eichenweg', houseNumber: '11', zipCode: '65183', city: 'Wiesbaden', email: 'holger.lange@email.de', phoneFixed: '0611 112233', phoneMobile: '0170 2233446', status: 'aktiv' },
            { id: 22, name: 'Petra Hofmann', typ: 'nmg', date: '19.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Tulpenweg', houseNumber: '22', zipCode: '60329', city: 'Frankfurt', email: 'petra.hofmann@email.de', phoneFixed: '069 223344', phoneMobile: '0171 3344557', status: 'aktiv' },
            { id: 23, name: 'Jens Walter', typ: 'nmg', date: '18.11.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Rosenstraße', houseNumber: '33', zipCode: '63065', city: 'Offenbach', email: 'jens.walter@email.de', phoneFixed: '069 334455', phoneMobile: '0172 4455668', status: 'aktiv' },
            { id: 24, name: 'Silke Brandt', typ: 'nmg', date: '17.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Nelkenweg', houseNumber: '44', zipCode: '64283', city: 'Darmstadt', email: 'silke.brandt@email.de', phoneFixed: '06151 445566', phoneMobile: '0173 5566779', status: 'aktiv' },
            { id: 25, name: 'Dirk Sommer', typ: 'nmg', date: '16.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Sonnenallee', houseNumber: '55', zipCode: '65185', city: 'Wiesbaden', email: 'dirk.sommer@email.de', phoneFixed: '0611 556677', phoneMobile: '0174 6677880', status: 'aktiv' },
            { id: 106, name: 'Renate Fuchs', typ: 'erh', date: '02.12.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Fuchsgasse', houseNumber: '12', zipCode: '60311', city: 'Frankfurt', email: 'renate.fuchs@email.de', phoneFixed: '069 112233', phoneMobile: '0175 1122334', status: 'aktiv' },
            { id: 107, name: 'Gerhard Stein', typ: 'erh', date: '01.12.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Sarah Weber', teamchef: 'Petra Schulz', street: 'Steinweg', houseNumber: '23', zipCode: '63065', city: 'Offenbach', email: 'gerhard.stein@email.de', phoneFixed: '069 223344', phoneMobile: '0176 2233445', status: 'aktiv' },
            { id: 108, name: 'Karin Neumann', typ: 'erh', date: '30.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Neuweg', houseNumber: '34', zipCode: '65183', city: 'Wiesbaden', email: 'karin.neumann@email.de', phoneFixed: '0611 334455', phoneMobile: '0177 3344556', status: 'aktiv' },
            { id: 109, name: 'Werner Krüger', typ: 'erh', date: '29.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Krügerstraße', houseNumber: '45', zipCode: '64283', city: 'Darmstadt', email: 'werner.krueger@email.de', phoneFixed: '06151 445566', phoneMobile: '0178 4455667', status: 'aktiv' },
            { id: 110, name: 'Helga Braun', typ: 'erh', date: '28.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Braunerweg', houseNumber: '56', zipCode: '60329', city: 'Frankfurt', email: 'helga.braun@email.de', phoneFixed: '069 556677', phoneMobile: '0179 5566778', status: 'storniert' },
        ];

        const testBestandData = [
            { id: 201, name: 'Herbert Fischer', memberNr: 'MG-2019-0042', seit: '15.03.2019', je: '120,00 €', email: 'h.fischer@email.de', status: 'aktiv' },
            { id: 202, name: 'Ursula Meier', memberNr: 'MG-2018-0187', seit: '22.08.2018', je: '60,00 €', email: 'u.meier@email.de', status: 'aktiv' },
            { id: 203, name: 'Wolfgang Braun', memberNr: 'MG-2020-0023', seit: '04.01.2020', je: '180,00 €', email: 'w.braun@email.de', status: 'aktiv' },
            { id: 204, name: 'Ingrid Schulz', memberNr: 'MG-2017-0312', seit: '11.11.2017', je: '120,00 €', email: 'i.schulz@email.de', status: 'inaktiv' },
        ];

        const testHistoryData = {
            1: [
                { type: 'neumitglied', date: '10.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
            ],
            101: [
                { type: 'neumitglied', date: '15.03.2023', title: 'Mitglied geworden', detail: 'Beitrag: 3,00 € monatlich' },
                { type: 'erhoehung', date: '10.12.2025', title: 'Beitrag erhöht', detail: 'Von 3,00 € auf 10,00 € monatlich' },
            ],
            201: [
                { type: 'neumitglied', date: '15.03.2019', title: 'Mitglied geworden', detail: 'Beitrag: 5,00 € monatlich' },
                { type: 'erhoehung', date: '01.01.2021', title: 'Beitrag erhöht', detail: 'Von 5,00 € auf 8,00 € monatlich' },
                { type: 'aenderung', date: '15.06.2022', title: 'Adresse geändert', detail: 'Neue Adresse: Musterstr. 12' },
                { type: 'erhoehung', date: '01.01.2024', title: 'Beitrag erhöht', detail: 'Von 8,00 € auf 10,00 € monatlich' },
            ],
            4: [
                { type: 'neumitglied', date: '07.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
                { type: 'storno', date: '09.12.2025', title: 'Storniert', detail: 'Grund: Widerruf' },
            ],
        };

        // Kontext-Daten (würde normalerweise von URL-Parameter oder API kommen)
        const contextData = {
            type: 'kunde',  // 'werber', 'kunde', 'werbegebiet', 'kampagne'
            name: 'DRK KV Ludwigshafen'
        };

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Tabs initialisieren
            initTabs('.kw-tab', '.kw-tab-content');

            // Zentrale Modals initialisieren
            ModalTemplates.init(['storno', 'columns', 'edit', 'import', 'export']);

            // Abrechnungs-eigene Render-Funktion (überschreibt die aus main.js)
            window.renderRecordsTable = renderAbrechnungenTable;

            // Datensätze-System initialisieren mit Test-Daten
            initDatensaetze({
                recordsData: testRecordsData,
                bestandData: testBestandData,
                historyData: testHistoryData,
                contextData: contextData
            });

            // Tab-Badges aktualisieren
            document.getElementById('recordsBadge').textContent = testRecordsData.length;
            document.getElementById('bestandBadge').textContent = testBestandData.length;

            // Register toolbar config with shell (Import/Export for data tables)
            registerToolbarConfig();
        });

        // Abrechnungs-spezifische Render-Funktion (Kopie aus main.js mit zusätzlichen Spalten)
        function renderAbrechnungenTable() {
            let filtered;
            if (currentFilter === 'all') {
                filtered = recordsData;
            } else if (currentFilter === 'offenerVorschuss') {
                // Zeigt Einträge mit offenem Vorschuss (Wert > 0)
                filtered = recordsData.filter(d => {
                    const val = parseFloat(String(d.offenerVorschuss || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                    return val > 0;
                });
            } else {
                filtered = recordsData.filter(d => d.typ === currentFilter);
            }

            // Abrechnungs-spezifische Spalten-Konfiguration
            const config = [
                { id: 'name', visible: true },
                { id: 'personalnummer', visible: true },
                { id: 'abrechnungsnummer', visible: true },
                { id: 'anrede', visible: true },
                { id: 'aktuellerRank', visible: true },
                { id: 'offenerVorschuss', visible: true },
                { id: 'verrechnungenVorschuss', visible: true },
                { id: 'offeneEndabrechnung', visible: true },
                { id: 'verrechnungenEndabrechnung', visible: true },
                { id: 'gesamt', visible: true },
                { id: 'mitglieder', visible: true },
                { id: 'einheiten', visible: true },
                { id: 'street', visible: true },
                { id: 'houseNumber', visible: true },
                { id: 'zipCode', visible: true },
                { id: 'city', visible: true },
                { id: 'land', visible: true },
                { id: 'email', visible: true },
                { id: 'phoneMobile', visible: true },
                { id: 'bankverbindung', visible: true },
                { id: 'status', visible: true }
            ];

            // Header-Definitionen (generische Spaltenbreiten) + zusätzliche Abrechnungs-Spalten
            const headerDefs = {
                name: { class: 'col-name text-left', label: 'Name' },
                personalnummer: { class: 'col-m text-left', label: 'Personalnummer' },
                abrechnungsnummer: { class: 'col-m text-left', label: 'Abrechnungsnummer' },
                anrede: { class: 'col-s text-left', label: 'Anrede' },
                aktuellerRank: { class: 'col-m text-left', label: 'Aktueller Rank' },
                offenerVorschuss: { class: 'col-m text-right', label: 'Offener Vorschuss' },
                verrechnungenVorschuss: { class: 'col-m text-right', label: 'Verrechnungen Vorschuss' },
                offeneEndabrechnung: { class: 'col-m text-right', label: 'Offene Endabrechnung' },
                verrechnungenEndabrechnung: { class: 'col-m text-right', label: 'Verrechnungen Endabrechnung' },
                gesamt: { class: 'col-m text-right', label: 'Gesamt' },
                mitglieder: { class: 'col-s text-right', label: 'Mitglieder' },
                einheiten: { class: 'col-s text-right', label: 'Einheiten' },
                street: { class: 'col-m text-left', label: 'Straße' },
                houseNumber: { class: 'col-s text-left', label: 'Nr' },
                zipCode: { class: 'col-s text-left', label: 'PLZ' },
                city: { class: 'col-m text-left', label: 'Ort' },
                land: { class: 'col-s text-left', label: 'Land' },
                email: { class: 'col-xl text-left', label: 'E-Mail' },
                phoneMobile: { class: 'col-m text-left', label: 'Tel. Mobil' },
                bankverbindung: { class: 'col-xl text-left', label: 'Bankverbindung' },
                status: { class: 'col-s text-center', label: 'Status' }
            };

            // Header rendern
            const sort = currentSort.records;
            const thead = document.getElementById('recordsTableHead');
            if (!thead) return;

            let headerHtml = `<tr>
                <th class="checkbox-cell">
                    <input type="checkbox" class="row-checkbox" id="selectAllRecords" onclick="TableCheckbox.toggleSelectAll(this, 'recordsTableBody'); updateSelectionUI('recordsTableBody')">
                </th>
                <th class="action-cell"></th>`;

            config.forEach(col => {
                const def = headerDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    const sortClass = sort.col === col.id ? (sort.direction === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    headerHtml += `<th class="sortable ${def.class} ${sortClass}" data-col="${col.id}" style="${display}" onclick="sortTable('records', '${col.id}')">
                        ${def.label}
                        <span class="sort-arrows">
                            <span class="icon icon--pfeil-auf arrow-up"></span>
                            <span class="icon icon--pfeil-ab arrow-down"></span>
                        </span>
                    </th>`;
                }
            });
            headerHtml += `<th class="col-spacer"></th></tr>`;
            thead.innerHTML = headerHtml;

            const body = document.getElementById('recordsTableBody');
            if (!body) return;

            body.innerHTML = filtered.map(d => {
                // Spalten-Daten mit Mapping (generische Spaltenbreiten) + zusätzliche Abrechnungs-Spalten
                const colData = {
                    name: { class: 'col-name text-left', html: d.name },
                    personalnummer: { class: 'col-m text-left', html: d.personalnummer || '-' },
                    abrechnungsnummer: { class: 'col-m text-left', html: d.abrechnungsnummer || '-' },
                    anrede: { class: 'col-s text-left', html: d.anrede || '' },
                    aktuellerRank: { class: 'col-m text-left', html: d.aktuellerRank || '-' },
                    offenerVorschuss: { class: 'col-m text-right', html: d.offenerVorschuss || '-' },
                    verrechnungenVorschuss: { class: 'col-m text-right', html: d.verrechnungenVorschuss || '-' },
                    offeneEndabrechnung: { class: 'col-m text-right', html: d.offeneEndabrechnung || '-' },
                    verrechnungenEndabrechnung: { class: 'col-m text-right', html: d.verrechnungenEndabrechnung || '-' },
                    gesamt: { class: 'col-m text-right', html: d.gesamt || '-' },
                    mitglieder: { class: 'col-s text-right', html: d.mitglieder || '0' },
                    einheiten: { class: 'col-s text-right', html: d.einheiten || '0' },
                    street: { class: 'col-m text-left', html: d.street || '' },
                    houseNumber: { class: 'col-s text-left', html: d.houseNumber || '' },
                    zipCode: { class: 'col-s text-left', html: d.zipCode || '' },
                    city: { class: 'col-m text-left', html: d.city || '' },
                    land: { class: 'col-s text-left', html: d.land || 'DE' },
                    email: { class: 'col-xl text-left', html: d.email || '' },
                    phoneMobile: { class: 'col-m text-left', html: d.phoneMobile || '' },
                    bankverbindung: { class: 'col-xl text-left', html: d.bankverbindung || '-' },
                    status: { class: 'col-s text-center', html: `<span class="pill pill--${d.status === 'aktiv' ? 'success' : d.status === 'storniert' ? 'error' : 'inaktiv'}">${d.status}</span>` }
                };

                // Spalten in konfigurierter Reihenfolge rendern
                let columnsHtml = '';
                config.forEach(col => {
                    const data = colData[col.id];
                    if (data) {
                        const display = col.visible ? '' : 'display:none;';
                        columnsHtml += `<td class="${data.class}" style="${display}">${data.html}</td>`;
                    }
                });

                return `
                <tr data-id="${d.id}" data-typ="${d.typ}">
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" onchange="handleRowCheckbox(this, 'records', ${d.id})">
                    </td>
                    <td class="action-cell">
                        <div class="dropdown">
                            <button class="dropdown-btn" onclick="toggleDropdown(this, 'records', ${d.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="handleDropdownAction('edit', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    Bearbeiten
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="handleDropdownAction('mail', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    E-Mail senden
                                </div>
                                <div class="dropdown-item" onclick="handleDropdownAction('pdf', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    PDF Download
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item warning" onclick="handleDropdownAction('storno', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                    </svg>
                                    Stornieren
                                </div>
                                <div class="dropdown-item danger" onclick="handleDropdownAction('delete', this.parentElement)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Löschen
                                </div>
                            </div>
                        </div>
                    </td>
                    ${columnsHtml}
                    <td class="col-spacer"></td>
                </tr>
            `;
            }).join('');

            // Totals-Row rendern
            renderAbrechnungenTotals(filtered, config);
        }

        // Abrechnungs-spezifische Totals-Funktion
        function renderAbrechnungenTotals(data, config) {
            const tfoot = document.getElementById('recordsTableFoot');
            if (!tfoot) return;

            // Spalten-Definitionen für alle Abrechnungs-Spalten
            const columnDefs = {
                name: 'col-name text-left',
                personalnummer: 'col-m text-left',
                abrechnungsnummer: 'col-m text-left',
                anrede: 'col-s text-left',
                aktuellerRank: 'col-m text-left',
                offenerVorschuss: 'col-m text-right',
                verrechnungenVorschuss: 'col-m text-right',
                offeneEndabrechnung: 'col-m text-right',
                verrechnungenEndabrechnung: 'col-m text-right',
                gesamt: 'col-m text-right',
                mitglieder: 'col-s text-right',
                einheiten: 'col-s text-right',
                street: 'col-m text-left',
                houseNumber: 'col-s text-left',
                zipCode: 'col-s text-left',
                city: 'col-m text-left',
                land: 'col-s text-left',
                email: 'col-xl text-left',
                phoneMobile: 'col-m text-left',
                bankverbindung: 'col-xl text-left',
                status: 'col-s text-center'
            };

            // Summen berechnen
            const parseEuro = (val) => {
                if (typeof val === 'number') return val;
                return parseFloat(String(val || '0').replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            };

            const totalOffenerVorschuss = data.reduce((sum, d) => sum + parseEuro(d.offenerVorschuss), 0);
            const totalVerrechnungenVorschuss = data.reduce((sum, d) => sum + parseEuro(d.verrechnungenVorschuss), 0);
            const totalOffeneEndabrechnung = data.reduce((sum, d) => sum + parseEuro(d.offeneEndabrechnung), 0);
            const totalVerrechnungenEndabrechnung = data.reduce((sum, d) => sum + parseEuro(d.verrechnungenEndabrechnung), 0);
            const totalGesamt = data.reduce((sum, d) => sum + parseEuro(d.gesamt), 0);
            const totalMitglieder = data.reduce((sum, d) => sum + (parseInt(d.mitglieder) || 0), 0);
            const totalEinheiten = data.reduce((sum, d) => sum + (parseInt(d.einheiten) || 0), 0);

            const formatEuro = (val) => val.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';

            // Totals-Definitionen
            const totalsDefs = {
                name: { class: 'col-name text-left', html: `Gesamt<span class="totals-count">(${data.length})</span>` },
                personalnummer: { class: 'col-m text-left', html: '' },
                abrechnungsnummer: { class: 'col-m text-left', html: '' },
                anrede: { class: 'col-s text-left', html: '' },
                aktuellerRank: { class: 'col-m text-left', html: '' },
                offenerVorschuss: { class: 'col-m text-right', html: formatEuro(totalOffenerVorschuss) },
                verrechnungenVorschuss: { class: 'col-m text-right', html: formatEuro(totalVerrechnungenVorschuss) },
                offeneEndabrechnung: { class: 'col-m text-right', html: formatEuro(totalOffeneEndabrechnung) },
                verrechnungenEndabrechnung: { class: 'col-m text-right', html: formatEuro(totalVerrechnungenEndabrechnung) },
                gesamt: { class: 'col-m text-right', html: formatEuro(totalGesamt) },
                mitglieder: { class: 'col-s text-right', html: totalMitglieder.toString() },
                einheiten: { class: 'col-s text-right', html: totalEinheiten.toString() },
                street: { class: 'col-m text-left', html: '' },
                houseNumber: { class: 'col-s text-left', html: '' },
                zipCode: { class: 'col-s text-left', html: '' },
                city: { class: 'col-m text-left', html: '' },
                land: { class: 'col-s text-left', html: '' },
                email: { class: 'col-xl text-left', html: '' },
                phoneMobile: { class: 'col-m text-left', html: '' },
                bankverbindung: { class: 'col-xl text-left', html: '' },
                status: { class: 'col-s text-center', html: '' }
            };

            let totalsHtml = '<tr class="totals-row">';
            totalsHtml += '<td class="checkbox-cell"></td>';
            totalsHtml += '<td class="action-cell"></td>';

            config.forEach(col => {
                const def = totalsDefs[col.id];
                if (def) {
                    const display = col.visible ? '' : 'display:none;';
                    totalsHtml += `<td class="${def.class}" style="${display}">${def.html}</td>`;
                }
            });
            totalsHtml += '<td class="col-spacer"></td></tr>';
            tfoot.innerHTML = totalsHtml;
        }

        // Register toolbar buttons for data tables
        function registerToolbarConfig() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'registerToolbar',
                    config: {
                        actionButtons: [
                            { id: 'import', text: 'Import', icon: 'upload', action: 'openImportModal' },
                            { id: 'export', text: 'Export', icon: 'download', action: 'openExportModal', primary: true }
                        ]
                    }
                }, '*');
            }
        }

        // Listen for toolbar actions from shell
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'toolbarAction') {
                if (e.data.action === 'openImportModal' && typeof openImportModal === 'function') {
                    openImportModal();
                } else if (e.data.action === 'openExportModal' && typeof openExportModal === 'function') {
                    openExportModal();
                }
            }
        });
    </script>
</body>
</html>
