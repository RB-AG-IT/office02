<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datensätze - RB Inside Office</title>
    <!-- Zentrale Styles -->
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/main.js"></script>
    <!-- Zentrale Scripts -->
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- SheetJS für Excel/CSV Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Seiten-spezifische Styles (nur wenn nötig) */
        body {
            background: var(--bg-secondary);
        }
    </style>
</head>
<body class="datensaetze-page">
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <button class="btn btn-icon" onclick="goBack()">
                <span class="icon icon--pfeil-links"></span>
            </button>
            <div class="page-header-links">
                <span class="text-klein" id="contextBadge"></span>
            </div>
            <div class="page-header-mitte">
                <span class="text-ueberschrift">Datensätze</span>
            </div>
        </div>
        <!-- Lokale Tabs (per Klick navigierbar) -->
        <div class="page-header-tabs" id="datensaetzeSubTabs">
            <div class="kw-tab active" data-tab="records">Neumitglieder / Erhöhungen <span class="tab-badge" id="recordsBadge">32</span></div>
            <div class="kw-tab" data-tab="bestand">Bestandsmitglieder <span class="tab-badge" id="bestandBadge">142</span></div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content page-content--table">

            <!-- NEUMITGLIEDER / ERHÖHUNGEN TAB -->
            <div class="kw-tab-content active" id="tab-records">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <button class="btn btn-sm active" data-filter="all" onclick="setFilter('all')">Alle</button>
                            <button class="btn btn-sm" data-filter="nmg" onclick="setFilter('nmg')">Neumitglieder</button>
                            <button class="btn btn-sm" data-filter="erh" onclick="setFilter('erh')">Erhöhungen</button>
                            <button class="btn btn-sm" data-filter="storno" onclick="setFilter('storno')">Rückläufer (Stornos)</button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Anzeigenfeld 2: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="recordsSelectionGroup">
                            <span class="btn btn-sm" id="recordsSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="recordsSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('records')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPDF('records')">
                                <span class="icon icon--dokument"></span>
                                PDF
                            </button>
                            <button class="btn btn-sm" onclick="stornoSelected('records')">
                                <span class="icon icon--storno"></span>
                                Stornieren
                            </button>
                            <button class="btn btn-sm" onclick="deleteSelected('records')">
                                <span class="icon icon--loeschen"></span>
                                Löschen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 3: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('records')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('nmg-erh', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="recordsTable">
                            <thead id="recordsTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="recordsTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BESTANDSMITGLIEDER TAB -->
            <div class="kw-tab-content" id="tab-bestand">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden anzeigenfeld--min-height" id="bestandSelectionGroup">
                            <span class="btn btn-sm" id="bestandSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="bestandSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('bestand')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPDF('bestand')">
                                <span class="icon icon--dokument"></span>
                                PDF
                            </button>
                            <button class="btn btn-sm" onclick="stornoSelected('bestand')">
                                <span class="icon icon--storno"></span>
                                Stornieren
                            </button>
                            <button class="btn btn-sm" onclick="deleteSelected('bestand')">
                                <span class="icon icon--loeschen"></span>
                                Löschen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 2: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('bestand')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('bestand', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="bestandTable">
                            <thead id="bestandTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="bestandTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="bestandTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
        </div>
    </div><!-- Ende page-content -->
</div><!-- Ende page-container -->

<!-- Storno Modal (aus zentralem Template) -->
    <!-- Wird durch ModalTemplates.init(['storno']) erstellt -->

    <!-- Alle Modals werden durch ModalTemplates.init() erstellt -->
    <!-- Verfügbar: storno, columns, edit, import, export -->

    <!-- Seiten-spezifische Daten und Initialisierung -->
    <script>
        // ========== SUPABASE CLIENT ==========
        const supabase = window.parent.supabaseClient;

        // ========== DATA (wird aus Supabase geladen) ==========
        // recordsData und bestandData sind bereits in main.js deklariert
        recordsData = [];
        bestandData = [];
        let historyData = {};

        // Lookup-Maps für Namen
        let usersMap = {};      // user_id -> name
        let customersMap = {};  // customer_id -> name
        let areasMap = {};      // area_id -> ort

        // ========== SUPABASE DATA LOADING ==========
        async function loadAllData() {
            try {
                // Erst Lookup-Daten laden
                await Promise.all([
                    loadUsers(),
                    loadCustomers(),
                    loadAreas()
                ]);
                // Dann Records laden
                await loadRecords();
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                if (typeof showToast === 'function') {
                    showToast('Fehler beim Laden der Datensätze', 'error');
                }
            }
        }

        // Users laden (für Werber/Teamchef Namen)
        async function loadUsers() {
            const { data, error } = await supabase
                .from('users')
                .select('id, name');

            if (error) {
                console.error('Fehler beim Laden der Users:', error);
                return;
            }

            usersMap = {};
            (data || []).forEach(u => {
                usersMap[u.id] = u.name;
            });
        }

        // Customers laden (für Kunde Namen)
        async function loadCustomers() {
            const { data, error } = await supabase
                .from('customers')
                .select('id, name, full_name');

            if (error) {
                console.error('Fehler beim Laden der Customers:', error);
                return;
            }

            customersMap = {};
            (data || []).forEach(c => {
                customersMap[c.id] = c.full_name || c.name;
            });
        }

        // Werbegebiete laden (für Gebiet Namen)
        async function loadAreas() {
            const { data, error } = await supabase
                .from('werbegebiete')
                .select('id, ort, plz');

            if (error) {
                console.error('Fehler beim Laden der Werbegebiete:', error);
                return;
            }

            areasMap = {};
            (data || []).forEach(a => {
                areasMap[a.id] = `${a.ort} (${a.plz})`;
            });
        }

        // Records laden und transformieren
        async function loadRecords() {
            const { data, error } = await supabase
                .from('records')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Fehler beim Laden der Records:', error);
                return;
            }

            // Records transformieren ins Frontend-Format
            recordsData = (data || []).map(r => transformRecord(r));
        }

        // Einzelnen Record transformieren
        function transformRecord(r) {
            // Datum formatieren (DD.MM.YYYY)
            const createdDate = r.created_at ? new Date(r.created_at) : new Date();
            const dateStr = createdDate.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // JE formatieren
            const je = r.yearly_amount || 0;
            const jeFormatted = je.toLocaleString('de-DE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' €';

            // Typ mapping
            const typ = r.record_type === 'erhoehung' ? 'erh' : 'nmg';

            // Status mapping
            const status = r.record_status === 'storno' ? 'storniert' : 'aktiv';

            return {
                id: r.id,
                name: [r.first_name, r.last_name].filter(Boolean).join(' ') || 'Unbekannt',
                typ: typ,
                date: dateStr,
                je: jeFormatted,
                jeValue: je,
                kunde: customersMap[r.customer_id] || '-',
                gebiet: areasMap[r.area_id] || '-',
                werber: usersMap[r.werber_id] || '-',
                teamchef: usersMap[r.teamchef_id] || '-',
                street: r.street || '',
                houseNumber: r.house_number || '',
                zipCode: r.zip_code || '',
                city: r.city || '',
                email: r.email || '',
                phoneFixed: r.phone_fixed || '',
                phoneMobile: r.phone_mobile || '',
                status: status,
                // Zusätzliche Felder für Detail-Ansicht
                salutation: r.salutation || '',
                title: r.title || '',
                company: r.company || '',
                birthDate: r.birth_date || '',
                iban: r.iban || '',
                bic: r.bic || '',
                bankName: r.bank_name || '',
                amount: r.amount || 0,
                interval: r.interval || '',
                memberNumber: r.member_number || '',
                memberSince: r.member_since || '',
                oldAmount: r.old_amount || 0,
                notes: r.notes || '',
                stornoDate: r.storno_date || '',
                stornoReason: r.storno_reason || '',
                // Original-Daten für Updates
                _raw: r
            };
        }

        // Kontext-Daten aus URL-Parametern
        function getContextData() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                type: urlParams.get('type') || 'alle',
                id: urlParams.get('id') || null,
                name: urlParams.get('name') || 'Alle Datensätze'
            };
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // Tabs initialisieren
            initTabs('.kw-tab', '.kw-tab-content');

            // Zentrale Modals initialisieren
            ModalTemplates.init(['storno', 'columns', 'edit', 'import', 'export']);

            // Daten aus Supabase laden
            await loadAllData();

            // Kontext aus URL
            const contextData = getContextData();

            // Datensätze-System initialisieren mit Supabase-Daten
            initDatensaetze({
                recordsData: recordsData,
                bestandData: bestandData,
                historyData: historyData,
                contextData: contextData
            });

            // Tab-Badges aktualisieren
            document.getElementById('recordsBadge').textContent = recordsData.length;
            document.getElementById('bestandBadge').textContent = bestandData.length;

            // Register toolbar config with shell (Import/Export for data tables)
            registerToolbarConfig();
        });

        // Register toolbar buttons for data tables
        function registerToolbarConfig() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'registerToolbar',
                    config: {
                        actionButtons: [
                            { id: 'import', text: 'Import', icon: 'upload', action: 'openImportModal' },
                            { id: 'export', text: 'Export', icon: 'download', action: 'openExportModal', primary: true }
                        ]
                    }
                }, '*');
            }
        }

        // Listen for toolbar actions from shell
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'toolbarAction') {
                if (e.data.action === 'openImportModal' && typeof openImportModal === 'function') {
                    openImportModal();
                } else if (e.data.action === 'openExportModal' && typeof openExportModal === 'function') {
                    openExportModal();
                }
            }
        });
    </script>
</body>
</html>
