<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datensätze - RB Inside Office</title>
    <!-- Zentrale Styles -->
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/main.js"></script>
    <!-- Zentrale Scripts -->
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <!-- SheetJS für Excel/CSV Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Seiten-spezifische Styles (nur wenn nötig) */
        body {
            background: var(--bg-secondary);
        }
    </style>
</head>
<body class="datensaetze-page">
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-row">
            <button class="btn btn-icon" onclick="goBack()">
                <span class="icon icon--pfeil-links"></span>
            </button>
            <div class="page-header-links">
                <span class="text-klein" id="contextBadge"></span>
            </div>
            <div class="page-header-mitte">
                <span class="text-ueberschrift">Datensätze</span>
            </div>
        </div>
        <!-- Lokale Tabs (per Klick navigierbar) -->
        <div class="page-header-tabs" id="datensaetzeSubTabs">
            <div class="kw-tab active" data-tab="records">Neumitglieder / Erhöhungen <span class="tab-badge" id="recordsBadge">32</span></div>
            <div class="kw-tab" data-tab="bestand">Bestandsmitglieder <span class="tab-badge" id="bestandBadge">142</span></div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content page-content--table">

            <!-- NEUMITGLIEDER / ERHÖHUNGEN TAB -->
            <div class="kw-tab-content active" id="tab-records">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Filter -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--min-height">
                            <button class="btn btn-sm active" data-filter="all" onclick="setFilter('all')">Alle</button>
                            <button class="btn btn-sm" data-filter="nmg" onclick="setFilter('nmg')">Neumitglieder</button>
                            <button class="btn btn-sm" data-filter="erh" onclick="setFilter('erh')">Erhöhungen</button>
                            <button class="btn btn-sm" data-filter="storno" onclick="setFilter('storno')">Rückläufer (Stornos)</button>
                        </div>
                        <div class="anzeigenfeld anzeigenfeld--divider"></div>
                        <!-- Anzeigenfeld 2: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden" id="recordsSelectionGroup">
                            <span class="btn btn-sm" id="recordsSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="recordsSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('records')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPDF('records')">
                                <span class="icon icon--dokument"></span>
                                PDF
                            </button>
                            <button class="btn btn-sm" onclick="stornoSelected('records')">
                                <span class="icon icon--storno"></span>
                                Stornieren
                            </button>
                            <button class="btn btn-sm" onclick="deleteSelected('records')">
                                <span class="icon icon--loeschen"></span>
                                Löschen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 3: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('records')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('nmg-erh', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="recordsTable">
                            <thead id="recordsTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="recordsTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="recordsTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BESTANDSMITGLIEDER TAB -->
            <div class="kw-tab-content" id="tab-bestand">
                <div class="table-wrap">
                    <div class="zeile">
                        <!-- Anzeigenfeld 1: Auswahl-Aktionen (erscheint bei Selektion) -->
                        <div class="anzeigenfeld anzeigenfeld--auto anzeigenfeld--hidden anzeigenfeld--min-height" id="bestandSelectionGroup">
                            <span class="btn btn-sm" id="bestandSelectionBtn">
                                <span class="icon icon--clipboard"></span>
                                Ausgewählt: <span id="bestandSelectedCount">0</span>
                            </span>
                            <button class="btn btn-sm" onclick="sendMail('bestand')">
                                <span class="icon icon--email"></span>
                                E-Mail
                            </button>
                            <button class="btn btn-sm" onclick="downloadPDF('bestand')">
                                <span class="icon icon--dokument"></span>
                                PDF
                            </button>
                            <button class="btn btn-sm" onclick="stornoSelected('bestand')">
                                <span class="icon icon--storno"></span>
                                Stornieren
                            </button>
                            <button class="btn btn-sm" onclick="deleteSelected('bestand')">
                                <span class="icon icon--loeschen"></span>
                                Löschen
                            </button>
                        </div>
                        <!-- Spacer -->
                        <div class="anzeigenfeld anzeigenfeld--spacer"></div>
                        <!-- Anzeigenfeld 2: Spalten & Audit (rechts) -->
                        <div class="anzeigenfeld anzeigenfeld--auto">
                            <button class="btn btn-sm" onclick="openColumnsModal('bestand')">
                                <span class="icon icon--spalten"></span>
                                Spalten
                            </button>
                            <button class="btn btn-sm" onclick="openAuditModal('bestand', 'default')">
                                <span class="icon icon--uhr"></span>
                                Audit
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table--compact" id="bestandTable">
                            <thead id="bestandTableHead">
                                <!-- Wird dynamisch gerendert -->
                            </thead>
                            <tbody id="bestandTableBody">
                                <!-- Wird dynamisch gerendert -->
                            </tbody>
                            <tfoot id="bestandTableFoot">
                                <!-- Wird dynamisch gerendert -->
                            </tfoot>
                        </table>
                    </div>
                </div>
        </div>
    </div><!-- Ende page-content -->
</div><!-- Ende page-container -->

<!-- Storno Modal (aus zentralem Template) -->
    <!-- Wird durch ModalTemplates.init(['storno']) erstellt -->

    <!-- Alle Modals werden durch ModalTemplates.init() erstellt -->
    <!-- Verfügbar: storno, columns, edit, import, export -->

    <!-- Seiten-spezifische Daten und Initialisierung -->
    <script>
        // ========== TEST DATA ==========
        const testRecordsData = [
            { id: 1, name: 'Max Mustermann', typ: 'nmg', date: '10.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Hauptstraße', houseNumber: '12', zipCode: '60311', city: 'Frankfurt', email: 'max.mustermann@email.de', phoneFixed: '069 12345678', phoneMobile: '0170 1234567', status: 'aktiv' },
            { id: 2, name: 'Anna Schmidt', typ: 'nmg', date: '09.12.2025', je: '60,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Berliner Str.', houseNumber: '45', zipCode: '60311', city: 'Frankfurt', email: 'anna.schmidt@email.de', phoneFixed: '069 23456789', phoneMobile: '0171 2345678', status: 'aktiv' },
            { id: 3, name: 'Peter Weber', typ: 'nmg', date: '08.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Rheinstraße', houseNumber: '78', zipCode: '64283', city: 'Darmstadt', email: 'peter.weber@email.de', phoneFixed: '06151 345678', phoneMobile: '0172 3456789', status: 'aktiv' },
            { id: 4, name: 'Lisa Müller', typ: 'nmg', date: '07.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Goethestraße', houseNumber: '23', zipCode: '60313', city: 'Frankfurt', email: 'lisa.mueller@email.de', phoneFixed: '069 34567890', phoneMobile: '0173 4567890', status: 'storniert' },
            { id: 5, name: 'Julia Wagner', typ: 'nmg', date: '06.12.2025', je: '60,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Sarah Weber', teamchef: 'Petra Schulz', street: 'Kaiserstraße', houseNumber: '56', zipCode: '63065', city: 'Offenbach', email: 'julia.wagner@email.de', phoneFixed: '069 45678901', phoneMobile: '0174 5678901', status: 'aktiv' },
            { id: 6, name: 'Daniel Hoffmann', typ: 'nmg', date: '05.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Thomas Müller', teamchef: 'Markus Lang', street: 'Wilhelmstraße', houseNumber: '89', zipCode: '65183', city: 'Wiesbaden', email: 'daniel.hoffmann@email.de', phoneFixed: '0611 567890', phoneMobile: '0175 6789012', status: 'aktiv' },
            { id: 7, name: 'Sandra Klein', typ: 'nmg', date: '04.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Schillerstraße', houseNumber: '34', zipCode: '60313', city: 'Frankfurt', email: 'sandra.klein@email.de', phoneFixed: '069 56789012', phoneMobile: '0176 7890123', status: 'aktiv' },
            { id: 8, name: 'Markus Bauer', typ: 'nmg', date: '03.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Luisenplatz', houseNumber: '7', zipCode: '64283', city: 'Darmstadt', email: 'markus.bauer@email.de', phoneFixed: '06151 678901', phoneMobile: '0177 8901234', status: 'aktiv' },
            { id: 9, name: 'Katrin Schulz', typ: 'nmg', date: '02.12.2025', je: '60,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Frankfurter Str.', houseNumber: '123', zipCode: '63065', city: 'Offenbach', email: 'katrin.schulz@email.de', phoneFixed: '069 67890123', phoneMobile: '0178 9012345', status: 'aktiv' },
            { id: 10, name: 'Christian Wolf', typ: 'nmg', date: '01.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Bahnhofstraße', houseNumber: '45', zipCode: '65183', city: 'Wiesbaden', email: 'christian.wolf@email.de', phoneFixed: '0611 789012', phoneMobile: '0179 0123456', status: 'aktiv' },
            { id: 101, name: 'Klaus Becker', typ: 'erh', date: '10.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Adlerstraße', houseNumber: '77', zipCode: '60316', city: 'Frankfurt', email: 'klaus.becker@email.de', phoneFixed: '069 55667788', phoneMobile: '0175 8789012', status: 'aktiv' },
            { id: 102, name: 'Maria Schneider', typ: 'erh', date: '08.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Elisabethenstr.', houseNumber: '88', zipCode: '64283', city: 'Darmstadt', email: 'maria.schneider@email.de', phoneFixed: '06151 667788', phoneMobile: '0176 9890123', status: 'aktiv' },
            { id: 103, name: 'Stefan Koch', typ: 'erh', date: '05.12.2025', je: '240,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Taunusstraße', houseNumber: '99', zipCode: '65185', city: 'Wiesbaden', email: 'stefan.koch@email.de', phoneFixed: '0611 778899', phoneMobile: '0177 0901234', status: 'aktiv' },
            { id: 104, name: 'Heike Lorenz', typ: 'erh', date: '04.12.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Münchener Str.', houseNumber: '10', zipCode: '60329', city: 'Frankfurt', email: 'heike.lorenz@email.de', phoneFixed: '069 66778899', phoneMobile: '0178 1012345', status: 'aktiv' },
            { id: 105, name: 'Jürgen Schuster', typ: 'erh', date: '03.12.2025', je: '180,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Heinrichstraße', houseNumber: '21', zipCode: '64283', city: 'Darmstadt', email: 'juergen.schuster@email.de', phoneFixed: '06151 889900', phoneMobile: '0179 2123456', status: 'storniert' },
            { id: 11, name: 'Tobias Richter', typ: 'nmg', date: '30.11.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Bergstraße', houseNumber: '15', zipCode: '60311', city: 'Frankfurt', email: 'tobias.richter@email.de', phoneFixed: '069 11223344', phoneMobile: '0170 2233445', status: 'aktiv' },
            { id: 12, name: 'Sabine Hartmann', typ: 'nmg', date: '29.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Parkstraße', houseNumber: '8', zipCode: '64283', city: 'Darmstadt', email: 'sabine.hartmann@email.de', phoneFixed: '06151 223344', phoneMobile: '0171 3344556', status: 'aktiv' },
            { id: 13, name: 'Andreas Vogel', typ: 'nmg', date: '28.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Ringstraße', houseNumber: '22', zipCode: '65183', city: 'Wiesbaden', email: 'andreas.vogel@email.de', phoneFixed: '0611 334455', phoneMobile: '0172 4455667', status: 'aktiv' },
            { id: 14, name: 'Monika Krause', typ: 'nmg', date: '27.11.2025', je: '240,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Waldweg', houseNumber: '33', zipCode: '63065', city: 'Offenbach', email: 'monika.krause@email.de', phoneFixed: '069 445566', phoneMobile: '0173 5566778', status: 'aktiv' },
            { id: 15, name: 'Rainer Schwarz', typ: 'nmg', date: '26.11.2025', je: '120,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Lindenallee', houseNumber: '44', zipCode: '60329', city: 'Frankfurt', email: 'rainer.schwarz@email.de', phoneFixed: '069 556677', phoneMobile: '0174 6677889', status: 'aktiv' },
            { id: 16, name: 'Eva Zimmermann', typ: 'nmg', date: '25.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Michael Braun', teamchef: 'Klaus Fischer', street: 'Schulstraße', houseNumber: '55', zipCode: '64283', city: 'Darmstadt', email: 'eva.zimmermann@email.de', phoneFixed: '06151 667788', phoneMobile: '0175 7788990', status: 'aktiv' },
            { id: 17, name: 'Frank Berger', typ: 'nmg', date: '24.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Thomas Müller', teamchef: 'Markus Lang', street: 'Kirchplatz', houseNumber: '66', zipCode: '65185', city: 'Wiesbaden', email: 'frank.berger@email.de', phoneFixed: '0611 778899', phoneMobile: '0176 8899001', status: 'aktiv' },
            { id: 18, name: 'Claudia Werner', typ: 'nmg', date: '23.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Marktplatz', houseNumber: '77', zipCode: '60313', city: 'Frankfurt', email: 'claudia.werner@email.de', phoneFixed: '069 889900', phoneMobile: '0177 9900112', status: 'storniert' },
            { id: 19, name: 'Uwe Friedrich', typ: 'nmg', date: '22.11.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Michael Braun', teamchef: 'Petra Schulz', street: 'Gartenweg', houseNumber: '88', zipCode: '63065', city: 'Offenbach', email: 'uwe.friedrich@email.de', phoneFixed: '069 990011', phoneMobile: '0178 0011223', status: 'aktiv' },
            { id: 20, name: 'Birgit Keller', typ: 'nmg', date: '21.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Brunnenweg', houseNumber: '99', zipCode: '64283', city: 'Darmstadt', email: 'birgit.keller@email.de', phoneFixed: '06151 001122', phoneMobile: '0179 1122334', status: 'aktiv' },
            { id: 21, name: 'Holger Lange', typ: 'nmg', date: '20.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Sarah Weber', teamchef: 'Markus Lang', street: 'Eichenweg', houseNumber: '11', zipCode: '65183', city: 'Wiesbaden', email: 'holger.lange@email.de', phoneFixed: '0611 112233', phoneMobile: '0170 2233446', status: 'aktiv' },
            { id: 22, name: 'Petra Hofmann', typ: 'nmg', date: '19.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Michael Braun', teamchef: 'Hans Meier', street: 'Tulpenweg', houseNumber: '22', zipCode: '60329', city: 'Frankfurt', email: 'petra.hofmann@email.de', phoneFixed: '069 223344', phoneMobile: '0171 3344557', status: 'aktiv' },
            { id: 23, name: 'Jens Walter', typ: 'nmg', date: '18.11.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Thomas Müller', teamchef: 'Petra Schulz', street: 'Rosenstraße', houseNumber: '33', zipCode: '63065', city: 'Offenbach', email: 'jens.walter@email.de', phoneFixed: '069 334455', phoneMobile: '0172 4455668', status: 'aktiv' },
            { id: 24, name: 'Silke Brandt', typ: 'nmg', date: '17.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Sarah Weber', teamchef: 'Klaus Fischer', street: 'Nelkenweg', houseNumber: '44', zipCode: '64283', city: 'Darmstadt', email: 'silke.brandt@email.de', phoneFixed: '06151 445566', phoneMobile: '0173 5566779', status: 'aktiv' },
            { id: 25, name: 'Dirk Sommer', typ: 'nmg', date: '16.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Sonnenallee', houseNumber: '55', zipCode: '65185', city: 'Wiesbaden', email: 'dirk.sommer@email.de', phoneFixed: '0611 556677', phoneMobile: '0174 6677880', status: 'aktiv' },
            { id: 106, name: 'Renate Fuchs', typ: 'erh', date: '02.12.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Nord', werber: 'Thomas Müller', teamchef: 'Hans Meier', street: 'Fuchsgasse', houseNumber: '12', zipCode: '60311', city: 'Frankfurt', email: 'renate.fuchs@email.de', phoneFixed: '069 112233', phoneMobile: '0175 1122334', status: 'aktiv' },
            { id: 107, name: 'Gerhard Stein', typ: 'erh', date: '01.12.2025', je: '120,00 €', kunde: 'DRK KV Offenbach', gebiet: 'Offenbach', werber: 'Sarah Weber', teamchef: 'Petra Schulz', street: 'Steinweg', houseNumber: '23', zipCode: '63065', city: 'Offenbach', email: 'gerhard.stein@email.de', phoneFixed: '069 223344', phoneMobile: '0176 2233445', status: 'aktiv' },
            { id: 108, name: 'Karin Neumann', typ: 'erh', date: '30.11.2025', je: '180,00 €', kunde: 'DRK KV Wiesbaden', gebiet: 'Wiesbaden', werber: 'Michael Braun', teamchef: 'Markus Lang', street: 'Neuweg', houseNumber: '34', zipCode: '65183', city: 'Wiesbaden', email: 'karin.neumann@email.de', phoneFixed: '0611 334455', phoneMobile: '0177 3344556', status: 'aktiv' },
            { id: 109, name: 'Werner Krüger', typ: 'erh', date: '29.11.2025', je: '60,00 €', kunde: 'DRK KV Darmstadt', gebiet: 'Darmstadt', werber: 'Thomas Müller', teamchef: 'Klaus Fischer', street: 'Krügerstraße', houseNumber: '45', zipCode: '64283', city: 'Darmstadt', email: 'werner.krueger@email.de', phoneFixed: '06151 445566', phoneMobile: '0178 4455667', status: 'aktiv' },
            { id: 110, name: 'Helga Braun', typ: 'erh', date: '28.11.2025', je: '240,00 €', kunde: 'DRK KV Frankfurt', gebiet: 'Frankfurt Süd', werber: 'Sarah Weber', teamchef: 'Hans Meier', street: 'Braunerweg', houseNumber: '56', zipCode: '60329', city: 'Frankfurt', email: 'helga.braun@email.de', phoneFixed: '069 556677', phoneMobile: '0179 5566778', status: 'storniert' },
        ];

        const testBestandData = [
            { id: 201, name: 'Herbert Fischer', memberNr: 'MG-2019-0042', seit: '15.03.2019', je: '120,00 €', email: 'h.fischer@email.de', status: 'aktiv' },
            { id: 202, name: 'Ursula Meier', memberNr: 'MG-2018-0187', seit: '22.08.2018', je: '60,00 €', email: 'u.meier@email.de', status: 'aktiv' },
            { id: 203, name: 'Wolfgang Braun', memberNr: 'MG-2020-0023', seit: '04.01.2020', je: '180,00 €', email: 'w.braun@email.de', status: 'aktiv' },
            { id: 204, name: 'Ingrid Schulz', memberNr: 'MG-2017-0312', seit: '11.11.2017', je: '120,00 €', email: 'i.schulz@email.de', status: 'inaktiv' },
        ];

        const testHistoryData = {
            1: [
                { type: 'neumitglied', date: '10.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
            ],
            101: [
                { type: 'neumitglied', date: '15.03.2023', title: 'Mitglied geworden', detail: 'Beitrag: 3,00 € monatlich' },
                { type: 'erhoehung', date: '10.12.2025', title: 'Beitrag erhöht', detail: 'Von 3,00 € auf 10,00 € monatlich' },
            ],
            201: [
                { type: 'neumitglied', date: '15.03.2019', title: 'Mitglied geworden', detail: 'Beitrag: 5,00 € monatlich' },
                { type: 'erhoehung', date: '01.01.2021', title: 'Beitrag erhöht', detail: 'Von 5,00 € auf 8,00 € monatlich' },
                { type: 'aenderung', date: '15.06.2022', title: 'Adresse geändert', detail: 'Neue Adresse: Musterstr. 12' },
                { type: 'erhoehung', date: '01.01.2024', title: 'Beitrag erhöht', detail: 'Von 8,00 € auf 10,00 € monatlich' },
            ],
            4: [
                { type: 'neumitglied', date: '07.12.2025', title: 'Mitglied geworden', detail: 'Beitrag: 10,00 € monatlich' },
                { type: 'storno', date: '09.12.2025', title: 'Storniert', detail: 'Grund: Widerruf' },
            ],
        };

        // Kontext-Daten (von URL-Parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const contextData = {
            type: urlParams.get('type') || 'all',
            id: urlParams.get('id') || null,
            name: urlParams.get('name') || 'Alle Datensätze'
        };

        // ========== SUPABASE CLIENT ==========
        const supabase = window.parent?.supabaseClient;

        // ========== SUPABASE DATA LOADING ==========
        async function loadRecordsFromSupabase() {
            if (!supabase) {
                console.warn('Supabase Client nicht verfügbar');
                return { records: [], bestand: [] };
            }

            try {
                // Records laden mit optionalem Filter
                let query = supabase
                    .from('records')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Filter basierend auf Kontext
                if (contextData.type === 'werber' && contextData.id) {
                    query = query.eq('werber_id', contextData.id);
                } else if (contextData.type === 'kampagne' && contextData.id) {
                    query = query.eq('campaign_id', contextData.id);
                } else if (contextData.type === 'gebiet' && contextData.id) {
                    query = query.eq('area_id', contextData.id);
                }

                const { data: records, error } = await query;

                if (error) throw error;

                // Records in das erwartete Format umwandeln
                const formattedRecords = (records || []).map(r => {
                    const d = r.data || {};
                    return {
                        id: r.id,
                        name: `${d.firstName || ''} ${d.lastName || ''}`.trim() || 'Unbekannt',
                        typ: (d.type || 'NMG').toLowerCase() === 'erh' ? 'erh' : 'nmg',
                        date: r.created_at ? new Date(r.created_at).toLocaleDateString('de-DE') : '',
                        je: `${(d.yearlyAmount || 0).toFixed(2).replace('.', ',')} €`,
                        kunde: d.kunde || '',
                        gebiet: d.area || '',
                        werber: d.werber || '',
                        teamchef: d.teamchef || '',
                        street: d.street || '',
                        houseNumber: d.houseNumber || '',
                        zipCode: d.zipCode || '',
                        city: d.city || '',
                        email: d.email || '',
                        phoneFixed: d.phoneFixed || '',
                        phoneMobile: d.phoneMobile || '',
                        status: r.status === 'success' ? 'aktiv' : 'storniert',
                        // Alle weiteren Felder für Detail-Ansicht
                        ...d
                    };
                });

                return { records: formattedRecords, bestand: [] };
            } catch (error) {
                console.error('Fehler beim Laden der Records:', error);
                return { records: [], bestand: [] };
            }
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // Tabs initialisieren
            initTabs('.kw-tab', '.kw-tab-content');

            // Zentrale Modals initialisieren
            ModalTemplates.init(['storno', 'columns', 'edit', 'import', 'export']);

            // Daten aus Supabase laden
            const { records: supabaseRecords, bestand: supabaseBestand } = await loadRecordsFromSupabase();

            // Datensätze-System initialisieren mit Supabase-Daten (Fallback auf Test-Daten wenn leer)
            const recordsToUse = supabaseRecords.length > 0 ? supabaseRecords : testRecordsData;
            const bestandToUse = supabaseBestand.length > 0 ? supabaseBestand : testBestandData;

            initDatensaetze({
                recordsData: recordsToUse,
                bestandData: bestandToUse,
                historyData: testHistoryData,
                contextData: contextData
            });

            // Tab-Badges aktualisieren
            document.getElementById('recordsBadge').textContent = recordsToUse.length;
            document.getElementById('bestandBadge').textContent = bestandToUse.length;

            // Kontext-Badge aktualisieren
            if (contextData.name && contextData.name !== 'Alle Datensätze') {
                document.getElementById('contextBadge').textContent = contextData.name;
            }

            // Register toolbar config with shell (Import/Export for data tables)
            registerToolbarConfig();
        });

        // Register toolbar buttons for data tables
        function registerToolbarConfig() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'registerToolbar',
                    config: {
                        actionButtons: [
                            { id: 'import', text: 'Import', icon: 'upload', action: 'openImportModal' },
                            { id: 'export', text: 'Export', icon: 'download', action: 'openExportModal', primary: true }
                        ]
                    }
                }, '*');
            }
        }

        // Listen for toolbar actions from shell
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'toolbarAction') {
                if (e.data.action === 'openImportModal' && typeof openImportModal === 'function') {
                    openImportModal();
                } else if (e.data.action === 'openExportModal' && typeof openExportModal === 'function') {
                    openExportModal();
                }
            }
        });
    </script>
</body>
</html>
